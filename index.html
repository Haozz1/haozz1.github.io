<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>Haoz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Haoz">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Haoz">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Haoz">
  
    <link rel="alternative" href="/atom.xml" title="Haoz" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/asset/4.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

</head>
</html>
<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/img/asset/myname.jpg" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">Haoz</a></h1>
		</hgroup>
		
		<p class="header-subtitle">按时吃饭</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">Home</a></li>
	        
				<li><a href="/tags/随笔/">Essay</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">all </a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)"> theirs </a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)"> me</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/haozz1" title="github"><i class="icon-github"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:shichenhao94@163.com" title="mail"><i class="icon-mail"></i></a>
		        
					<a class="twitter" target="_blank" href="https://twitter.com/BestHaoz" title="twitter"><i class="icon-twitter"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/img/asset/myname.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">Haoz</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>按时吃饭<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/haozz1" title="github"><i class="icon-github"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:shichenhao94@163.com" title="mail"><i class="icon-mail"></i></a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/BestHaoz" title="twitter"><i class="icon-twitter"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">Home</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">Essay</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-记" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/24/记/">记</a>
    </h1>
  

        
        <a href="/2022/05/24/记/" class="archive-article-date">
  	<time datetime="2022-05-24T09:37:35.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2022-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<blockquote>
<p><strong><strong>2022-05-24</strong></strong><br>&nbsp;<br>最近拍了很多照片,有下楼做核酸时看到的蓝天白云,有在路上散步时看到迎风摆动的树枝,有下雨时在路上着急回家的人,也有卧室窗口看到的印满整片天空的晚霞.<br>我喜欢时不时就打开手机相册翻一翻,看过去拍到的照片不光能想起当时发生的事情,也能重新感受到当时的心情,这和普鲁斯特效应出奇的相似.绝大多数都是开心和兴奋的回忆,不然好像也不会在相册里留下痕迹.<br>我发现相册里最多的风景是拍的天空,晴空或者晚霞.然后是海,都是些广阔而自由的东西,也许是告别自由太久了,被各种想法和目的困住了双腿双脚,现在能做的除了拿起手机拍下来连停下来多看几分钟都变得很奢侈.<br>上周末终于解封了,自从居家了一周又封控了一周之后就再没出门散步,在家的几天运动了也随着精神的发霉而停止.中午出门走了走,外边的空气用它的热情疯狂的拥抱我,好像是在提醒我时间已经过去了太久,连天气和温度都变得陌生.周围的小吃店还没开门营业,理发店门口堆着旁边菜市场搬出来的坏掉的菜叶,停车场里车子停放的奇奇怪怪的样子倒还和五一假期看到时的一样.树枝好像更长了需要弯着腰才能过了,树下坐满了乘凉的人在互相分享着这一个月以来的新鲜事,路上挤满了的行人要么在往超市方向走要么拎着刚买完的新鲜蔬菜慢悠悠的回家,这些画面在已经2022年的北京显得很陌生,生活好像因为疫情真的放慢了下来.<br>我不需要囤菜,来商场更多的是无聊,来看看有什么很久没吃的东西或者就是单纯想来看看热闹.还没到午饭时间超市已经没多少蔬菜和水果了,冷柜里的一桶三元牛奶显得格外的孤单,我只好把它放进了我凭借速度才抢到的购物车里.<br>出了商场又往南走了走,小河边的健身器材都重新被利用了起来,可能都在避免聚集,下棋的大爷们却都还没出现.要是来些风就好了,也不至于需要用反衬的阳光来确定河水依旧在流淌.<br>再往南的北二环主路少了点昔日的焦急,偶尔路过的公交车在告诉着我虽然疫情严重但一切都仍平稳有序.远处的写字楼好像比平时黯淡了一些,没有了人气的钢筋水泥在这炎炎夏日略显得冰冷.<br>到了家,原本微凉的牛奶已经晒得有些烫手,只好再重新放回冰箱冰一冰.重新出门再进屋也感受到了屋里的杂乱,需要打扫下卫生好好收拾一下了.</p>
</blockquote>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">随笔</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2022/05/24/记/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-clickhouse集群相关" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/09/clickhouse集群相关/">clickhouse集群相关</a>
    </h1>
  

        
        <a href="/2021/09/09/clickhouse集群相关/" class="archive-article-date">
  	<time datetime="2021-09-09T15:41:49.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-09-09</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-安装一个2节点2实例的集群"><a href="#1-安装一个2节点2实例的集群" class="headerlink" title="1. 安装一个2节点2实例的集群"></a>1. 安装一个2节点2实例的集群</h3><h3 id="2-2节点4实例的集群"><a href="#2-2节点4实例的集群" class="headerlink" title="2. 2节点4实例的集群"></a>2. 2节点4实例的集群</h3>
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">clickhouse</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/09/09/clickhouse集群相关/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-摘抄" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/02/摘抄/">文</a>
    </h1>
  

        
        <a href="/2021/05/02/摘抄/" class="archive-article-date">
  	<time datetime="2021-05-02T11:59:46.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-05-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong><strong>文字是个很奇妙的东西,它可能无法准确的描述你在某一刻的心情,但却能让你读到它的时候感受笔者融入在里面的到无穷的力量或者无尽的感情.</strong></strong></p>
        
          <a class="article-more-a" href="/2021/05/02/摘抄/#more">more >></a>
        
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">随笔</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/05/02/摘抄/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-天宫" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/02/天宫/">天宫</a>
    </h1>
  

        
        <a href="/2021/05/02/天宫/" class="archive-article-date">
  	<time datetime="2021-05-02T02:33:45.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-05-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><strong><em>“不知天上宫阙</em></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><strong><em>今夕是何年”</em></strong></p>
<img src="/2021/05/02/天宫/fashe.png">
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">随笔</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/05/02/天宫/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-JsavSpring框架下的Log" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/02/JsavSpring框架下的Log/">Spring框架下的Log</a>
    </h1>
  

        
        <a href="/2020/07/02/JsavSpring框架下的Log/" class="archive-article-date">
  	<time datetime="2020-07-02T06:17:55.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-07-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="关于Spring的log"><a href="#关于Spring的log" class="headerlink" title="关于Spring的log"></a>关于Spring的log</h1><p>Spring框架默认使用Logback用于日志。除了Spring自己框架使用了日志以外，我们在业务代码里也有使用log<br>的需求，因此时常需要获得一个log实例，获得一个log实例的方式很多，根据使用的不同的包，有很多种方<br>式，举例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CommonsLog</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.commons.logging.Log log =org.apache.commons.logging.LogFactory.getLog(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="meta">@Flogger</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.google.common.flogger.FluentLogger log =com.google.common.flogger.FluentLogger.forEnclosingClass();</span><br><span class="line"><span class="meta">@JBossLog</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.jboss.logging.Logger log =org.jboss.logging.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="meta">@Log</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.logging.Logger log =java.util.logging.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"><span class="meta">@Log</span>4j</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.log4j.Logger log =org.apache.log4j.Logger.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="meta">@Log</span>4j</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.logging.log4j.Logger log =org.apache.logging.log4j.LogManager.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger log =org.slf4j.LoggerFactory.getLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="meta">@XSlf</span>4j</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.ext.XLogger log =org.slf4j.ext.XLoggerFactory.getXLogger(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>这些不同的log提供的功能都大同小异，对我们来说，只是格式化有点差异而已。</p>
<p>值得一提的是，lombok这个插件为我们提供了直接生成log的便利，当我们在类上标注上面代码框中的注解<br>时，会自动为我们生成一个log实例供我们使用，不同的注解生成对应库的log，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CommonsLog</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//就相当于：</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogExample</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.commons.logging.Log log</span><br><span class="line">= org.apache.commons.logging.LogFactory.getLog(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般系统出了bug，我们极大依赖于日志，但我在log的使用过程中，发现有这么几个问题：</p>
<ol>
<li>log过少<br>即该打log的地方没有打log，导致完全不知道系统中发生了什么，只能根据异常去倒查，异常实际上丢<br>失了一些信息，比如调用参数信息等，debug很困难。</li>
<li>log过多<br>像我做的一些模块，之前没有经验，喜欢把参数信息和返回值都输出，有时候就会日志洪泛，像我们这<br>块儿，返回值有时候就是一些文章内容什么的，一下刷十几屏，淹没了有效信息。</li>
<li>log在平时看的时候过多，在debug时过少<br>这是上两个的结合体了，有时候debug需要的信息，日常没出错时不需要，但我们也没法断定说这什么<br>时候出错，什么时候不出错。所以有些地方的日志就变成了不出错时太多，出错时太少。</li>
<li>有些框架日志明显不需要，比如我们连接eureka的时候，每 5 分钟发一次心跳包，info级别日志，几天不<br>看，这个心跳包日志就完全刷屏了，看着就很烦，如下图：</li>
</ol>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2019-04-29 16:24:07.337 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br><span class="line">2019-04-29 16:29:07.337 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br><span class="line">2019-04-29 16:34:07.338 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br><span class="line">2019-04-29 16:39:07.339 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br><span class="line">2019-04-29 16:44:07.339 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br><span class="line">2019-04-29 16:49:07.340 INFO 1 --- [trap-executor-0]</span><br><span class="line">c.n.d.s.r.aws.ConfigClusterResolver : Resolving eureka endpoints</span><br><span class="line">via configuration</span><br></pre></td></tr></table></figure>
<h5 id="日志输出的过多或者不够，会造成出现问题就要改代码、重新打包上传、再部署、再运行，这样的一个步骤，"><a href="#日志输出的过多或者不够，会造成出现问题就要改代码、重新打包上传、再部署、再运行，这样的一个步骤，" class="headerlink" title="日志输出的过多或者不够，会造成出现问题就要改代码、重新打包上传、再部署、再运行，这样的一个步骤，"></a>日志输出的过多或者不够，会造成出现问题就要改代码、重新打包上传、再部署、再运行，这样的一个步骤，</h5><p>debug之后又要原路改回去。这样的事情我干过不少次。</p>
<p>所以引出了最近的几点思考，试简单总结如下：</p>
<p>日志分级</p>
<p>一般来讲，日志分为 5 级，trace、debug、info、warn、error，从下到上依次严重，我们在代码里对应的一般<br>就是log.trace(),log.debug()这样方法。</p>
<p>我们把debug需要的那部分信息通过log.debug()输出，正常日志通过info输出，这样就把不同级别的日志区<br>分开了，当我们需要debug时，代码不需要改动，只需要在参数中改变日志的level，就能看到debug日志，修<br>改完之后把debug日志关闭即可。这样就避免了频繁改变文件打包。</p>
<p>###<strong>Spring</strong> 的 <strong>log</strong> 日志级别设置</p>
<p>spring默认使用logback记录日志，日志级别通过logging.level.xxx参数设置。其中logging.level.是<br>通用前缀，xxx是具体包名。如：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.level.com.mycompany.tahiti.attachment.aop.ServiceLogger: debug</span><br></pre></td></tr></table></figure>
<p>是指com.mycompany.tahiti.attachment.aop.ServiceLogger这个包里生成的log使用debug级别。<br>而其他的log仍然使用默认的级别。如果要更改默认级别，可以使用以下命令修改：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.level.root=debug</span><br></pre></td></tr></table></figure>
<p>但在Spring中特别不建议这么做，因为我们Spring框架中也会同样输出debug日志，于是日志被各种debug信息<br>占满，完全没法看了。一般还是针对需要debug的那几个包设置debug级别就足够了。</p>
<p>这个参数可以直接加在application.yaml文件中，也可以加在application.apprities文件里，当我们<br>使用k8s时，还可以直接在k8s中增加args，如下图：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">template:</span><br><span class="line">spec:</span><br><span class="line">containers:</span><br><span class="line">args: ["--logging.level.root=info","--arg2=value2"]</span><br></pre></td></tr></table></figure>
<h2 id="所以我们上面提出的第四个问题也解决了，我们先找到框架中输出这个心跳包的类，然后直接将其日志级别设"><a href="#所以我们上面提出的第四个问题也解决了，我们先找到框架中输出这个心跳包的类，然后直接将其日志级别设" class="headerlink" title="所以我们上面提出的第四个问题也解决了，我们先找到框架中输出这个心跳包的类，然后直接将其日志级别设"></a>所以我们上面提出的第四个问题也解决了，我们先找到框架中输出这个心跳包的类，然后直接将其日志级别设</h2><p>置为warn。</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.level.com.netflix.discovery.shared.resolver.aws.ConfigClusterResolver: warn</span><br></pre></td></tr></table></figure>
<p>这样这个包的info信息就不生成了。</p>
<p>如果我们自己的log也想使用这个机制，建议使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@lombok</span>.extern.apachecommons.CommonsLog</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>或者直接手写一个log：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.commons.logging.Log log =org.apache.commons.logging.LogFactory.getLog(LogExample<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>其他的log包可能有的不能和spring的配置协作，未验证，因此最好不用。如果再观察一下配置文件的解析，发<br>现配置文件是由:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.logging.LoggingApplicationListener</span><br></pre></td></tr></table></figure>
<p>这个包来解析的。先是解析配置文件，建立了一个class的fullname到level的map，将这个map注册到<br>LogFactory中，我们上面的log是通过LogFactory静态方法取得的，这样就可以确保获得的log有正确的<br>level。这可以说是factory的经典应用了。</p>
<p><strong>log exception</strong></p>
<p>另外，当我们记录exception时，有时候会写这样的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    dosth();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">"sth bad happened"</span>);</span><br><span class="line">        e.printStack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样造成了一个隐含问题，e.printStack()是将数据输出到stdout中，当log的输出源也是stdout时，这<br>样没有问题，当log的输出源被改为文件后，这两个输出就不在一起了。因此，建议使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.error(<span class="string">"sth bad happened"</span>, e);</span><br></pre></td></tr></table></figure></p>
<h3 id="log-与-AOP"><a href="#log-与-AOP" class="headerlink" title="log 与 AOP"></a><strong>log</strong> 与 <strong>AOP</strong></h3><p>有时候，我们需要记录系统进行了哪些操作，比如想记录每一次对controller的调用，那么，我们要在每个方法<br>里加一个log.info(“xxx方法被调用”)，这样显然很麻烦，也影响代码的整洁美观。利用SpringAOP，我们<br>可以建立一个这样的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@CommonsLog</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLogger</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(*com.mycompany.tahiti.attachment.service.impl.AttachmentServiceImpl2.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"action()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">logRequest</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log.info(String.format(<span class="string">"--------%s方法被调用"</span>,</span><br><span class="line">        joinPoint.getSignature()));</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(String.format(<span class="string">"共收到%d个参数%s"</span>,</span><br><span class="line">            joinPoint.getArgs().length,</span><br><span class="line">            joinPoint.getArgs().length == <span class="number">0</span>? <span class="string">""</span> : <span class="string">"，以下是详细参数信息："</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i != joinPoint.getArgs().length; ++i) &#123;</span><br><span class="line">                Object arg = joinPoint.getArgs()[i];</span><br><span class="line">                <span class="keyword">if</span> (Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">arg</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">                    log.debug(String.format(<span class="string">"参数%d是容器类，共有%d个元素"</span>, i,((Collection) arg).size()));</span><br><span class="line">                    log.debug(String.format(<span class="string">" %s"</span>, ((Collection&lt;?&gt;)arg).stream().map(Object::toString).collect(Collectors.joining(<span class="string">","</span>))));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">arg</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">                    log.debug(String.format(<span class="string">"参数%d是Map类，共有%d个元素"</span>, i,((Map) arg).size()));</span><br><span class="line">                    StringBuilder sb = <span class="keyword">new</span> StringBuilder();((Map&lt;?, ?&gt;) arg).forEach((k, v) -&gt;sb.append(<span class="string">"key="</span>).append(k).append(<span class="string">"value="</span>).append(v).append(<span class="string">"; "</span>));</span><br><span class="line">                    log.debug(String.format(<span class="string">" %s"</span>, sb.toString()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(String.format(<span class="string">"参数%d为：%s"</span>, i,arg.toString()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Object retValue = joinPoint.proceed(joinPoint.getArgs());</span><br><span class="line">        log.info(String.format(<span class="string">"------%s方法返回"</span>,</span><br><span class="line">        joinPoint.getSignature()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">retValue</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">                log.debug(String.format(<span class="string">"返回值是容器类，共有%d个元素"</span>,((Collection) retValue).size()));</span><br><span class="line">                log.debug(String.format(<span class="string">" %s"</span>, ((Collection&lt;?&gt;)retValue).stream().map(Object::toString).collect(Collectors.joining(<span class="string">","</span>))));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">retValue</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">                log.debug(String.format(<span class="string">"返回值是Map类，共有%d个元素"</span>, ((Map)retValue).size()));</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();((Map&lt;?, ?&gt;) retValue).forEach((k, v) -&gt;sb.append(<span class="string">"key="</span>).append(k).append(<span class="string">"value="</span>).append(v).append(<span class="string">"; "</span>));</span><br><span class="line">                log.debug(String.format(<span class="string">" %s"</span>, sb.toString()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(String.format(<span class="string">"返回值为：%s"</span>,retValue.toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以保证每一个方法调用时都能够产生日志，不用每次手写日志。</p>
<h3 id="Log-与时区问题"><a href="#Log-与时区问题" class="headerlink" title="Log 与时区问题"></a><strong>Log</strong> 与时区问题</h3><p>我们经常发现我们的日志中的时间和北京时间相差八小时，大多数时候这一点我们自己看的时候在脑子里做个<br>时间转换就可以了，但这样还是容易让人疑惑和烦躁，因此我们需要某种方式来统一时间。</p>
<p>在linux中，当地时间由/etc/localtime确定的，而这个文件实际上是一个软链，链接<br>到/var/db/timezone/zoneinfo/Asia/Shanghai。因此，如果要改变linux的标准时间，只需要改变这个<br>软链接的指向即可。</p>
<p>我们现在主要用Docker进行部署，一般来讲，Python语言的项目打的包会有一个完整的linux环境，因为它依赖<br>的东西太多了，pip install甚至还要求docker镜像里有完整的开发环境，所以一个包经常有1.2G以上。但<br>java的docker就精简很多，甚至最常用的ls命令都没有打包到java:8这个基础镜像里，因此一个包经常只有<br>100M左右。我们分别以这两种语言的docker包为例，实例如何正确显示当地时间。</p>
<ol>
<li>Java<br>只需要在Dockerfile中添加一个环境变量，因为java的极简包里什么都没有，也不通过/etc/localtime<br>来确定时间。</li>
</ol>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk: 8 -alpine</span><br><span class="line">WORKDIR /app</span><br><span class="line">ENV TZ Asia/Shanghai # 就是这一句</span><br><span class="line">COPY target/ROOT.jar.</span><br><span class="line">ENTRYPOINT ["java", "-XX:+UnlockExperimentalVMOptions", "-</span><br><span class="line">XX:+UseCGroupMemoryLimitForHeap", "-jar", "ROOT.jar"]</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>python项目<br>在Dockerfile中直接更改/etc/localtime的软链。</li>
</ol>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM rappdw/docker-java-python:latest</span><br><span class="line">RUN mkdir -p ~/.pip</span><br><span class="line">RUN echo "[global]\n\</span><br><span class="line">trusted-host = mirrors.aliyun.com\n\</span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple" &gt; ~/.pip/pip.conf</span><br><span class="line">COPY requirements.txt ./</span><br><span class="line">RUN pip3 install --no-cache-dir -r requirements.txt</span><br><span class="line">COPY ./ ./</span><br><span class="line">RUN ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </span><br><span class="line"><span class="meta">#</span><span class="bash">主要是这一句</span></span><br><span class="line">RUN chmod a+x run.sh</span><br><span class="line">ENTRYPOINT ["/run.sh"]</span><br></pre></td></tr></table></figure>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Spring</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/07/02/JsavSpring框架下的Log/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Jsava序列化与Json" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/22/Jsava序列化与Json/">Java序列化与Json</a>
    </h1>
  

        
        <a href="/2020/05/22/Jsava序列化与Json/" class="archive-article-date">
  	<time datetime="2020-05-22T06:16:30.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-22</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="java序列化与Json的三个库"><a href="#java序列化与Json的三个库" class="headerlink" title="java序列化与Json的三个库"></a>java序列化与Json的三个库</h1><h3 id="如果一个运行时的数据需要被持久化，或者说需要通过网络进行通信，那么就涉及到对象的序列化问题。比如"><a href="#如果一个运行时的数据需要被持久化，或者说需要通过网络进行通信，那么就涉及到对象的序列化问题。比如" class="headerlink" title="如果一个运行时的数据需要被持久化，或者说需要通过网络进行通信，那么就涉及到对象的序列化问题。比如"></a>如果一个运行时的数据需要被持久化，或者说需要通过网络进行通信，那么就涉及到对象的序列化问题。比如</h3><p>说你在程序中写了一个sql，大概是这个样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT into student (student_id,`name`) values ( 121212 ,null)</span><br></pre></td></tr></table></figure>
<p>这个sql要传输到数据库，就必须进行序列化，比如说，null为什么会被识别为Null类型，而不是字符串”null”，<br>121212 为什么被识别为一个数字，而不是字符串。这就依赖于序列化和反序列化的约定。<br>序列化和反序列化在网络编程中更是无处不在。比如现在流行的前后端分离项目，后端接口向前端返回一个对<br>象，在spring boot框架下经常会写成这样代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/student&quot;)</span><br><span class="line">public class StudentController &#123;</span><br><span class="line">@GetMapping(&quot;/random&quot;)</span><br><span class="line">public Student random()&#123;</span><br><span class="line">return new Student( 121212 ,&quot;章银莱&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不做其他设置，前端将收到这样的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;studentId&quot;: 121212</span><br><span class="line">&quot;name&quot;: &quot;章银莱&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么就应该好奇，为什么返回了一个json，而不是xml，不是yaml。答案是springboot默认调用jackson，将我<br>们的类对象转换成了一个json字符串。</p>
<p><strong>java</strong> 对序列化的原生支持</p>
<p>以前，java提供了一个标记接口，java.io.Serializable，任何实现了这个接口的类，都可以使用java自己<br>的序列化机制，实际上，因为这个接口是个标记接口，在大多数情况下，你什么都不用做。如果一个类要完整<br>的序列化，那么他的包含的所有字段都必须实现该序列化接口，不然就会出现异常。<br>java通过一个序列化序号来识别一个对象，也就是我们经常在实现了java.io.Serializable接口的类里看<br>到这个字段的原因：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final long serialVersionUID = 1L;</span><br></pre></td></tr></table></figure>
<p>如果不提供的话，java会用某种默认生成机制生成。在反序列化时，如果序列化号对不上，反序列化会失败。<br>java的默认序列化策略有很多问题：</p>
<ol>
<li>序列化的声明过于繁琐。字段必须也实现该接口，否则序列化会失败；父类必须也实现该接口，否则父<br>类的部分不会被序列化。有时候父类我们是改变不了的，那就只能接受无法序列化的结果。</li>
<li>仅适用于java平台相关语言。其他语言没法直接反序列化，或许通过一些中间件可以支持，但是在有些<br>复杂。在前后端分离的大趋势下，这个限制已经令人无法忍受。</li>
<li>对修改不太友好。假如说我们没有指定序列化号，那么默认的序列号生成策略会考虑到类的现有字段，<br>假如说你对类的字段进行了修改，那序列化号会发生改变。导致反序列化失败。类的改名也有一样的负<br>面影响。<br>限制众多，显然我们需要更方便、通用性、兼容性更好的序列化方式。</li>
</ol>
<h2 id="json-or-xml"><a href="#json-or-xml" class="headerlink" title="json or xml"></a>json or xml</h2><h3 id="序列化并不是某一个具体的行为，而是一类行为的统称。我个人认为，序列化的最终目的和最终结果，是将丰"><a href="#序列化并不是某一个具体的行为，而是一类行为的统称。我个人认为，序列化的最终目的和最终结果，是将丰" class="headerlink" title="序列化并不是某一个具体的行为，而是一类行为的统称。我个人认为，序列化的最终目的和最终结果，是将丰"></a>序列化并不是某一个具体的行为，而是一类行为的统称。我个人认为，序列化的最终目的和最终结果，是将丰</h3><h3 id="富多样的数据转换成一串二进制流，毕竟无论是存储在硬盘中以序列化，还是通过网络接口通信，最后的物理"><a href="#富多样的数据转换成一串二进制流，毕竟无论是存储在硬盘中以序列化，还是通过网络接口通信，最后的物理" class="headerlink" title="富多样的数据转换成一串二进制流，毕竟无论是存储在硬盘中以序列化，还是通过网络接口通信，最后的物理"></a>富多样的数据转换成一串二进制流，毕竟无论是存储在硬盘中以序列化，还是通过网络接口通信，最后的物理</h3><h3 id="设备都只能识别和传输二进制。所以，一个靠谱的序列化方案，显然需要做到二进制层面的一致。那么就有了"><a href="#设备都只能识别和传输二进制。所以，一个靠谱的序列化方案，显然需要做到二进制层面的一致。那么就有了" class="headerlink" title="设备都只能识别和传输二进制。所以，一个靠谱的序列化方案，显然需要做到二进制层面的一致。那么就有了"></a>设备都只能识别和传输二进制。所以，一个靠谱的序列化方案，显然需要做到二进制层面的一致。那么就有了</h3><h3 id="两种序列化的风格，一种是直接序列化为二进制流，另一种是现将纷繁复杂的数据转化为字符串，再将字符串"><a href="#两种序列化的风格，一种是直接序列化为二进制流，另一种是现将纷繁复杂的数据转化为字符串，再将字符串" class="headerlink" title="两种序列化的风格，一种是直接序列化为二进制流，另一种是现将纷繁复杂的数据转化为字符串，再将字符串"></a>两种序列化的风格，一种是直接序列化为二进制流，另一种是现将纷繁复杂的数据转化为字符串，再将字符串</h3><h3 id="编码为二进制流。"><a href="#编码为二进制流。" class="headerlink" title="编码为二进制流。"></a>编码为二进制流。</h3><p>java.io.Serializable采用了第一种方案。但很多更流行的序列化方案都采取了第二种风格。比如最经常<br>使用的json和xml。xml确实有它的优势，但作为资源传递的媒介来说，一堆什么DTD，XSD的规范，可能绕几<br>个月也不一定绕清楚xml的所有规范，另外废话也太多，网络传输中会比json占用更多的宽带。<br>相比之下，json就更有优势。JavaScript原生支持，规范要求应当使用unicode，编码方式默认使用utf-8，字符<br>串必须用双引号，key只能是字符串，必须用双引号，等等。加上spring默认使用json作为REST的资源表述方<br>式，至少在java web开发领域，json几乎已经一统天下。<br>json相比java.io.Serializable有很多优势：</p>
<ol>
<li>独立于java语言，可以非常便利地支持多语言。</li>
<li>不怕类名、类字段修改。因为只要修改对不上，这个字段的值将被直接置为null，而多余的字段将会被直<br>接丢弃。至少不会引发异常——其实还可以通过可选字段名的扩展来实现字段名修改前后的兼容。</li>
<li>序列化支持非常广泛。因为是将字段直接映射为key:value这种格式，不需要其父类、包含的所有字段<br>实现什么特定接口。<br>所以，在目前的编程环境下，已经不太常见java.io.Serializable这种东西，最多的是看到json大行其<br>道。<br>扩展阅读：数据类型和Json格式，json的标准定义</li>
</ol>
<h2 id="look-into-json"><a href="#look-into-json" class="headerlink" title="look into json"></a>look into json</h2><p>一个 <strong>example</strong> 类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import lombok.AllArgsConstructor;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.NoArgsConstructor;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import java.time.LocalDateTime;</span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">public class Student &#123;</span><br><span class="line">private String id;</span><br><span class="line">private String name;</span><br><span class="line">private Gender gender;</span><br><span class="line">private ZonedDateTime birthday;</span><br><span class="line">private Integer age;</span><br><span class="line">private Teacher teacher;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">MALE,</span><br><span class="line">FEMALE,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用的三个 <strong>java</strong> 处理 <strong>json</strong> 库</p>
<p>google的Gson，alibaba的fastJson，还有springBoot默认的jackson。性能如何，这里就不测试了，对于非极端<br>环境下，作为这种非常优秀且使用广泛的库，基本也不需要我们担心这个问题。<br>引入的pom如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">&lt;project.reporting.outputEncoding&gt;UTF-</span><br><span class="line">8 &lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">&lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">&lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">&lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">&lt;jackson.version&gt;2.9.8&lt;/jackson.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.2.55&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;2.8.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.16.20&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<p>可见jackson需要引用的pom最多，这有时候也不太方便。三个库的基本用法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = new GsonBuilder().create();</span><br><span class="line">ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">//fastJson都是静态方法，所以不需要实例化一个解析器</span><br><span class="line">Student student = new Student(&quot;1&quot;, &quot;刘&quot;, Student.Gender.MALE,</span><br><span class="line">ZonedDateTime.now(ZoneId.of(&quot;Asia/Shanghai&quot;)), 18 , teacher);</span><br><span class="line">String fastJsonStr = JSON.toJSONString(student);</span><br><span class="line">String gsonStr = gson.toJson(student);</span><br><span class="line">String jacksonStr = mapper.writeValueAsString(student);</span><br><span class="line">Student student1 = JSON.parseObject(fastJsonStr, Student.class);</span><br><span class="line">Student student2 = gson.fromJson(gsonStr, Student.class);</span><br><span class="line">Student student3 = mapper.readValue(jacksonStr, Student.class);</span><br></pre></td></tr></table></figure>
<p>特殊类型会被怎么处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">日期会被怎么处理</span><br><span class="line">假如我们有一个LocalDateTime的类，默认策略下，三个库对其序列化的支持如下：</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Gson:&#123;&quot;date&quot;:&#123;&quot;year&quot;:2019,&quot;month&quot;:4,&quot;day&quot;:1&#125;,&quot;time&quot;:</span><br><span class="line">&#123;&quot;hour&quot;:16,&quot;minute&quot;:6,&quot;second&quot;:47,&quot;nano&quot;:247000000&#125;&#125;</span><br><span class="line">Jackson:</span><br><span class="line">&#123;&quot;year&quot;:2019,&quot;month&quot;:&quot;APRIL&quot;,&quot;dayOfMonth&quot;:1,&quot;dayOfWeek&quot;:&quot;MONDAY&quot;,&quot;dayOfYear&quot;</span><br><span class="line">:91,&quot;hour&quot;:16,&quot;minute&quot;:6,&quot;second&quot;:47,&quot;monthValue&quot;:4,&quot;nano&quot;:247000000,&quot;chrono</span><br><span class="line">logy&quot;:&#123;&quot;id&quot;:&quot;ISO&quot;,&quot;calendarType&quot;:&quot;iso8601&quot;&#125;&#125;</span><br><span class="line">FastJson:2019-04-01T16:06:</span><br><span class="line">如果我们有一个ZonedDateTime类，默认策略下，三个库对其序列化支持如下：</span><br><span class="line">Gson:&#123;&quot;dateTime&quot;:&#123;&quot;date&quot;:&#123;&quot;year&quot;:2019,&quot;month&quot;:4,&quot;day&quot;:2&#125;,&quot;time&quot;:</span><br><span class="line">&#123;&quot;hour&quot;:17,&quot;minute&quot;:25,&quot;second&quot;:25,&quot;nano&quot;:721000000&#125;&#125;,&quot;offset&quot;:</span><br><span class="line">&#123;&quot;totalSeconds&quot;:28800&#125;,&quot;zone&quot;:&#123;&quot;id&quot;:&quot;Asia/Shanghai&quot;&#125;&#125;</span><br><span class="line">JackSon: 请各位自行测试，长到令人崩溃，大概整整两页</span><br><span class="line">FastJson:2019-04-02T17:25:25.721+08:00[Asia/Shanghai]</span><br><span class="line">可以看到gson和jackson对于时间的记录比较完整，而fastJson就有数据的丢失，但绝绝大部分情况下，</span><br><span class="line">好像也不会有什么影响，而且fastJson看起来更舒服。</span><br><span class="line">然而，jackson在反序列化自己序列化的时间的时候，会出现错误，解决方法在下面。</span><br><span class="line">枚举怎么处理(默认场景)</span><br><span class="line">三个类十分统一，都将结果转化为：&quot;gender&quot;:&quot;MALE&quot;</span><br><span class="line">null字段怎么处理(默认场景)</span><br><span class="line">Gson和fastJson：直接忽略</span><br><span class="line">jackson：写入一个null字段。</span><br><span class="line">到底哪一种处理方式更好。显然是见仁见智的事情了。</span><br></pre></td></tr></table></figure>
<p>面对泛型</p>
<p>根据上面的扩展阅读，一个JSON文本是一个对象（即Map）或者数组（即Array）的序列化结果。因此，我们<br>在任何时候，都可以将一个json文本反序列化一个map或一个array(List, etc…)。比如下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String fastJsonStr = JSON.toJSONString(student,</span><br><span class="line">SerializerFeature.WriteMapNullValue);</span><br><span class="line">String gsonStr = gson.toJson(student);</span><br><span class="line">String jacksonStr = mapper.writeValueAsString(student);</span><br><span class="line">Object object1 = JSON.parseObject(fastJsonStr, Map.class);</span><br><span class="line">Object object2 = gson.fromJson(gsonStr, Map.class);</span><br><span class="line">Object object3 = mapper.readValue(jacksonStr, Map.class);</span><br></pre></td></tr></table></figure>
<h3 id="甚至在默认情况下，比如下面的代码："><a href="#甚至在默认情况下，比如下面的代码：" class="headerlink" title="甚至在默认情况下，比如下面的代码："></a>甚至在默认情况下，比如下面的代码：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object object2 = gson.fromJson(gsonStr, Object.class);</span><br><span class="line">Object object3 = mapper.readValue(jacksonStr, Object.class);</span><br></pre></td></tr></table></figure>
<p>这两个类都会直接将结果转化为一个map，如果要将其转为我们需要的类，则必须给他传入一个类型信息。<br>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Student student1 = JSON.parseObject(fastJsonStr, Student.class);</span><br><span class="line">Student student2 = gson.fromJson(gsonStr, Student.class);</span><br><span class="line">Student student3 = mapper.readValue(jacksonStr, Student.class);</span><br></pre></td></tr></table></figure>
<p>这样对简单对象是可以，但当面对泛型时，json往往无能为力，比如将List<student>序列化后，很可能是<br>这样：</student></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">&quot;id&quot;: &quot;1&quot;,</span><br><span class="line">&quot;aaaName&quot;: &quot;刘&quot;,</span><br><span class="line">&quot;gender&quot;: &quot;MALE&quot;,</span><br><span class="line">&quot;birthday&quot;: &quot;2019-04-03T07:23:07.623Z&quot;,</span><br><span class="line">&quot;age&quot;: 18,</span><br><span class="line">&quot;teacher&quot;: &#123;</span><br><span class="line">&quot;students&quot;: null</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;id&quot;: &quot;2&quot;,</span><br><span class="line">&quot;aaaName&quot;: &quot;马&quot;,</span><br><span class="line">&quot;gender&quot;: &quot;MALE&quot;,</span><br><span class="line">&quot;birthday&quot;: &quot;2019-04-03T07:23:07.623Z&quot;,</span><br><span class="line">&quot;age&quot;: 18,</span><br><span class="line">&quot;teacher&quot;: &#123;</span><br><span class="line">&quot;students&quot;: null</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;id&quot;: &quot;3&quot;,</span><br><span class="line">&quot;aaaName&quot;: &quot;张&quot;,</span><br><span class="line">&quot;gender&quot;: &quot;FEMALE&quot;,</span><br><span class="line">&quot;birthday&quot;: &quot;2019-04-03T07:23:07.623Z&quot;,</span><br><span class="line">&quot;age&quot;: 18,</span><br><span class="line">&quot;teacher&quot;: &#123;</span><br><span class="line">&quot;students&quot;: null</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>将其反序列化时，如果想使用gson.fromJson(gsonStr, List<student>.class)就会出现问题。编译<br>器会提示无法获得List<student>的类型，因为java的泛型是java5才加入的，为了兼容老代码，采取运行时<br>擦除类型信息的方式实现。所以List<string>在运行时和List<integer>是一种类型，这造成了一些有意<br>思(也令人困惑)的现象，其中之一就是：<br>泛型类并没有自己独有的Class类对象。比如并不存在List<string>.class或是<br>List<integer>.class，而只有List.class；<br>为解决这个问题，三个库都提供了自己的解决方案，主要是运行时获得Type。<br>Gson解决方案</integer></string></integer></string></student></student></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Type studentListType = new TypeToken&lt;List&lt;Student&gt;&gt;() &#123;</span><br><span class="line">&#125;.getType();</span><br><span class="line">List&lt;Student&gt; students2 = gson.fromJson(gson.toJson(students),</span><br><span class="line">studentListType);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FastJson解决方案</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.TypeReference</span><br><span class="line">List&lt;Student&gt; students2 =</span><br><span class="line">JSON.parseObject(JSON.toJSONString(students),</span><br><span class="line">new TypeReference&lt;List&lt;Student&gt;&gt;()</span><br><span class="line">&#123;&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jackson解决方案</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import com.fasterxml.jackson.core.type.TypeReference</span><br><span class="line">List&lt;Student&gt; students2 =</span><br><span class="line">mapper.readValue(mapper.writeValueAsString(students),</span><br><span class="line">new TypeReference&lt;List&lt;Student&gt;&gt;</span><br><span class="line">() &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>上述方法对于复杂泛型嵌套一样是可用的，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">@Data</span><br><span class="line">public class Result&lt;T&gt; &#123;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private String result = &quot;result&quot;;</span><br><span class="line">private HashMap&lt;String, List&lt;T&gt;&gt; data = new HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Student student = new Student(&quot;1&quot;, &quot;刘&quot;, Student.Gender.MALE,</span><br><span class="line">ZonedDateTime.now(ZoneId.of(&quot;Asia/Shanghai&quot;)), 18 , teacher);</span><br><span class="line">Student student22 = new Student(&quot;2&quot;, &quot;马&quot;, Student.Gender.MALE,</span><br><span class="line">ZonedDateTime.now(), 18 , teacher);</span><br><span class="line">Student student33 = new Student(&quot;3&quot;, &quot;张&quot;, Student.Gender.FEMALE,</span><br><span class="line">ZonedDateTime.now(), 18 , teacher);</span><br><span class="line">List&lt;Student&gt; students = Arrays.asList(student, student22, student33);</span><br><span class="line">Result&lt;Student&gt; studentResult = new Result&lt;&gt;();</span><br><span class="line">studentResult.getData().put(&quot;students&quot;, students);</span><br><span class="line">Result&lt;Student&gt; students1 = gson.fromJson(gson.toJson(studentResult), new</span><br><span class="line">TypeToken&lt;Result&lt;Student&gt;&gt;() &#123;</span><br><span class="line">&#125;.getType());</span><br><span class="line">Result&lt;Student&gt; students2 =</span><br><span class="line">JSON.parseObject(JSON.toJSONString(studentResult), new</span><br><span class="line">com.alibaba.fastjson.TypeReference&lt;Result&lt;Student&gt;&gt;() &#123;</span><br><span class="line">&#125;);</span><br><span class="line">Result&lt;Student&gt; students3 =</span><br><span class="line">mapper.readValue(mapper.writeValueAsString(studentResult), new</span><br><span class="line">com.fasterxml.jackson.core.type.TypeReference&lt;Result&lt;Student&gt;&gt;() &#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>扩展阅读：java泛型</p>
<p>自定义处理</p>
<p>字段名自定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@com.alibaba.fastjson.annotation.JSONField(name = &quot;aName&quot;)</span><br><span class="line">@com.fasterxml.jackson.annotation.JsonProperty(&quot;aaName&quot;)</span><br><span class="line">@com.google.gson.annotations.SerializedName(&quot;aaaName&quot;)</span><br><span class="line">private String name;</span><br></pre></td></tr></table></figure>
<p>分别对应了三个库的字段名自定义。</p>
<p>日期格式自定义</p>
<p>在讨论这个问题之前，需要注意的是，只有fastJson可以不做任何处理地支持java8新增的各种时间类(虽然处理<br>结果未必是你想要的)，其他两个库都需要对解析器做一定的处理。<br>其中jackson需要引入新的pom：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>同时代码做以下调整：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ObjectMapper mapper = new ObjectMapper()</span><br><span class="line">.registerModule(new JavaTimeModule())</span><br><span class="line">.setTimeZone(TimeZone.getTimeZone(ZoneId.of(&quot;Asia/Shanghai&quot;)));</span><br></pre></td></tr></table></figure>
<p>而Gson的更复杂一点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = new GsonBuilder().registerTypeAdapter(ZonedDateTime.class, new</span><br><span class="line">JsonSerializer&lt;ZonedDateTime&gt;() &#123;</span><br><span class="line">@Override</span><br><span class="line">public JsonElement serialize(ZonedDateTime src, Type typeOfSrc,</span><br><span class="line">JsonSerializationContext context) &#123;</span><br><span class="line">return new JsonPrimitive(src.toInstant().toString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;).registerTypeAdapter(ZonedDateTime.class, new</span><br><span class="line">JsonDeserializer&lt;ZonedDateTime&gt;() &#123;</span><br><span class="line">@Override</span><br><span class="line">public ZonedDateTime deserialize(JsonElement json, Type typeOfT,</span><br><span class="line">JsonDeserializationContext context) throws JsonParseException &#123;</span><br><span class="line">String datetime = json.getAsJsonPrimitive().getAsString();</span><br><span class="line">return Instant.parse(datetime).atZone(ZoneId.of(&quot;Asia/Shanghai&quot;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;).create();</span><br></pre></td></tr></table></figure>
<p>实际上是直接注册了自定义的类序列化工具，如何注册自定义的类序列化工具，这个在下面再详细分析。<br>更改过后，新的序列化结果是：<br>Gson:”2019-04-02T11:33:25.847Z”<br>Jackson:1554204805.<br>反序列化都能正常进行。<br>还可以通过注解简单定制序列化的行为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss.SSSZ&quot;, timezone =</span><br><span class="line">&quot;Asia/Shanghai&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@JSONField(format = &quot;yyyy-MM-dd HH:mm:ss.SSSZ&quot;)</span><br><span class="line">private ZonedDateTime birthday;</span><br></pre></td></tr></table></figure>
<p>其中Z是时区的意思，缺失的话反序列化就会出现问题，但即使如此，Fastjson在采用这种方式序列化之后，反<br>序列化时会仍然会丢失时区信息。<br>因为我们刚才的Gson实际上已经完成了完全的自定义序列化和反序列化，所以结果取决于自定义的行为是什<br>么。</p>
<p>不输出某个字段</p>
<p>FastJson： @JSONField(serialize = false)<br>Gson：直接在字段上加transient关键字，如private transient Gender gender;<br>但因为transient是java的关键字，也会影响java的java.io.Serializable接口，因此要慎用。更详细的情况<br>可参照Gson之排除字段的常见方式<br>jackson：@JsonIgnore</p>
<p><strong>null</strong> 值是否输出</p>
<p>Gson和FastJson默认不输出，因此使用下面的语句打开。<br>Gson:Gson gson = new GsonBuilder().serializeNulls().create()<br>FastJson:JSON.toJSONString(student, SerializerFeature.WriteMapNullValue);<br>Jackson默认输出，因此这样打开：<br>ObjectMapper mapper = new<br>ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</p>
<p>把多个字段映射为一个属性</p>
<p>比如我们从多个源接收数据，想将他们转为反序列化为同一个类，他们的主要字段相同，但字段名却不尽相<br>同。比如我们作为一家app公司，主要是免费加广告的方式发布app，现在有三家广告商，他们提供接口来获取<br>广告收入数据，大概格式都是从哪个时间到哪个时间，点击了多少次，收益多少这样的数据，但字段名不一<br>样，有些叫timeStart，有些叫beginTime，都是json现在传过来了，而我们想统一处理，这里举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;序号&quot;:1,&quot;名字&quot;:&quot;小刘&quot;,&quot;性别&quot;:&quot;Male&quot;,&quot;年龄&quot;:22,&quot;生日&quot;:&quot;2019-04-14&quot;&#125;</span><br><span class="line">&#123;&quot;age&quot;:22,&quot;birthday&quot;:&quot;2019-04-14&quot;,&quot;gender&quot;:&quot;Male&quot;,&quot;name&quot;:&quot;小</span><br><span class="line">刘&quot;,&quot;studentId&quot;:1&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">private Integer studentId = 1 ;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">private Gender gender = Gender.Male;</span><br><span class="line">private LocalDate birthday = LocalDate.now();</span><br><span class="line">private Integer age = 22 ;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">Male,</span><br><span class="line">Female</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>FastJson:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">@JSONField(alternateNames = &quot;序号&quot;)</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">@JSONField(alternateNames = &quot;姓名&quot;)</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">@JSONField(alternateNames = &quot;性别&quot;)</span><br><span class="line">private Gender gender = Gender.Male;</span><br><span class="line">@JSONField(alternateNames = &quot;年龄&quot;)</span><br><span class="line">private Integer age = 22 ;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">Male,</span><br><span class="line">Female</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>则以上两个字符串反序列化结果一致。<br><strong>Gson:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">@SerializedName(value = &quot;studentId&quot;, alternate = &quot;序号&quot;)</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">@SerializedName(value = &quot;name&quot;, alternate = &quot;姓名&quot;)</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">@SerializedName(value = &quot;gender&quot;, alternate = &quot;性别&quot;)</span><br><span class="line">private Gender gender = Gender.Male;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 因为Gson对Date的自定义格式化比较复杂，为演示去掉了这个字段</span><br><span class="line">// private LocalDate birthday = LocalDate.now();</span><br><span class="line">@SerializedName(value = &quot;age&quot;, alternate = &quot;年龄&quot;)</span><br><span class="line">private Integer age = 22 ;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">Male,</span><br><span class="line">Female</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>jackson</strong> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">//@JsonSerialize(using = StudentSerializer.class)</span><br><span class="line">//@JsonDeserialize(using = StudentDeserializer.class)</span><br><span class="line">public class Student &#123;</span><br><span class="line">@JsonAlias(&quot;序号&quot;)</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">@JsonAlias(&quot;姓名&quot;)</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">@JsonAlias(&quot;性别&quot;)</span><br><span class="line">private Gender gender = Gender.Male;</span><br><span class="line">@JsonAlias(&quot;年龄&quot;)</span><br><span class="line">private Integer age = 22 ;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">Male,</span><br><span class="line">Female</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完全自定义的序列化与反序列化</p>
<p>上面已经示例了Gson的自定义序列化与反序列化，即通过registerTypeAdapter方法来注册<br>JsonSerializer和JsonDeserializer。其实三个库都差不太多，都是手动实现序列化和反序列化，然后<br>通过某种方式注册到解析器里面去。<br><strong>FastJson</strong> ：</p>
<p>因为FastJson的序列化和反序列化都是静态方法，所以需要在需要序列化和反序列化的类上添加注解，或者在<br>每次序列化和反序列化时传入自定义配置。<br>首先，实现自定义序列化和反序列化类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class LocalDateSerializer implements ObjectSerializer &#123;</span><br><span class="line">public void write(JSONSerializer serializer, Object object,</span><br><span class="line">Object fieldName, Type fieldType, int features) &#123;</span><br><span class="line">SerializeWriter out = serializer.getWriter();</span><br><span class="line">if (object == null) &#123;</span><br><span class="line">serializer.getWriter().writeNull();</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">out.write(&quot;\&quot;活在当下\&quot;&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public class LocalDateDeserializer implements ObjectDeserializer &#123;</span><br><span class="line">//不管咋样，我都给你整成当前时间，反正是测试用</span><br><span class="line">public &lt;T&gt; T deserialze(DefaultJSONParser parser, Type type, Object</span><br><span class="line">fieldName) &#123;</span><br><span class="line">JSONLexer lexer = parser.getLexer();</span><br><span class="line">lexer.nextToken( 2 ); //随意设置一个int都可以，但不设置会出异常，不明原</span><br><span class="line">理</span><br><span class="line">return (T) LocalDate.now().plusDays( 1 );</span><br><span class="line">&#125;</span><br><span class="line">public int getFastMatchToken() &#123;</span><br><span class="line">//意义不明，打断点发现从来没被吊用过</span><br><span class="line">return 0 ;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">Student student = new Student();</span><br><span class="line">SerializeConfig config = new SerializeConfig();</span><br><span class="line">config.put(LocalDate.class, new LocalDateSerializer());</span><br><span class="line">String jsonStr = JSON.toJSONString(student, config);</span><br><span class="line">System.out.println(jsonStr);</span><br><span class="line">ParserConfig parserConfig = new ParserConfig();</span><br><span class="line">parserConfig.putDeserializer(LocalDate.class, new</span><br><span class="line">LocalDateDeserializer());</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Student student1 = JSON.parseObject(jsonStr, Student.class);</span><br><span class="line">System.out.println(student1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;age&quot;:22,&quot;birthday&quot;:&quot;活在当下&quot;,&quot;gender&quot;:&quot;Male&quot;,&quot;name&quot;:&quot;小刘&quot;,&quot;studentId&quot;:1&#125;</span><br><span class="line">Student(studentId=1, name=小刘, gender=Male, birthday=2019-04-15, age=22)</span><br></pre></td></tr></table></figure>
<p>如果需要全局注册，则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SerializeConfig.getGlobalInstance().put(LocalDate.class, new</span><br><span class="line">LocalDateSerializer());</span><br><span class="line">ParserConfig.getGlobalInstance().putDeserializer(LocalDate.class, new</span><br><span class="line">LocalDateDeserializer());</span><br></pre></td></tr></table></figure>
<p>如果想只针对特定的字段进行定制，则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">private Gender gender = Gender.Male;</span><br><span class="line">@JSONField(serializeUsing = LocalDateSerializer.class, deserializeUsing</span><br><span class="line">= LocalDateDeserializer.class)</span><br><span class="line">private LocalDate birthday = LocalDate.now();</span><br><span class="line">private Integer age = 22 ;</span><br><span class="line">public enum Gender &#123;</span><br><span class="line">Male,</span><br><span class="line">Female</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@JSONField</strong> 的设置项非常丰富，基本全部是关于自定义的东西，详细了解一下应该很有收获。<br>另外：FastJson还有一类被称为Filter的类，也可以对结果进行一定的自定义，但并非完全的自定义。大部分是<br>用来判断哪些字段序列化哪些字段不序列化，或者改变序列化后某个字段的名字、值这样的。有兴趣可以了解<br>一下。<br><strong>Jackson</strong> ：<br>套路都一样，首先是实现自己的序列化和反序列化类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class StudentSerializer extends JsonSerializer&lt;Student&gt; &#123;</span><br><span class="line">@Override</span><br><span class="line">public void serialize(Student value, JsonGenerator jsonGenerator,</span><br><span class="line">SerializerProvider provider)</span><br><span class="line">throws IOException &#123;</span><br><span class="line">jsonGenerator.writeStartObject();</span><br><span class="line">jsonGenerator.writeNumberField(&quot;序号&quot;, value.getStudentId());</span><br><span class="line">jsonGenerator.writeStringField(&quot;名字&quot;, value.getName());</span><br><span class="line">jsonGenerator.writeStringField(&quot;性别&quot;,</span><br><span class="line">value.getGender().toString());</span><br><span class="line">jsonGenerator.writeStringField(&quot;年龄&quot;, value.getAge() + &quot;years-</span><br><span class="line">old&quot;);</span><br><span class="line">jsonGenerator.writeStringField(&quot;生日&quot;,</span><br><span class="line">value.getBirthday().toString());</span><br><span class="line">jsonGenerator.writeEndObject();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class StudentDeserializer extends JsonDeserializer&lt;Student&gt; &#123;</span><br><span class="line">@Override</span><br><span class="line">public Student deserialize(JsonParser jp, DeserializationContext ctxt)</span><br><span class="line">&#123;</span><br><span class="line">return new Student();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Student student = new Student();</span><br><span class="line">SimpleModule module = new SimpleModule();</span><br><span class="line">module.addSerializer(Student.class, new StudentSerializer());</span><br><span class="line">module.addDeserializer(Student.class, new StudentDeserializer());</span><br><span class="line">ObjectMapper mapper = new ObjectMapper().registerModule(module);</span><br><span class="line">String jsonStr = mapper.writeValueAsString(student);</span><br><span class="line">System.out.println(jsonStr);</span><br><span class="line">Student student2 = mapper.readValue(jsonStr, Student.class);</span><br><span class="line">System.out.println(student2);</span><br></pre></td></tr></table></figure>
<p>可以看到主要是注册module来实现自定义，更简单的办法是直接在类上添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@JsonSerialize(using = StudentSerializer.class)</span><br><span class="line">@JsonDeserialize(using = StudentDeserializer.class)</span><br><span class="line">public class Student &#123;</span><br></pre></td></tr></table></figure>
<h3 id="…"><a href="#…" class="headerlink" title="…"></a>…</h3><h3 id><a href="#" class="headerlink" title="}"></a>}</h3><h3 id="这两个注解同时可用于字段级别。"><a href="#这两个注解同时可用于字段级别。" class="headerlink" title="这两个注解同时可用于字段级别。"></a>这两个注解同时可用于字段级别。</h3><p>再看 <strong>Gson</strong> ：<br>可以看到，另外两个库都有通过注解自定义的方法，gson也有@JsonAdapter()注解，但gson用这个注解同<br>时来序列化与反序列化的自定义工作，鉴于一个类或者字段不可能标注两个同样的注解，因此Gson的序列化和<br>反序列化是写在同一个类里面的，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class StudentTypeAdapter extends TypeAdapter&lt;Student&gt; &#123;</span><br><span class="line">public void write(JsonWriter out, Student value) throws IOException &#123;</span><br><span class="line">out.beginObject();</span><br><span class="line">out.name(&quot;序号&quot;);</span><br><span class="line">out.value(value.getStudentId());</span><br><span class="line">out.name(&quot;姓名&quot;);</span><br><span class="line">out.value(value.getName());</span><br><span class="line">out.endObject();</span><br><span class="line">&#125;</span><br><span class="line">public Student read(JsonReader in) throws IOException &#123;</span><br><span class="line">Student student = new Student();</span><br><span class="line">student.setGender(Student.Gender.Female);</span><br><span class="line">in.beginObject();</span><br><span class="line">String fieldname = null;</span><br><span class="line">while (in.hasNext()) &#123;</span><br><span class="line">JsonToken token = in.peek();</span><br><span class="line">if (token.equals(JsonToken.NAME)) &#123;</span><br><span class="line">//get the current token</span><br><span class="line">fieldname = in.nextName();</span><br><span class="line">&#125;</span><br><span class="line">if (&quot;序号&quot;.equals(fieldname)) &#123;</span><br><span class="line">student.setStudentId(in.nextInt());</span><br><span class="line">&#125; else if (&quot;姓名&quot;.equals(fieldname)) &#123;</span><br><span class="line">student.setName(in.nextString());</span><br><span class="line">&#125; else in.skipValue();</span><br><span class="line">&#125;</span><br><span class="line">in.endObject();</span><br><span class="line">return student;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后用@JsonAdapter(StudentTypeAdapter.class)注解即可。</p>
<p>面对循环引用</p>
<p>设想这样的实体类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">private Teacher teacher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Teacher &#123;</span><br><span class="line">private Integer teacherId = 2 ;</span><br><span class="line">private String name = &quot;老王&quot;;</span><br><span class="line">private Student student;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个简化版的一对一家教的数据库表。常见于@OneToOne的场景下。<br>之后会有这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Student student = new Student();</span><br><span class="line">Teacher teacher = new Teacher();</span><br><span class="line">student.setTeacher(teacher);</span><br><span class="line">teacher.setStudent(student);</span><br></pre></td></tr></table></figure>
<p>那么序列化时会发生什么问题？我们测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">Gson gson = new GsonBuilder().create();</span><br><span class="line">System.out.println(JSON.toJSONString(teacher));</span><br><span class="line">System.out.println(gson.toJson(teacher));</span><br><span class="line">System.out.println(mapper.writeValueAsString(teacher));</span><br></pre></td></tr></table></figure>
<p>FastJson的输出是：{“student”:{“name”:”小刘”,”studentId”:1,”teacher”:{“$ref”:”..”}}}<br>Gson和Jackson爆栈异常，其实我个人觉得爆栈异常更合理，这种互相持有引用的情况应该特殊处理，<br>fastJson替我们处理了有好有坏，比如其他语言可能无法反序列化这样它的序列化结果，因而引发异常。所以官<br>方也提供手动关闭的功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//全局关闭</span><br><span class="line">JSON.DEFAULT_GENERATE_FEATURE |=</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SerializerFeature.DisableCircularReferenceDetect.getMask();</span><br><span class="line">//单次关闭</span><br><span class="line">JSON.toJSONString(obj, SerializerFeature.DisableCircularReferenceDetect);</span><br></pre></td></tr></table></figure>
<p>那么假设我们真的要处理这样的情况，该如何是好呢？<br>一种方式是在某个类的对另一个类的引用上忽略另一个类，即不输出这个字段。这样断开循环引用。另外的方<br>式就是通过某种方式来指明引用方式：<br>jackson下最全的：Jackson – Bidirectional Relationships，其中和FastJson表现形式最接近的是<br>@JsonIdentityInfo方法。要注意的是@JsonIdentityInfo必须提供的参数是generator，其实是指定<br>了ID的生成策略，之后通过ID解除相互引用的问题。随便选择一个可用的即可，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Teacher &#123;</span><br><span class="line">private Integer teacherId = 2 ;</span><br><span class="line">private String name = &quot;老王&quot;;</span><br><span class="line">@JsonIdentityInfo(generator =</span><br><span class="line">ObjectIdGenerators.StringIdGenerator.class)</span><br><span class="line">private Student student;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Student &#123;</span><br><span class="line">private Integer studentId = 1 ;</span><br><span class="line">private String name = &quot;小刘&quot;;</span><br><span class="line">@JsonIdentityInfo(generator =</span><br><span class="line">ObjectIdGenerators.StringIdGenerator.class)</span><br><span class="line">private Teacher teacher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Gson没有查到类似策略，似乎只能通过忽略字段来断开无限循环。<br>当然了，以上问题都可以通过完全自定义的序列化与反序列化完成工作</p>
<h2 id="三个库与Spring框架整合"><a href="#三个库与Spring框架整合" class="headerlink" title="三个库与Spring框架整合"></a>三个库与Spring框架整合</h2><p>目前Spring框架默认使用Jackson来序列化和反序列化json，如果细致一点观察Spring框架，会发现Spring框架<br>正是使用HttpMessageConverter来实现HTTP信息处理的，其他两个Gson库也提供了和Spring框架整合的能<br>力，得益于Spring框架本身的松耦合，替换HttpMessageConverter是轻而易举的：<br>FastJson：官方文档：集成Spring框架<br>Gson: Configure gson in spring using GsonHttpMessageConverter</p>
<p>如果已经决定替换掉jackson，那还应该在pom文件中去除jackson的引用，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">&lt;exclusions&gt;</span><br><span class="line">&lt;exclusion&gt;</span><br><span class="line">&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">&lt;/exclusion&gt;</span><br><span class="line">&lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="我该如何选择呢？"><a href="#我该如何选择呢？" class="headerlink" title="我该如何选择呢？"></a>我该如何选择呢？</h2><p>整体上讲，三个框架各有特点吧。jackson能被spring官方选中自然有他的道理，对标准的严格执行，强大的可<br>扩展性、稳定性，速度也很快，缺点是接口不那么易用，要引的包也着实有点多。Gson是谷歌的产品，我们单<br>位用的比较多，但被fastJson公然嘲讽速度慢：<br>Gson应该叫龟速Json。<br>fastJson速度快，接口简单，但批评者认为，使用Json本身就不是看中他的速度，而是他的兼容性和灵活性，<br>fastJson硬编码的东西多，灵活性不够，等等。见知乎讨论：fastjson这么快老外为啥还是热衷 jackson，但是它<br>确实很简单易用，速度也挺快。<br>从功能上来讲，三者可以说都是完备的。如果是我选择，想偷懒应该会用FastJson，想安全稳定面对特别复杂<br>的需求，应该还是用jackson。Gson……不知道为什么就是不太喜欢它……</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/22/Jsava序列化与Json/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-HttpClient的几个参数" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/09/HttpClient的几个参数/">HttpClient的几个参数</a>
    </h1>
  

        
        <a href="/2020/05/09/HttpClient的几个参数/" class="archive-article-date">
  	<time datetime="2020-05-09T06:05:35.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-09</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Apache-HttpClient的几个重要参数"><a href="#Apache-HttpClient的几个重要参数" class="headerlink" title="Apache HttpClient的几个重要参数"></a>Apache HttpClient的几个重要参数</h1><p>最近在业务中发现一些性能问题，主要是和HttpClient有关的，刚好在这里总结一下。</p>
<p>针对版本号如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="maxConnPerRoute-与-maxConnTotal"><a href="#maxConnPerRoute-与-maxConnTotal" class="headerlink" title="maxConnPerRoute 与 maxConnTotal"></a>maxConnPerRoute 与 maxConnTotal</h2><p>正如大家所知，HttpClient与目的主机进行HTTP通信，必须要进行TCP连接。而因为三次握手、四次挥手、滑动窗口机制，连接的建立和释放是颇为耗时的一件事情，因此，HttpClient实现了连接池。以便在请求同一个<code>host:port</code>时，会复用已经建立的连接。</p>
<p>那么显然，这个复用的连接针对同一个<code>host:port</code>才有意义，这就是<code>maxConnPerRoute</code>的含义，即允许同一个<code>host:port</code>最多有几个活跃连接。当设置为2时，意味着同时最多有两个到<code>host:port</code>的连接，如果有空闲连接，本次请求会使用已经建立的空闲连接，但如果没有，就会进入等待队列，等待到该<code>host:port</code>的连接可用。</p>
<p>而maxConnTotal更直接了，意思就是总共允许HttpClient建立多少个连接，超出以后所有的连接都会进入等待队列。</p>
<p>在<code>CloseableHttpClient</code>的实现类<code>InternalHttpClient</code>中，连接的管理是依靠<code>HttpClientConnectionManager</code>的实现类，默认为<code>PoolingHttpClientConnectionManager</code>。</p>
<p>具体的代码，从<code>httpclient.execute(...)</code>可以追溯到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> CloseableHttpResponse <span class="title">doExecute</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> HttpHost target,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> HttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> HttpContext context)</span> <span class="keyword">throws</span> IOException, ClientProtocolException</span>&#123;</span><br><span class="line">  <span class="comment">// 上半部分省略，try catch省略  </span></span><br><span class="line">  <span class="keyword">final</span> HttpRoute route = determineRoute(target, wrapper, localcontext);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.execChain.execute(route, wrapper, localcontext, execAware);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续追寻<code>execChain.execute(...)</code>，最终会进入<code>MainClientExec#exec(...)</code>中，有关建立连接的语句如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ConnectionRequest connRequest = connManager.requestConnection(route, userToken);</span><br><span class="line"><span class="keyword">final</span> HttpClientConnection managedConn = connRequest.get(timeout &gt; <span class="number">0</span> ? timeout : <span class="number">0</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>
<p>而这个<code>ConnectionRequest</code>，则是定义于<code>PoolingHttpClientConnectionManager</code>中的一个匿名类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionRequest <span class="title">requestConnection</span><span class="params">(<span class="keyword">final</span> HttpRoute route,<span class="keyword">final</span> Object state)</span> </span>&#123;</span><br><span class="line">    Args.notNull(route, <span class="string">"HTTP route"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.log.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.log.debug(<span class="string">"Connection request: "</span> + format(route, state) + formatStats(route));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Future&lt;CPoolEntry&gt; future = <span class="keyword">this</span>.pool.lease(route, state, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConnectionRequest() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> future.cancel(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpClientConnection <span class="title">get</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> <span class="keyword">long</span> timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> TimeUnit tunit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, ConnectionPoolTimeoutException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> leaseConnection(future, timeout, tunit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，他的get方法重载了，实际上调用了<code>leaseConnection</code>方法，那这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HttpClientConnection <span class="title">leaseConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Future&lt;CPoolEntry&gt; future,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">long</span> timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> TimeUnit tunit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, ConnectionPoolTimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> CPoolEntry entry;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        entry = future.get(timeout, tunit);</span><br><span class="line">        <span class="comment">// 以下省略</span></span><br><span class="line">        <span class="keyword">return</span> CPoolProxy.newProxy(entry);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> TimeoutException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectionPoolTimeoutException(<span class="string">"Timeout waiting for connection from pool"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个proxy可以先不去理会，可见最重要的还是这个future。那这个future是什么呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Future&lt;CPoolEntry&gt; future = <span class="keyword">this</span>.pool.lease(route, state, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>进到lease方法里，会发现他是直接构造了一个Future实例，那我们关注他的<code>get()</code>方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// 这里的E实际类型就是CPoolEntry</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> timeout, <span class="keyword">final</span> TimeUnit tunit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> E entry = entryRef.get();</span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> entry;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;	<span class="comment">// 无限循环是为了一直尝试获取</span></span><br><span class="line">                <span class="keyword">final</span> E leasedEntry = getPoolEntryBlocking(route, state, timeout, tunit, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">if</span> (validateAfterInactivity &gt; <span class="number">0</span>)  &#123;</span><br><span class="line">               			<span class="comment">// 检测一下是不是超时了，超时了就重来一次 </span></span><br><span class="line">                    <span class="keyword">if</span> (leasedEntry.getUpdated() + validateAfterInactivity &lt;= System.currentTimeMillis()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!validate(leasedEntry)) &#123;</span><br><span class="line">                            leasedEntry.close();</span><br><span class="line">                            release(leasedEntry, <span class="keyword">false</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> leasedEntry;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</span><br><span class="line">            <span class="comment">// 省略</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以真正的获取的方法是<code>getPoolEntryBlocking(...)</code>，追踪之：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">getPoolEntryBlocking</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> T route, <span class="keyword">final</span> Object state,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">long</span> timeout, <span class="keyword">final</span> TimeUnit tunit,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Future&lt;E&gt; future)</span> <span class="keyword">throws</span> IOException, InterruptedException, TimeoutException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Date deadline = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      	<span class="comment">// 指获得连接要等待多久，这个timeout就是ConnectionTimeout。</span></span><br><span class="line">      	<span class="comment">// 要追溯这个timeout是ConnectionTimeToLive</span></span><br><span class="line">        deadline = <span class="keyword">new</span> Date (System.currentTimeMillis() + tunit.toMillis(timeout));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 获得一个特定路由的连接池，细节实际就是从可用队列里获得一个连接</span></span><br><span class="line">        <span class="keyword">final</span> RouteSpecificPool&lt;T, C, E&gt; pool = getPool(route);</span><br><span class="line">        E entry;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Asserts.check(!<span class="keyword">this</span>.isShutDown, <span class="string">"Connection pool shut down"</span>);</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">              	<span class="comment">// 尝试从其中获得可用的连接，这个操作在第一次执行时一定返回null</span></span><br><span class="line">                entry = pool.getFree(state);</span><br><span class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              	<span class="comment">// 如果超时了，关闭这个入口。因为不可能无限保持TCP连接，至少这是个不好的操作</span></span><br><span class="line">              	<span class="comment">// 所以超时了以后就关闭连接比较合理。这里的超时是指ConnectionTimeToLive</span></span><br><span class="line">                <span class="keyword">if</span> (entry.isExpired(System.currentTimeMillis())) &#123;</span><br><span class="line">                    entry.close();</span><br><span class="line">                &#125;</span><br><span class="line">              	<span class="comment">// 如果已经被关闭，那就从可用队列里移除。</span></span><br><span class="line">                <span class="keyword">if</span> (entry.isClosed()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.available.remove(entry);</span><br><span class="line">                    pool.free(entry, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// 这里一连串的if还是很严谨的</span></span><br><span class="line">            <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">              	<span class="comment">// 被使用了，当然要移出可用队列</span></span><br><span class="line">                <span class="keyword">this</span>.available.remove(entry);</span><br><span class="line">              	<span class="comment">// 加入已分配队列</span></span><br><span class="line">                <span class="keyword">this</span>.leased.add(entry);</span><br><span class="line">                onReuse(entry);</span><br><span class="line">                <span class="keyword">return</span> entry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// New connection is needed。</span></span><br><span class="line">          	<span class="comment">// 因为第一次的时候free一定是空的，所以会新建。</span></span><br><span class="line">          	<span class="comment">// 根据默认设置，这里会得到2，一会会详细看一下这个方法</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxPerRoute = getMax(route);</span><br><span class="line">            <span class="comment">// Shrink the pool prior to allocating a new connection</span></span><br><span class="line">          	<span class="comment">// 超出了最大允许的连接数，即maxPerRoute，就回收一下</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> excess = Math.max(<span class="number">0</span>, pool.getAllocatedCount() + <span class="number">1</span> - maxPerRoute);</span><br><span class="line">            <span class="keyword">if</span> (excess &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; excess; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> E lastUsed = pool.getLastUsed();</span><br><span class="line">                    <span class="keyword">if</span> (lastUsed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastUsed.close();</span><br><span class="line">                    <span class="keyword">this</span>.available.remove(lastUsed);</span><br><span class="line">                    pool.remove(lastUsed);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">						<span class="comment">// 如果这个route的已分配连接没有超过允许的最大连接，就分配。</span></span><br><span class="line">            <span class="keyword">if</span> (pool.getAllocatedCount() &lt; maxPerRoute) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> totalUsed = <span class="keyword">this</span>.leased.size();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> freeCapacity = Math.max(<span class="keyword">this</span>.maxTotal - totalUsed, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (freeCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> totalAvailable = <span class="keyword">this</span>.available.size();</span><br><span class="line">                    <span class="keyword">if</span> (totalAvailable &gt; freeCapacity - <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">this</span>.available.isEmpty()) &#123;</span><br><span class="line">                            <span class="keyword">final</span> E lastUsed = <span class="keyword">this</span>.available.removeLast();</span><br><span class="line">                            lastUsed.close();</span><br><span class="line">                            <span class="keyword">final</span> RouteSpecificPool&lt;T, C, E&gt; otherpool = getPool(lastUsed.getRoute());</span><br><span class="line">                            otherpool.remove(lastUsed);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  	<span class="comment">// 真正新建一个connection，在这一步，为entry设置了超时时间。</span></span><br><span class="line">                  	<span class="comment">// 这个超时时间在上面一个代码块中会用</span></span><br><span class="line">                    <span class="keyword">final</span> C conn = <span class="keyword">this</span>.connFactory.create(route);</span><br><span class="line">                    entry = pool.add(conn);</span><br><span class="line">                    <span class="keyword">this</span>.leased.add(entry);</span><br><span class="line">                    <span class="keyword">return</span> entry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (future.isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(<span class="string">"Operation interrupted"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">              	<span class="comment">// 否则就将这个申请的请求加到等待队列里</span></span><br><span class="line">                pool.queue(future);</span><br><span class="line">                <span class="keyword">this</span>.pending.add(future);</span><br><span class="line">                <span class="keyword">if</span> (deadline != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    success = <span class="keyword">this</span>.condition.awaitUntil(deadline);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.condition.await();</span><br><span class="line">                    success = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (future.isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(<span class="string">"Operation interrupted"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// In case of 'success', we were woken up by the</span></span><br><span class="line">                <span class="comment">// connection pool and should now have a connection</span></span><br><span class="line">                <span class="comment">// waiting for us, or else we're shutting down.</span></span><br><span class="line">                <span class="comment">// Just continue in the loop, both cases are checked.</span></span><br><span class="line">              	<span class="comment">// 所以接下来就重试了，注意最上面那个for (;;)无限循环</span></span><br><span class="line">                pool.unqueue(future);</span><br><span class="line">                <span class="keyword">this</span>.pending.remove(future);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// check for spurious wakeup vs. timeout</span></span><br><span class="line">            <span class="keyword">if</span> (!success &amp;&amp; (deadline != <span class="keyword">null</span> &amp;&amp; deadline.getTime() &lt;= System.currentTimeMillis())) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">"Timeout waiting for connection"</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再来稍微看一下这个<code>final int maxPerRoute = getMax(route);</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMax</span><span class="params">(<span class="keyword">final</span> T route)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Integer v = <span class="keyword">this</span>.maxPerRoute.get(route);</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> v.intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.defaultMaxPerRoute;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见，先是从一个map里面查一下数据，如果没有的话就使用<code>defaultMaxPerRoute</code>。这两个值都可以由我们自行设置。</p>
<p>自此，我们理清楚了一个connection是怎么获得的。然后再来看这两个参数怎么设置。当一个请求到来之后，先会去解析他的<code>host:port</code>，之后尝试根据这个<code>host:port</code>去尝试获取连接，如果当前到<code>host:port</code>的连接数量少于<code>maxConnPerRoute</code>，并且该<code>HttpClient</code>中发出的所有连接数量小于<code>maxConnTotal</code>，那么连接可以分配，如果两个条件有一个不满足，请求就会进入等待队列。不断轮询。关于这两个值的大小设置，我们来看一下官方的解读：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> ClientConnectionPoolManager&#125; maintains a pool of</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> HttpClientConnection&#125;s and is able to service connection requests</span></span><br><span class="line"><span class="comment"> * from multiple execution threads. Connections are pooled on a per route</span></span><br><span class="line"><span class="comment"> * basis. A request for a route which already the manager has persistent</span></span><br><span class="line"><span class="comment"> * connections for available in the pool will be services by leasing</span></span><br><span class="line"><span class="comment"> * a connection from the pool rather than creating a brand new connection.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> ClientConnectionPoolManager&#125; maintains a maximum limit of connection</span></span><br><span class="line"><span class="comment"> * on a per route basis and in total. Per default this implementation will</span></span><br><span class="line"><span class="comment"> * create no more than than 2 concurrent connections per given route</span></span><br><span class="line"><span class="comment"> * and no more 20 connections in total. For many real-world applications</span></span><br><span class="line"><span class="comment"> * these limits may prove too constraining, especially if they use HTTP</span></span><br><span class="line"><span class="comment"> * as a transport protocol for their services. Connection limits, however,</span></span><br><span class="line"><span class="comment"> * can be adjusted using &#123;<span class="doctag">@link</span> ConnPoolControl&#125; methods.</span></span><br><span class="line"><span class="comment"> * 上面这一段划重点，意思是默认值对于生产环境可能太小了，特别是当我们把HTTP当RPC用的时候</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Total time to live (TTL) set at construction time defines maximum life span</span></span><br><span class="line"><span class="comment"> * of persistent connections regardless of their expiration setting. No persistent</span></span><br><span class="line"><span class="comment"> * connection will be re-used past its TTL value.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The handling of stale connections was changed in version 4.4.</span></span><br><span class="line"><span class="comment"> * Previously, the code would check every connection by default before re-using it.</span></span><br><span class="line"><span class="comment"> * The code now only checks the connection if the elapsed time since</span></span><br><span class="line"><span class="comment"> * the last use of the connection exceeds the timeout that has been set.</span></span><br><span class="line"><span class="comment"> * The default timeout is set to 2000ms</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Contract</span>(threading = ThreadingBehavior.SAFE_CONDITIONAL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolingHttpClientConnectionManager</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">HttpClientConnectionManager</span>, <span class="title">ConnPoolControl</span>&lt;<span class="title">HttpRoute</span>&gt;, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然太小了，那就有调整的必要，调整主要有两种办法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient httpClient = HttpClientBuilder.create()</span><br><span class="line">            .setMaxConnTotal(<span class="number">400</span>).setMaxConnPerRoute(<span class="number">200</span>).build();</span><br></pre></td></tr></table></figure>
<p>不解释了。还有一种更详细的设置方式，就是既然connection的管理是依靠<code>PoolingHttpClientConnectionManager</code>，那我们给httpClient设置一个<code>PoolingHttpClientConnectionManager</code>，就可以完全掌握连接分配了，而<code>PoolingHttpClientConnectionManager</code>的设置项要更多一些。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PoolingHttpClientConnectionManager manager = <span class="keyword">new</span> PoolingHttpClientConnectionManager();</span><br><span class="line">manager.setDefaultMaxPerRoute(<span class="number">100</span>);</span><br><span class="line">manager.setMaxTotal(<span class="number">500</span>);</span><br><span class="line">manager.setMaxPerRoute(<span class="keyword">new</span> HttpRoute(</span><br><span class="line">  <span class="keyword">new</span> HttpHost(<span class="string">"https://www.baidu.com"</span>, <span class="number">443</span>)), <span class="number">200</span>);</span><br><span class="line">CloseableHttpClient httpClient = HttpClientBuilder.create()</span><br><span class="line">  .setConnectionManager(manager).build();</span><br></pre></td></tr></table></figure>
<p>这个可以对单独的route设置最大连接数量，并且<code>setConnectionManager(manager)</code>会覆盖<code>setMaxConnTotal(400).setMaxConnPerRoute(200)</code>。</p>
<p>上面的这个<code>connectionTimeToLive</code>可以用以下两种方法设置，所有的超时连接都不会被复用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line">PoolingHttpClientConnectionManager manager = <span class="keyword">new</span> PoolingHttpClientConnectionManager(<span class="number">100</span>，TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">CloseableHttpClient httpClient = HttpClientBuilder.create()</span><br><span class="line">            .setConnectionTimeToLive(<span class="number">100</span>，TimeUnit.SECONDS).build();</span><br></pre></td></tr></table></figure>
<h2 id="RequestConfig-的-三个TimeOut"><a href="#RequestConfig-的-三个TimeOut" class="headerlink" title="RequestConfig 的 三个TimeOut"></a>RequestConfig 的 三个TimeOut</h2><p>每一个请求都可以带一个RequestConfig参数，对此次请求的一些参数进行设置。这里面比较重要的是三个timeout参数，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RequestConfig requestConfig = RequestConfig.custom()</span><br><span class="line">            .setConnectionRequestTimeout(<span class="number">30000</span>).setConnectTimeout(<span class="number">30000</span>)</span><br><span class="line">            .setSocketTimeout(<span class="number">30000</span>).build();</span><br><span class="line">HttpRequest request = <span class="keyword">new</span> HttpGet();	<span class="comment">// 或者new HttpPost()等</span></span><br><span class="line">request.setConfig(requestConfig);</span><br><span class="line">httpclient.execute(request);</span><br></pre></td></tr></table></figure>
<p>这三个timeout到底是干什么的？</p>
<p>###ConnectionRequestTimeout</p>
<p>看了上一章关于Connection的解读，这个参数的概念就十分清晰了。但我们还是从源码里追溯一下：</p>
<p>其调用栈大概是：</p>
<p><code>Httpclient#execute(HttpRequest)</code>  –&gt; <code>InternalHttpClient#doExecute(HttpHost, HttpRequest, HttpContext)</code>  –&gt; <code>MainClientExec#execute(HttpRoute, HttpRequestWrapper, HttpClientContext, HttpExecutionAware)</code>  </p>
<p>这个connectionTimeOut真正起作用的地方在这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainClientExec</span> <span class="keyword">implements</span> <span class="title">ClientExecChain</span> </span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CloseableHttpResponse <span class="title">execute</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> HttpRoute route,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> HttpRequestWrapper request,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> HttpClientContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> HttpExecutionAware execAware)</span> <span class="keyword">throws</span> IOException, HttpException </span>&#123;</span><br><span class="line">      <span class="comment">// 省略前后的无关语句</span></span><br><span class="line">     	<span class="comment">// 在doExecute中，requestConfig参数被包装到context里面了</span></span><br><span class="line">      <span class="keyword">final</span> RequestConfig config = context.getRequestConfig();</span><br><span class="line">      <span class="comment">// 下面这个语句我们是熟悉的</span></span><br><span class="line">      <span class="keyword">final</span> ConnectionRequest connRequest = connManager.requestConnection(route, userToken);</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> timeout = config.getConnectionRequestTimeout();</span><br><span class="line">      managedConn = connRequest.get(timeout &gt; <span class="number">0</span> ? timeout : <span class="number">0</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">      <span class="comment">// 之后的省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后去追溯<code>connRequest.get</code>方法，最终还是追溯到<code>getPoolEntryBlocking</code>方法里面去了。就是timeout和deadline的那个关系，可以关注一下上面的代码块。意思就是在等待队列里等到deadline还没法获取connection，就会抛<code>TimeoutException</code>异常。</p>
<h3 id="ConnectTimeout"><a href="#ConnectTimeout" class="headerlink" title="ConnectTimeout"></a>ConnectTimeout</h3><p>还是从<code>MainClientExec#execute(HttpRoute, HttpRequestWrapper, HttpClientContext, HttpExecutionAware)</code>去追溯，会发现有这么一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!managedConn.isOpen()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.log.debug(<span class="string">"Opening connection "</span> + route);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 当连接未打开时，首先建立连接</span></span><br><span class="line">        establishRoute(proxyAuthState, managedConn, route, request, context);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> TunnelRefusedException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.log.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.log.debug(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        response = ex.getResponse();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用栈是：<code>MainClientExec#establishRoute</code>  –&gt;  <code>PoolingHttpClientConnectionManager#connect(HttpClientConnection, HttpRoute, int, HttpContext context)</code>  –&gt;  <code>DefaultHttpClientConnectionOperator#connect(ManagedHttpClientConnection, HttpHost, InetSocketAddress, int, SocketConfig, HttpContext)</code></p>
<p>最后调用了<code>ConnectionSocketFactory#connectSocket(...)</code>方法，其实就是说这次建立连接的超时时间……好吧，是因为我懒得继续追溯源代码了。就这样敷衍了事吧。</p>
<h3 id="SocketTimeout"><a href="#SocketTimeout" class="headerlink" title="SocketTimeout"></a>SocketTimeout</h3><p>这个调用栈太深了，转来转去。我也懒得追踪了……总之意思就是连接多久不断开。当我们连接的是一个需要很长时间才能返回的Http接口时，将这个时间调的长一些以避免连接断开。但是这个也有副作用，就是假如设置了一个不合理的长时间，而被连接的服务出错或者挂掉了，那就会等待太久。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/09/HttpClient的几个参数/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-JVM调试工具使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/07/JVM调试工具使用/">JVM调试工具使用</a>
    </h1>
  

        
        <a href="/2020/05/07/JVM调试工具使用/" class="archive-article-date">
  	<time datetime="2020-05-07T06:03:53.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-05-07</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JVM调试工具使用简介"><a href="#JVM调试工具使用简介" class="headerlink" title="JVM调试工具使用简介"></a>JVM调试工具使用简介</h1><p>JVM调试工具是解决线上问题的重要方法。一些常见的线上问题比如说运行时单线程耗时过长、GC无法申请到足够的空间而产生OOM错误。这些线上的错误十分恼人，目前我们对于响应时间过长的处理，大多数是增加log，然后分析哪一步耗时比较长，这种做法并不是总是管用，因为有些多线程的问题可能很难复现，比如死锁，第二是并不是所有的生产环境都跟现在一样自由，我们可以随意部署、重启。至于OOM的处理，我们一直就没有好的办法，现在只能说从数据方面找问题，看是不是数据有问题？或者通过阅读代码对数据量进行估算，这些方法一是非常耗时，二是并不准确。</p>
<p>因此，掌握一些通用的JVM调试工具还是非常必要的。</p>
<h2 id="JVM内存模型"><a href="#JVM内存模型" class="headerlink" title="JVM内存模型"></a>JVM内存模型</h2><p>上面说到的两个问题，都与JVM的内存管理和线程运行有关系，JVM主要的调试工具和很大一部分参数，都是用来调整JVM的堆栈表现，因此，必须先了解JVM的内存模型，才能更好地理解之后调试工具的意义。</p>
<p>在深入了解JVM内存模型之前，有几个问题需要提前明确：</p>
<ol>
<li>JVM内存粗略分为堆内存、栈内存、本地内存三个部分。其中堆内存和栈内存都是使用虚拟机内存，而本地内存则直接使用了宿主机物理内存，JVM内存和虚拟机内存加起来受到物理内存和交换页的限制。在主机主要跑一个JAVA进程的时候，要注意不可能给JVM分配所有的内存，以免本地内存不够用而引发OOM。</li>
<li>JVM内存模型并非一成不变，随着JDK版本和垃圾回收机制的不同，JVM的内存实际状况都可能发生变化。比如说，在使用G1垃圾回收器的时候，堆内存就会被分为一块一块的，和使用其他回收期时堆内存连续分配有很大不同。并且自JDK1.8开始，原来存在于hotspot虚拟机中的永久代被移除，原来在永久代的方法区被移动到直接内存中，而运行时常量池被移动到堆中。</li>
<li>堆是JVM管理的最大一部分内存，远远超过栈空间的大小，在绝大多数情况下，也远超使用的本地内存的大小。因此，在JVM启动参数中，根据合理的评估准确设置堆内存大小，是JVM内存管理的一个重要手段。</li>
<li>根据IBM的研究，98%的java对象都在建立以后很快就死亡，没有活过下一次的垃圾回收。</li>
</ol>
<h3 id="内存模型简介"><a href="#内存模型简介" class="headerlink" title="内存模型简介"></a>内存模型简介</h3><p><img src="https://www.history-of-my-life.com/imgs-for-md/jvm-memory-20190811.jpg" alt="JVM内存模型"></p>
<p><strong>注意</strong>，上面的图是JDK1.7及之前的实现。但是大概意思是这样。</p>
<p>java运行时的数据区域包括程序计数器、java虚拟机栈、本地方法栈、java堆、方法区、运行时常量池和直接内存。</p>
<h4 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h4><p>虽然商用虚拟机在实现这个概念时可能比较复杂，但从概念上来理解，程序计数器就是指示下一条命令的地址的一个计数器而已。显然，因为每个栈有自己的运行进度，因此程序计数器显然是栈私有的。因为它基本上只记录一个地址，因此可想而知，它占得内存空间非常小，在我们讨论内存问题时，几乎可以忽略不计，因此，这个区也是唯一一个没有定义什么内存溢出错误的区。</p>
<h4 id="java虚拟机栈"><a href="#java虚拟机栈" class="headerlink" title="java虚拟机栈"></a>java虚拟机栈</h4><p>一看名字就知道是线程私有的。保存的主要是局部变量、操作数栈、动态链接、方法出口等。这些数据本身并不会占用太多空间，因为new出来的对象原则上仍然是在堆里面分配，根据一些大公司的研究，一般1M的默认栈空间大小足以负担1000-2000的栈深度，基本是够用了。</p>
<p>但是并不是说栈空间在所有情况下都不需要调整，与栈空间相关的异常有两个，一个是真的递归超过了最大栈空间，那就会出现StackOverflowError，如果允许虚拟机栈动态扩展，那么当其向堆扩展时发现没有空间，就会抛出OOM异常。其实这是一个问题的两个表现形式，都是栈空间用的太多了，只有一种情况除外，就是不停地申请线程，导致线程栈的数量太多而导致OOM，在这种情况下可能需要将栈空间调小一点。</p>
<p>与虚拟机栈相关的虚拟机参数有： </p>
<ul>
<li>-Xss 设置每个线程的栈大小，比如-Xss128k， -Xss1m</li>
</ul>
<h4 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h4><p>当JVM调用本地方法时，即调用使用其他语言编写，并且编译为物理机上可运行的程序的接口时，就会用到本地方法栈。这只是个概念，一些虚拟机把这个栈和虚拟机栈合二为一了，也没什么问题，比如最常用的hotsopt虚拟机，下面的介绍也主要是基于这个虚拟机。</p>
<h4 id="堆内存"><a href="#堆内存" class="headerlink" title="堆内存"></a>堆内存</h4><p>对绝大多数应用来说，这是虚拟机管理的最大的一部分内存，所有线程共享，这个区域唯一的目的就是存放对象，从概念上来讲，所有new出来的对象都会在这里分配内存（有一些优化手段会改变这个事实，但从概念上仍然可以这么认为）。</p>
<p>堆内存的具体结构和垃圾回收的方式紧密相连。比如说，现在主流的分代垃圾回收方式，对新生代采取复制算法，对老年代采取标记-整理算法，因此新生代和老年代一般是两整块区域，而因为新生代采取了复制算法，因此又分为eden区（伊甸园）和两个survivor区，其比例大约是8:1:1。</p>
<p>在大部分情况下，新生代和老年代都是各自占据连续的一整块内存（逻辑上的一连续一整块，物理上未必），在采用了G1垃圾回收器的JVM虚拟机中，eden、survivor、old被划分成大小一样的一些块，一个块默认是1M大小，JVM用空闲列表来维护这些块，其内存构造又有所不同。</p>
<p>堆内存可以扩展，也可以不扩展。固定大小的堆比较稳定，稳定的堆对于维护稳定的老年代大小比较有利，在一定程度上可以减少GC的次数，但是固定大小的堆在实际利用率不高的情况下，会增加每次GC的时长。</p>
<p>与堆内存相关的虚拟机参数茫茫多，整理如下：</p>
<ul>
<li>-Xms 初始堆大小，比如 -Xms1024m。默认情况为物理内存的1/64，在使用容器时比较复杂。</li>
<li>-Xmx 最大堆大小，比如 -Xmx8196m。默认情况为物理内存的1/4，在使用容器时比较复杂。当-Xms=-Xmx的值时，堆不会进行扩展和收缩，是稳定的。</li>
<li>-Xmn 年轻代大小，比如-Xmn2g。整个堆大小=年轻代大小+年老代大小+永久代大小（要注意到1.8以后就没有永久代了），因此调整年轻代的大小，就会挤占老年代的空间，这个值对系统的影响比较大，需要根据情况进行设置，一般来说，年轻代大小是老年代大小1/2比较稳妥，在较老的JVM设置中，hotspot建议的值是<code>年轻代/堆总大小=3/8</code>。比如如果系统中充满了大量短命的大对象，那么增加年轻代的大小，甚至使其大于老年代，都是可以考虑的。</li>
<li>-XX:NewRatio 设置年轻代与老年代大小的比值，如-XX:NewRatio=4代表年轻代是老年代的1/4，在设置了Xms=Xmx并且设置了Xmn的情况下，该参数不需要进行设置。</li>
<li>-XX:SurvivorRatio eden和survivor之间的大小比例，鉴于98%的对象都是朝生夕死，因此这个比值一般都设置成8:1:1，这也是默认值。</li>
</ul>
<p>在使用到容器时，JDK1.8_131之前的JVM不能识别容器对于硬件资源的限制，总是能读到物理机的内存，因此，在不设置-Xms和-Xmx时，容器中的JVM虚拟机会按照物理机内存的1/64和1/4去申请，很容易在超出限制后被杀掉。于是需要手动设置这两个值。</p>
<p>自动JDK1.8_131以后，JVM增加了一个实验特性，自动感知容器大小，需要加两个参数以开启，这两个参数如下：</p>
<ul>
<li>-XX:+UnlockExperimentalVMOptions 打开JDK的实验特性。<ul>
<li>-XX:+UseCGroupMemoryLimitForHeap 要求感知container的大小</li>
</ul>
</li>
</ul>
<p>同时，增加了一个参数来调整优化默认表现。</p>
<ul>
<li>-XX:MaxRAMFraction 比如-XX:MaxRAMFraction=1，表示JVM管理的堆大小是虚拟机内存的多少分之一，默认情况下是4。显然这个值太保守了，在很多情况下，我们的容器主要就跑一个JVM，只用1/4的内存还是太浪费了。于是一般需要调整这个值到2，但是随着容器内存的增大，1/2的浪费也不能接受了，但一旦申请成1，因为元空间的存在，就必然爆内存。</li>
</ul>
<p>针对这种情况，有两个解决方案，一个是手动设置-Xms和-Xmx。但这又太不灵活了，假如我改了容器的内存，就又要手改参数，所以最好是用容器的EntryPoint来解决这个问题。</p>
<p>第二种解决方案依赖于更高版本的JDK，至少在我们使用的JDK1.8_191中可以使用下列参数来配置：</p>
<ul>
<li><p>XX:+UseContainerSupport  作用如其名</p>
<ul>
<li>XX:MaxRAMPercentage 比如XX:MaxRAMPercentage=90.00，意思是使用容器内存的90%作为JVM管理的堆。具体使用多少还需要根据实际环境来调整。</li>
</ul>
</li>
</ul>
<h4 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h4><p>它用于存储已被加载的虚拟机的类信息、常量、静态变量、即时编译器编译后的代码等数据。这些都是java加载时产生的一些数据。在JDK1.7以前，这个区在所谓的永久代，但是JDK1.8以后，这个区被移动到直接内存中去了，直接内存也有个好听的名字，叫元空间（metadataSpace）</p>
<p>一般来说，这个区域不怎么需要垃圾回收，垃圾回收的效果也不是很令人满意。但是在大量使用反射、动态代理或者字节码织入技术的框架中，因为可能生成比较多的动态类，这部分的空间也有可能面临压力，如果没有空间了，就会抛出异常。</p>
<p>现在因为这个区使用了直接内存，因此要牢记JVM内存+直接内存一起受到物理内存的限制，如果给JVM内存分配的空间过大，挤占了直接内存的大小，那么有可能会出现堆明明不怎么满，但却OOM的问题，或者出现因为内存换页，导致运行速度大幅下滑的问题。</p>
<p>在一些大量使用了NIO的框架中，也要注意直接内存的分配大小。</p>
<p>与此相关的参数包括：</p>
<ul>
<li>-XX:MaxDirectMemorySize 调整直接内存大小。</li>
</ul>
<h4 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h4><p>JDK1.7之前，运行时常量池放在永久代，和方法区放在一起，JDK1.7之后，已经把运行时常量池移动到堆中了。经查询，网文中关于这一块的细节部分讲的不多，《深入理解JVM虚拟机》那么书又是基于1.7的。所以下面这段话请存疑地看。</p>
<p>JDK1.8以后，字符串常量移动到了堆中，但是基本类型包装类等运行时常量池还是在方法区，也就是在元空间。在java中，所有的基本类型包装类都有常量池，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</span><br><span class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然用到了常量池，而这个上限是可以通过虚拟机参数来调整的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.lang.Integer.IntegerCache.high=xxxx</span><br></pre></td></tr></table></figure>
<p>但是下限不可调整。</p>
<p>特别的，应该关注一下字符串常量池，目前它在堆中，而且可以通过<code>String.internal()</code>进行动态地添加，因此需要关注OOM问题。</p>
<h4 id="直接内存-元空间"><a href="#直接内存-元空间" class="headerlink" title="直接内存-元空间"></a>直接内存-元空间</h4><p>主要在JDK1.8以后用于存放方法区、字符串常量以外的常量池，以及被使用了NIO的框架使用。在设置JVM的堆内存时，应当考虑到元空间的大小，避免堆内存对着物理内存上限去设置，否则将会出现比较难以排查的OOM问题。</p>
<p>与此相关的JVM参数包括，注意这些参数只有在JDK1.8以上才可用</p>
<ul>
<li>-XX:MetaspaceSize=128m  元空间的初始化大小</li>
<li>-XX:MaxMetaspaceSize=512m 元空间的最大值</li>
</ul>
<h3 id="内存回收机制简介"><a href="#内存回收机制简介" class="headerlink" title="内存回收机制简介"></a>内存回收机制简介</h3><h4 id="啥样的对象算是死亡了"><a href="#啥样的对象算是死亡了" class="headerlink" title="啥样的对象算是死亡了"></a>啥样的对象算是死亡了</h4><h5 id="引用计数器"><a href="#引用计数器" class="headerlink" title="引用计数器"></a>引用计数器</h5><p>为每个对象维护一个引用计数器，引用计数器为0就认为死了。这个思想很常用，比如说Cpp的智能指针。但用在垃圾回收上有个很大的问题，就是循环引用时会导致发生循环引用的对象引用计数器永远不是0，实际上不能访问的对象也不能清除。</p>
<h5 id="可达性分析法"><a href="#可达性分析法" class="headerlink" title="可达性分析法"></a>可达性分析法</h5><p>即从一组根节点出发进行遍历，可达的对象我们都认为存活，不可达的对象当然就是死了。这个方法听起来不错，这一组根节点被称为<code>GC roots</code>。这个方法最重要的是定义<code>GC roots</code>有哪些。</p>
<ul>
<li><p>System Class（由bootstrap装载的类）</p>
<p>Class loaded by bootstrap/system class loader. For example, everything from the rt.jar like java.util.*</p>
</li>
<li><p>JNI Local（native code的局部变量）</p>
<p>Local variable in native code, such as user defined JNI code or JVM internal code.</p>
</li>
<li><p>JNI Global（native code的全局变量）</p>
<p>Global variable in native code, such as user defined JNI code or JVM internal code. </p>
</li>
<li><p>Thread Block（JVM虚拟机线程栈）</p>
<p>Object referred to from a currently active thread block. </p>
</li>
<li><p>Thread（状态不是TERMINTED的线程）</p>
<p>A started, but not stopped, thread. </p>
</li>
<li><p>Busy Monitor（被用作锁的对象）</p>
<p>Everything that has called wait() or notify() or that is synchronized. For example, by calling synchronized(Object) or by entering a synchronized method. Static method means class, non-static method means object. </p>
</li>
<li><p>Java Local（局部变量）</p>
<p>Local variable. For example, input parameters or locally created objects of methods that are still in the stack of a thread. </p>
</li>
<li><p>Native Stack（本地方法栈）</p>
<p>In or out parameters in native code, such as user defined JNI code or JVM internal code. This is often the case as many methods have native parts and the objects handled as method parameters become GC roots. For example, parameters used for file/network I/O methods or reflection. </p>
</li>
<li><p>Finalizable（在Finalizable队列中等待的对象）</p>
<p>An object which is in a queue awaiting its finalizer to be run. </p>
</li>
<li><p>Unfinalized（重写了finalize方法，但是还没有被finalize过的对象）</p>
<p>An object which has a finalize method, but has not been finalized and is not yet on the finalizer queue. </p>
</li>
<li><p>Unreachable（像是自定义的根这样的）</p>
<p>An object which is unreachable from any other root, but has been marked as a root by MAT to retain objects which otherwise would not be included in the analysis. </p>
</li>
<li><p>Java Stack Frame（虚拟机栈）</p>
<p>A Java stack frame, holding local variables. Only generated when the dump is parsed with the preference set to treat Java stack frames as objects. </p>
</li>
<li><p>Unknown</p>
<p>An object of unknown root type. Some dumps, such as IBM Portable Heap Dump files, do not have root information. For these dumps the MAT parser marks objects which are have no inbound references or are unreachable from any other root as roots of this type. This ensures that MAT retains all the objects in the dump.</p>
</li>
</ul>
<h5 id="Live-or-die"><a href="#Live-or-die" class="headerlink" title="Live or die?"></a>Live or die?</h5><p>还有一些对象，在内存充足的情况下允许他们存在，在内存不足时就可以回收，典型的比如说缓存。JDK也考虑到了这些用途，因此推出了集中不同强度的引用。</p>
<ul>
<li><p>强引用。只要引用存在，永远不会回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object o = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure>
</li>
<li><p>软引用。在GC时，会将这些对象列入回收范围，但放在第二次回收中，如果第一次回收还没有足够的内存，才会回收他们。注意最好直接不要有其他引用引到<code>new Object()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SoftReference&lt;Object&gt; softReference = <span class="keyword">new</span> SoftReference&lt;&gt;(<span class="keyword">new</span> Object());</span><br><span class="line"><span class="comment">// 下面的写法就不好</span></span><br><span class="line">Object o = <span class="keyword">new</span> Object();</span><br><span class="line">SoftReference&lt;Object&gt; softReference = <span class="keyword">new</span> SoftReference&lt;&gt;(o);</span><br><span class="line">o = <span class="keyword">null</span>;	<span class="comment">// 如果忘记，就有一个强引用指向该object</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>弱引用。只能存活到下一次GC，下一次GC必然会回收。(有趣的是，还有一个WeakHashMap类)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WeakReference&lt;Object&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> Object());</span><br></pre></td></tr></table></figure>
</li>
<li><p>虚引用。这玩意对GC没有任何影响，也没法通过一个虚引用获得一个对象实例。为一个对象设置了虚引用后，该对象被回收时能收到一个系统通知而已。</p>
</li>
</ul>
<h5 id="可达性分析的实际操作问题与safepoint"><a href="#可达性分析的实际操作问题与safepoint" class="headerlink" title="可达性分析的实际操作问题与safepoint"></a>可达性分析的实际操作问题与safepoint</h5><p><a href="https://rednaxelafx.iteye.com/blog/1044951" target="_blank" rel="noopener">找出栈上的指针/引用</a></p>
<p>在上面我们看到，可达性分析法需要首先去枚举gc roots，因为gc roots除了静态变量这种在类加载时已经确定的部分以外，还有一些像在线程栈中的引用这些不断发生变化的部分，因此，每一次要进行可达性分析，从理论上讲都需要先枚举gc roots</p>
<p>这其实是一项比较耗费时间的工程，而且必须要停止虚拟机其他线程的运行。因为如果允许在枚举的时候gc roots还在不断发生变化，那枚举的结果显然不准。这个暂停的动作，在hotspot虚拟机中称为Stop The World（STW）</p>
<p>那么有没有办法加速这个过程呢？有，首先，对于那些在类加载时期就已经能确定的引用，我们当然可以用一些数据结构把它记录下来，而对于运行时的一些数据，实际上也可以在某些位置把相关栈帧里的引用数据保留下来，gc roots的枚举速度就会提升。显然商用的虚拟机都这么做了（不然其实我也想不出来这些优化），保存这些gc roots位置的数据结构，称为OopMap（HotSpot的称呼）。</p>
<p>但这里就有个新问题，能引起栈帧变化的指令非常多，如果每一条指令都生成一个OopMap，那虚拟机的效率得低成什么样子。因此，JVM实际上只在特殊的指令处生成OopMap，这些指令处就称为“safePoint”，safepoint的选择，既要避免每一条指令来一下，也要避免太长时间到达不了safepoint，因此，在一些执行时间较长的任务前后进行保存似乎是个好主意，这样至少避免了长时间无法到达safepoint，这就包括：</p>
<ul>
<li><p>循环的末尾</p>
</li>
<li><p>方法返回前</p>
</li>
<li><p>调用方法的call指令之后</p>
</li>
<li><p>可能抛出异常的位置</p>
</li>
</ul>
<p>在这样的指令处，java可能会生成一个操作码，指令线程主动去更新自己的OopMap。在等待所有线程到达自己的safepoint时，JVM一般是设置一个GC的标志位，线程会轮询这个标志位，发现标志位被置位后，就自己等待，所有线程都等待后，就是Stop the word，标记GC roots开始。</p>
<h5 id="可达性分析的实际操作问题与JNI"><a href="#可达性分析的实际操作问题与JNI" class="headerlink" title="可达性分析的实际操作问题与JNI"></a>可达性分析的实际操作问题与JNI</h5><p>上面又出现了一个新问题，那就是OopMap的维护，需要JVM的参与，实际上在java的字节码中加了一点料。但是当使用JNI的时候，那些本地方法的调用并不需要JVM的参与，他们怎么去维护这个OopMap呢？当然其实可以不维护，采取每次全扫一遍本地方法栈的方式来解决问题。</p>
<p>但是Hotspot虚拟机选择了另一种方式，即所有经过JNI调用边界的引用，都必须通过一个中间对象——“句柄”（handler），JNI要调用java API的时候也需要用句柄包装指针。而句柄表是可以由JVM维护的，这样需要知道JNI方法使用的java对象只需要扫描句柄表就可以了。</p>
<p>带来的代价是JNI调用需要进行句柄的中转，效率有所下降。</p>
<h4 id="几种不同的思想"><a href="#几种不同的思想" class="headerlink" title="几种不同的思想"></a>几种不同的思想</h4><h5 id="标记-清除"><a href="#标记-清除" class="headerlink" title="标记 - 清除"></a>标记 - 清除</h5><p>就是对所有已死亡的对象进行标记，然后把他们从内存中清除出去。标记的办法着实也不怎么高效，因为要标记已死亡对象，所以需要遍历堆内存的对象头，而清除出去主要是维护空闲列表，这两者消耗都比较大。</p>
<p>而且，这还很容易造成内存碎片，导致在内存明明还有很多空间时，大内存无法分配，而频繁引起GC，甚至Full GC。</p>
<h5 id="标记-整理"><a href="#标记-整理" class="headerlink" title="标记 - 整理"></a>标记 - 整理</h5><p>就是对所有还存活的对象进行标记，然后把他们移动到内存的一端去，之后将指示空闲内存开始位置的指针直接移动到最后一个存活对象尾部。这样就避免了内存碎片。</p>
<h5 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h5><p>从概念上讲，是将内存分为相等大小的两个部分，当一个部分满了以后，就将这个部分的存活对象移动到另外一个部分去。这样最大的问题是内存使用率太低。但是根据前面的介绍，其实98%左右的对象都是朝生夕死，那么实际上真正需要复制的对象大多数情况下都非常少，所以，商用的虚拟机比如hotspot，在使用复制算法时并没有真的把空间分成相等的两个大小，而是分为eden、from survivor、to survivor三个区域，同时只使用eden和其中一个survivor，当两个都到了回收阈值的时候，就把存活的对象复制到另一个survivor中去，再把eden和from survivor清空。</p>
<p>比如说，在极端情况下，存活的对象非常多，to survivor放不下怎么办。这时候一般会直接把一些对象放到老年代去。因此，实际上在每一次GC开始前，都会查看一下老年代的空间，看老年代是不是足够放下极端情况下的所有新生代对象，如果足够，那么这次新生代GC可以无风险进行，万一to survivor放不下了，反正老年代够，就扔进去好了。那如果老年代如果空间不足以放得下新生代所有对象呢？这就涉及到一个新的问题，就是full gc和冒险策略。当允许冒险时，只要老年代的空间大于以往放入老年代的平均空间，那就进行新生代GC，万一失败，就进行full gc，如果不允许冒险或者老年代的空间小于以往放入老年代的平均空间，就直接进行full gc。</p>
<p>一般将新生代的gc成为Minor GC，而带老年代一起的GC称为Full gc。</p>
<h5 id="分代算法"><a href="#分代算法" class="headerlink" title="分代算法"></a>分代算法</h5><p>因为新生代对象绝大多数都是朝生夕死，因此适合使用复制算法，但一些对象总是会逐渐稳定下来，那么这些对象来回复制的话代价就很高了，因此现在一般商用虚拟机都实现了分代算法，对新生代和老年代采取不同的回收策略，比如新生代用复制算法，老年代用标记-整理算法。</p>
<h5 id="分代算法引发的新问题与Remembered-Set"><a href="#分代算法引发的新问题与Remembered-Set" class="headerlink" title="分代算法引发的新问题与Remembered Set"></a>分代算法引发的新问题与Remembered Set</h5><p>‼️<strong>以下内容有很多自己的理解，如果错漏概不负责，请抱着审慎的态度阅读。</strong></p>
<p>如果每一次都做Full GC，那么我们的思路就比较简单，就是从GC roots开始遍历探寻可达性即可，标记所有的可达数据，标记为存活。之后开始整理就完了。</p>
<p>但如果是分代处理的话，就会有一些新问题。比如从GC roots遍历是个比较耗时的操作，特别是假如我们只想回收新生代的垃圾，那么遍历老年代就是一个不必要的开销，特别是老年代堆很大，遍历花费的时间还不少。于是，商用虚拟机在新生代收集时，都不扫描老年代的对象，即，从GC roots开始遍历时，一旦遇到老年代的对象，就直接打住（判断是不是老年代对象其实比较简单，老年代的内存空间有上下界），不再继续深入。这样就只遍历了新生代对象。</p>
<p>但这又有一个问题。假如GC roots连接了一个老年代对象，但这个老年代对象持有了一个新生代对象的引用，但是上面说的方式就扫描不到，这就会把一个实际存活的新生代对象漏掉。为了解决这个问题，又引入了一个新概念，就是Remembered Set。</p>
<p>每当老年代对象引用新生代对象时，在新生代旁边开辟一块单独的空间，把这个引用关系记录下来，当引用断开时，清除这个引用关系。于是，GC收集器就可以在不完整扫描老年代对象的情况下，直接去读取这些记录就知道新生代的哪些对象被老年代引用了。换言之，GC收集器将这个记录也作为GC roots就可以了。</p>
<p>这个记录就叫做Remembered Set。在一些文章中我们会看到Card Table这个概念，这是Remebered Set的一种具体实现。</p>
<p>可见，safe point和Remembered Set技术的主要思想都是用空间换时间，尽量减少GC时要扫描的范围。</p>
<h3 id="垃圾收集器的实现"><a href="#垃圾收集器的实现" class="headerlink" title="垃圾收集器的实现"></a>垃圾收集器的实现</h3><p>垃圾收集器有很多种不同的实现，没有一种垃圾收集器适应所有的应用场景，要合理选择垃圾收集器，就要首先了解关于垃圾收集器和GC的一些基本指标。</p>
<h4 id="两个需要注意的指标"><a href="#两个需要注意的指标" class="headerlink" title="两个需要注意的指标"></a>两个需要注意的指标</h4><p>除了垃圾回收要确实干净、安全以外。有两个有关时间的指标需要考量。</p>
<ul>
<li><p>吞吐量。</p>
<p>即JVM运行后，用于执行用户代码的时间和CPU消耗的总时间的比例，这个比例越高，说明CPU更多地用于用户代码执行，比如说JVM运行了100分钟，垃圾回收花掉了1分钟，那么吞吐量就是99%。</p>
</li>
<li><p>线程停顿时间</p>
<p>因为在枚举根节点等情况下，需要STW，因此用户线程会被停顿，这个停顿时间，当然我们希望是越短越好，这样就能尽量不影响用户操作了。</p>
</li>
</ul>
<p>不同的垃圾收集器侧重点不同，不同的应用的需求也不同。比如说，CPU运算密集型的应用（这种应用为啥要用java写），显然更关注吞吐量，希望有更多时间花在用户工作上。而一个服务器，更希望用户线程被停顿的时间越短越好，尽量不要影响用户操作比较好。</p>
<p>因此，不同的应用下选择合理的垃圾收集器，也是程序员的一种能力。</p>
<h4 id="两种需要理解的GC类别"><a href="#两种需要理解的GC类别" class="headerlink" title="两种需要理解的GC类别"></a>两种需要理解的GC类别</h4><p>根据 <code>JVM界唯一认证扛把子·他说的不一样的都是错的·真·R大</code> 的文章：<a href="https://www.zhihu.com/question/41922036/answer/93079526" target="_blank" rel="noopener">Major GC和Full GC的区别是什么？</a></p>
<blockquote>
<p>针对HotSpot VM的实现，它里面的GC其实准确分类只有两大种：</p>
<p>Major GC通常是跟full GC是等价的，收集整个GC堆。但因为HotSpot VM发展了这么多年，外界对各种名词的解读已经完全混乱了，当有人说“major GC”的时候一定要问清楚他想要指的是上面的full GC还是old GC。</p>
<p>最简单的分代式GC策略，按HotSpot VM的serial GC的实现来看，触发条件是：</p>
<p>HotSpot VM里其它非并发GC的触发条件复杂一些，不过大致的原理与上面说的其实一样。<br>当然也总有例外。Parallel Scavenge（-XX:+UseParallelGC）框架下，默认是在要触发full GC前先执行一次young GC，并且两次GC之间能让应用程序稍微运行一小下，以期降低full GC的暂停时间（因为young GC会尽量清理了young gen的死对象，减少了full GC的工作量）。控制这个行为的VM参数是-XX:+ScavengeBeforeFullGC。这是HotSpot VM里的奇葩嗯。可跳传送门围观：<a href="https://www.zhihu.com/question/48780091/answer/113063216" target="_blank" rel="noopener">JVM full GC的奇怪现象，求解惑？ - RednaxelaFX 的回答</a></p>
<p>并发GC的触发条件就不太一样。以CMS GC为例，它主要是定时去检查old gen的使用量，当使用量超过了触发比例就会启动一次CMS GC，对old gen做并发收集。</p>
</blockquote>
<h4 id="具体的垃圾收集器"><a href="#具体的垃圾收集器" class="headerlink" title="具体的垃圾收集器"></a>具体的垃圾收集器</h4><p>首先，这些垃圾收集器包括：</p>
<p><img src="https://img-blog.csdn.net/20160505170035450" alt="hotspot垃圾收集器"></p>
<p>红色区域表示新生代垃圾收集器，而绿色区域表示老年代垃圾收集器。其中有连线表示可以配合使用。</p>
<h5 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h5><p>就是单线程，Stop The World后实现垃圾收集。虽然说STW不太友好，单线的整体程效率也不高。但他因为简单，所有具有最高效率的单线程回收效率。所以至今仍然广泛用在java的Client模式（适用于GUI的开发）下，这个场景一般内存占用不大，收集几十兆上百兆的新生代还是没什么明显的停顿感。</p>
<ul>
<li><p>插播：Jvm的Client与Server模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ java -version</span><br><span class="line">java version &quot;1.8.0_131&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_131-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)</span><br></pre></td></tr></table></figure>
<p>在机器上运行<code>jave -version</code>就能看到模式，在最后一行。一般来说，Client模式启动更快，但启动后运行时和垃圾回收表现都稍差；Server编译更彻底，在启动时稍慢，但运行后速度和垃圾回收效果都比较好。一般可以简单认为，Client适合开发Gui，而Server适合做服务器。</p>
</li>
</ul>
<p>与Serial收集器相关的虚拟机参数包括：</p>
<ul>
<li>-XX:SurvivorRatio=8，意思是eden/survivor区的比例，默认为8，上面都说了无数次了。</li>
<li>-XX:MaxTenuringThreshold  这是与垃圾回收器紧密相关的一个参数，意思是当一个新生代的对象经过一次gc之后如果存活下来了，那么他的年龄会+1，当达到这个参数指定的年龄后，就会被移动到老年代。对象从survivor移动到老年代还有一个可能，就是当survivor区中同年龄的对象达到或超过一半survivor空间大小，那么大于等于此年龄的对象都会被移动到老年区。该参数只有用串行GC回收器才有效。</li>
<li>-XX:PretenureSizeThreshold=\<byte size> 意思是当对象大于这个值时直接在老年代分配，以避免大对象的来回复制。但有利有弊吧，因为老年代不经常被回收，所以如果短命大对象直接在老年代分配，会导致不断需要触发full gc，得不偿失。这个参数默认是0，也就是所有对象都在eden分配。</byte></li>
<li>-XX:HandlePromotionFailure 就是上面所说的复制算法的老年代担保是否允许冒险。但在JDK1.6以后，这个参数已经无效，JVM总是会选择冒险策略。</li>
</ul>
<p>触发时机：</p>
<p>eden区不够分配对象了。</p>
<h5 id="ParNew"><a href="#ParNew" class="headerlink" title="ParNew"></a>ParNew</h5><p>Serial收集器的多线程版本，复用了Serial的大多数代码，和相关虚拟机参数。</p>
<p>在单CPU环境下，其变现绝对不可能超过Serial，甚至双CPU也未必能超过，但多CPU下性能表现一般会更好。而且因为只有它能与CMS配合使用，因此在server模式下经常使用。</p>
<p>触发时机：</p>
<p>eden区不够分配对象了</p>
<h5 id="Parallel-Svavenge"><a href="#Parallel-Svavenge" class="headerlink" title="Parallel Svavenge"></a>Parallel Svavenge</h5><p>这也是个新生代的收集器，使用复制算法，并且多线程。看起来和parNew是一样的。但是他的关注点和ParNew不一样，这个垃圾收集器更加关注吞吐量。因此，他提供了两个参数来设置吞吐量和最大垃圾收集停顿时间。</p>
<ul>
<li>-XX:MaxGCPauseMills=100 意思是<strong>请求</strong>垃圾收集器每次垃圾回收时暂停的时间尽可能不超过这个值。但只是尽可能，不能完全保证，而且每次暂停时间短有可能造成GC的次数增多，造成吞吐量下降。</li>
<li>-XX:GCTimeRatio=99 就是CPU执行用户任务的时间/GC时间的值，数值越大，允许的GC时间就越短。比如99，就是说只允许1%的时间用于垃圾收集。但这个也只能是建议，不可能完全保证。</li>
<li>-XX:UseAdaptiveSizePolicy 当这个参数打开以后，就不用手动指定新生代大小、Eden和Survivor区的比例，晋升老年代的年龄值等细节参数了。虚拟机会动态监控系统运行状况，得到一个合适的值，并设置前两个参数，给虚拟机一个目标，虚拟机就会自动调整以上参数。</li>
</ul>
<p>触发时机：</p>
<p>eden区不够分配了</p>
<h5 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h5><p>Serial的老年代版本，主要意义除了和Serial一起用在client模式下以外，还有作为CMS收集器的后备方案。</p>
<p>触发时机：</p>
<ol>
<li>在Client模式下使用时，触发时机是老年代空间不足</li>
<li>作为CMS的后备方案时，触发时机是：当CMS收集器在并发清理环节浮动垃圾撑爆了剩余的老年代空间，就会抛出ConcurrentModeFailure。从而触发Serial Old收集。</li>
</ol>
<h5 id="Parallel-Old"><a href="#Parallel-Old" class="headerlink" title="Parallel Old"></a>Parallel Old</h5><p>是Parallel Svavenge收集器的老年代版本，和新生代的Parallel Svavenge收集器配合，能达到合理控制吞吐量的效果。</p>
<p>触发时机：</p>
<p>老年代空间不足。</p>
<h5 id="CMS（Concurrent-Mark-Swap）"><a href="#CMS（Concurrent-Mark-Swap）" class="headerlink" title="CMS（Concurrent Mark Swap）"></a>CMS（Concurrent Mark Swap）</h5><p><a href="https://www.jianshu.com/p/2a1b2f17d3e4" target="_blank" rel="noopener">简书：图解CMS垃圾回收机制，你值得拥有</a></p>
<p>从名字可以看出，这个收集器是基于标记-清除算法实现的，而且多线程。</p>
<p>这个收集器的不同之处，在于它以获取最短停顿时间为目标，并且实现了垃圾回收线程（的一些工作阶段）与用户的任务线程并发执行。</p>
<p>为了实现这个目标，它分为四个阶段：</p>
<ul>
<li>初始标记。即只标记与GC roots直接关联的对象，需要STW</li>
<li>并发标记。从初始标记中的结果进行可达性分析。不需要STW，可以和用户线程并发执行。</li>
<li>重新标记。这个过程也需要STW，这是为了修正在STW期间因为用户操作而变动的那一部分标记，速度比初始标记慢一点，但是比并发标记阶段要快得多。</li>
<li>并发清除。把标记出来的垃圾清除掉。这个也可以和用户线程并发。</li>
</ul>
<p>因为并发标记和并发清除阶段和用户线程并发了，因此暂停时间比较短。但是这个收集器也有几个缺点：</p>
<ul>
<li><p>它的单线程收集效率显然不如之前介绍的那些收集器。而且，因为在并发过程中，它也占用了CPU，因此在单CPU或者双CPU情况下，会导致有很大的CPU资源被用作垃圾回收，用户的代码能使用的CPU资源就会受到很大的挤占。</p>
</li>
<li><p>在并发清除阶段，因为与用户线程并发，因此还会生成新的垃圾，为了应对这些新建的对象，CMS收集器必须预留足够的空间给用户线程使用，因此不能像其他收集器一样等到老年代几乎填满了再进行收集，在JDK1.5的默认情况下，当老年代使用到68%，就会激活CMS收集器，后来提升到92%。如果CMS运行期间预留的空间不足以供用户线程新申请的对象使用，那么JVM就会启动Serial Old重新处理老年代的垃圾收集，这会非常慢。</p>
<p>与这个行为相关的参数为：</p>
<ul>
<li>-XX:CMSInitiatingOccupancyFranction。即设置上面的百分比。设置的值如果太高，就会经常导致并发收集失败，启用Serial Old，性能会下滑明显。</li>
</ul>
</li>
<li><p>CMS基于并发-清除算法，意味着内存碎片会增多。因此可能对大对象分配带来麻烦。因此，在进行Full GC时，就进行内存的整理，内存整理无法并发，因此必须STW，停顿时间会变长。</p>
</li>
</ul>
<p>而且仔细考虑CMS的并发清除阶段，实际上还有这样一个小问题：即并发清除阶段如果发生了young GC，有新对象进入了老年区，他们是没有被标记的白对象，会不会被清除？就是<a href="https://stackoverflow.com/questions/43789967/java-cms-gc-can-a-minor-gc-occur-between-final-remark-and-concurrent-sweep" target="_blank" rel="noopener">这个问题</a>所担心的情况。这个问题的解答是，因为CMS对老年区维护了可用空间的列表，因此只要保证新进入老年区的对象放到这些可用空间里，而并发清除不扫描这些可用内存区域即可（以上有自己的猜测在里面，不一定准确）。即：并发清除阶段扫描的时候只扫描在最终标记后标记为需要清理的空间。这也是为什么CMS不能等到老年区几乎填满才进行垃圾回收的原因。（深入理解JAVA虚拟机第二版P83）说的也就是这个问题。</p>
<p>与CMS相关的参数非常多，简单列几个如下：</p>
<ul>
<li><p>-XX:+UseConcMarkSweepGC  开启CMS</p>
</li>
<li><p>-XX:UseCMSCompactAtFullCollection 默认开启，用于FullGC时的内存整理。</p>
</li>
<li>-XX:CMSFullGCSBeforeCompaction=1 几次不带整理的FullGC后来一次整理的，默认值为0，意味着每次进入FullGC都进行碎片整理。</li>
<li>-XX:ParallelCMSThreads=20 CMS默认启动的回收线程数目是 (ParallelGCThreads + 3)/4) ，如果你需要明确设定，可以通过-XX:ParallelCMSThreads=20来设定,其中ParallelGCThreads是年轻代的并行收集线程数</li>
<li>-XX:+UseCMSInitiatingOccupancyOnly  </li>
<li>-XX:CMSInitiatingOccupancyFraction=92.0 老年代空间占用达到多少时进行一次老年代垃圾回收。</li>
</ul>
<p>触发时机：</p>
<ol>
<li>如果没有设置-XX:+UseCMSInitiatingOccupancyOnly，虚拟机会根据收集的数据决定是否触发。</li>
<li>老年代使用率达到阈值 <code>CMSInitiatingOccupancyFraction</code>，默认92%。</li>
<li>新生代的晋升担保失败。</li>
</ol>
<h4 id="上述几种收集器的可能组合"><a href="#上述几种收集器的可能组合" class="headerlink" title="上述几种收集器的可能组合"></a>上述几种收集器的可能组合</h4><p>摘自<a href="https://www.zhihu.com/question/41922036/answer/144566789" target="_blank" rel="noopener">知乎：Major GC和Full GC的区别是什么</a></p>
<ol>
<li>Serial GC算法：Serial Young GC ＋ Serial Old GC （实际上它是全局范围的Full GC）</li>
<li>Parallel GC算法：Parallel Young GC ＋ 非并行的PS MarkSweep GC / 并行的Parallel Old GC（这俩实际上也是全局范围的Full GC），选PS MarkSweep GC 还是 Parallel Old GC 由参数UseParallelOldGC来控制；</li>
<li><p>CMS算法：ParNew（Young）GC + CMS（Old）GC （piggyback on ParNew的结果／老生代存活下来的object只做记录，不做compaction）＋ Full GC for CMS算法（应对核心的CMS GC在老年代给浮动垃圾预留的内存不足导致并发清除失败后full gc，开销很大）；</p>
</li>
<li><p>下面即将介绍的，新生代和老年代一起搞了的，G1收集器。</p>
</li>
</ol>
<h4 id="G1（Garbage-First）垃圾优先收集器"><a href="#G1（Garbage-First）垃圾优先收集器" class="headerlink" title="G1（Garbage-First）垃圾优先收集器"></a>G1（Garbage-First）垃圾优先收集器</h4><p><a href="https://ylgrgyq.github.io/2016/07/03/garbage-first-collector-understanding/" target="_blank" rel="noopener">Garbage First Collector 理解</a></p>
<p>G1是一款比较新的垃圾收集器。在JDK8时，需要加参数<code>-XX:+UseG1GC</code>，在JDK11时，默认使用这款垃圾收集器。这款垃圾收集器与之前介绍的一些收集器相比，有以下特点：</p>
<ol>
<li><p>能够同时处理新生代和老年代。虽然在内部也区分了不同代的不同处理方式。这也不算最大的特点，因为之前的比如说Serial收集器，就可以同时收集新生代和老年代。</p>
</li>
<li><p>对内存逻辑结构的改变很大。不像之前的收集器处理的新生代和老年代是逻辑上连续的一整块内存，启用了G1垃圾收集器的JVM，从顶层来看，虽然仍然区分了新生代和老年代，也有eden、survivor和old区，但是在具体的分配上不再是各自连续的一整块，而是划分为一个一个的Region，每一个Region的大小是固定的，最小是1M，可以以2的倍数递增，最大是32M。同时，新增了一个Humongous区，用来存储大对象，所谓的大对象，是指超过region大小一半的对象。这么做是为了防止对大对象进行反复拷贝，其堆内存结构如下图：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-G1-20190809.png" alt="G1HeapLayOut"></p>
</li>
<li><p>从顶层来看，G1收集器是基于<code>标记-清除</code>的算法，因为它更像是发现哪些Region没有存活对象了，就把这些Region的空间标记为可用。但就细节而观察，又是基于复制算法，即将一些对象从这个Region复制到另外一个Region里面去，从而把其中一些Region空出来。</p>
</li>
<li><p>创造性地建立了可预测停顿时间的机制，可以指定在M毫秒的时间片段内，消耗在垃圾回收上的时间不得超过N毫秒。（当然也不一定会满足，只是尽量满足）。这种机制的实现，是依赖它维护了每个Region回收后能清理出的空间的大小（垃圾回收价值）的优先列表，在每次垃圾回收时未必都回收，而是根据允许的垃圾回收时间，优先回收价值大的Region。这就是所谓垃圾优先（Gabage First）名称的由来。</p>
</li>
</ol>
<p>在实际收集过程中，G1也分为四个阶段：</p>
<ol>
<li><p>初始标记</p>
<p>标记GC roots中直接关联的对象，需要STW。在这个阶段完成以后，之后的用户线程新建的对象会被放到一些确定这一次不会回收的Region里面去。</p>
</li>
<li><p>并发标记</p>
<p>进行可达性分析，找出存活的对象。因为G1甚至不是按照新生代老年代来回收垃圾，而是按照回收的价值来回收Region。因此上面所说的分代带来的老年代（不想浪费时间扫描的对象）引用新生代的问题在这里也会暴露出来。即我们不想回收的Region里（价值低的Region），存在指向我们想回收的Region里的对象。因此，G1为每一个Region都维护了一个Remembered Set。</p>
<p>这一阶段和用户的线程并发。这就导致了对象引用图有可能会发生变化。</p>
</li>
<li><p>最终标记</p>
<p>对并发过程中用户程序修改的对象图发生的变化情况进行修正，需要STW。</p>
</li>
<li><p>筛选回收</p>
<p>根据用户期望时间，查询Region垃圾回收价值优先队列，确定最终要回收哪些Region（筛选），并回收。</p>
</li>
</ol>
<p>G1垃圾收集器看起来和CMS垃圾收集器很像，在一些缺点上也比较像，就是肯定会有一些浮动垃圾，而且在CPU数量较少时也会有一些性能挤占问题。</p>
<p>相关参数：</p>
<ul>
<li>-XX:G1HeapRegionSize  设置Region大小，取值范围从1m到32m，必须以2的倍数递增。如果不指定，将会根据Heap的大小自动设置，以期达到2048块region。</li>
<li>-XX:MaxGCPauseMillis=n  每次GC的期待最大暂停时间，以ms为单位。</li>
<li>-XX:G1PrintRegionLivenessInfo debug参数，默认false。在清理阶段的并发标记环节,输出堆中的所有 regions 的活跃度信息</li>
<li>-XX:G1PrintHeapRegions    debug参数，默认false，G1将输出哪些regions被分配和回收的信息</li>
<li>-XX:G1RSetUpdatingPauseTimePercent  G1收集器在GC时，更新Rset的目标时间值。</li>
</ul>
<p>G1的特点与优势</p>
<ul>
<li>适合大堆，因为不像 CMS 和 Parallel GC 在对老代进行收集的时候需要将整个老代全部收集，G1 收集老代一次只收集老代的一部分 Region</li>
<li>G1 的 Heap 划分为多个 Region，Young Generation 和 Old Generation 都只是逻辑概念，不是物理上隔离又连续的空间</li>
<li>G1 的新老代划分不是固定的，一个新代的 Region 在被回收之后可以作为老代 Region 使用，Young Generation 和 Old Generation 大小也会随着系统运行而调整</li>
<li>G1 的新生代收集和 Parallel、CMS GC 一样是并发的 STW 收集，且每次 YGC 会将整个 Young Generation 收集</li>
<li>G1 的 Old Generation 收集每次只收集一部分 Old Region，且这部分 Old Region 是和 YGC 一起进行的，所以称为 Mixed GC</li>
<li>和 CMS 一样，G1 也有 fail-safe 的 FGC，单线程且会做 compaction</li>
<li>G1 的 Old Generation GC (Mixed GC) 也是自带 compaction 的</li>
<li>G1 没有永久代的概念</li>
</ul>
<p>触发时机：</p>
<p>因为G1可以同时支持新生代和老年代的收集，所以它的触发时机更复杂一些。</p>
<p>对年轻代来说，触发时机就是Eden区被沾满。</p>
<p>对老年代来说，和CMS类似，当Old Generation空间占用<strong>整个Heap</strong>比例超过目标值(-XX:InitiatingHeapOccupancyPercent, IHOP)后触发。</p>
<h4 id="CMS和G1的最终标记阶段都做了些什么"><a href="#CMS和G1的最终标记阶段都做了些什么" class="headerlink" title="CMS和G1的最终标记阶段都做了些什么"></a>CMS和G1的最终标记阶段都做了些什么</h4><p><a href="https://www.zhihu.com/question/37028283" target="_blank" rel="noopener">知乎:关于CMS、G1垃圾回收器的重新标记、最终标记疑惑</a></p>
<p>因为CMS和G1都有并发标记阶段，也就是说，因为允许可达性分析阶段和用户线程并行。那么就必然带来一个问题，在可达性分析时，一些引用关系已经发生了变化。这些变化主要包含这两种情况：</p>
<ol>
<li>新增了部分GC roots，这些GC roots引用了一些新建的对象。</li>
<li>一些已有的引用关系发生了变化。比如将一个引用赋值为null，或者将一个引用引用到另外一个对象上去。其实引用到另外一个对象上，也无外乎三种情况，第一种，是使一个引用指向null，这有可能造成一个对象成为垃圾，我们称这个操作为引用删除；第二种，是使一个引用指向另外一个已存在的对象，这其实对垃圾回收没有任何印象；第三种，是新建一个对象，让这个引用指向新建的对象，这等价于发生了两步操作，一步是使引用指向null，第二步是相当于GC roots引用了新建对象。</li>
</ol>
<p>综合起来看，总共就两类操作：</p>
<ol>
<li>新建引用-对象关联，有引用指向新建对象；</li>
<li>删除引用-对象关联，有对象在并发标记期间不再有引用指向了。</li>
</ol>
<p>而最终标记阶段就是为了处理这些问题，CMS和G1都使用了一种叫做Write Barrier的技术，来对初始标记以后发生的变化进行记录。在这个阶段，每一次引用变化都会经过Write Barrier，记录相关的变动，最后将这些记录合并到清理对象里面去就可以了。</p>
<p>回忆一下，CMS的并发清除阶段因为是将死亡对象的空间直接标记为可用，因此一定不能出现漏标的情况，如果漏标了存活对象，就会导致程序出现错误。（错标虽然会造成垃圾增多，但是下次收集就完了，不会造成程序错误）。因此，CMS的最终标记阶段关注的问题是：新建引用对象必须要记录下来，删除引用倒无所谓，大不了等下一次收集。</p>
<p>所以，CMS采用了叫做INC write barrier的技术，就是记录每次引用新建，在最终标记阶段还需要重新扫描一遍GC roots，因此这个remark时间还比较长，一般占到一次CMS两次STW总时间的80%。</p>
<p>而G1就略有不同，G1使用了 Snapshot-At-The-Beginning Write Barrier(SATB)，在初始标记阶段结束后会打上一个快照，之后所有的新分配的对象通通视为活跃，然后分配到这次保证不回收的Region里面去，反正是按Region回收嘛。它更关注引用的删除，以更加准确地评估垃圾回收的价值。</p>
<p>追根究底，似乎CMS和G1都不非要有重新标记阶段，因为只要保证新进入老年区/新分配的内存分配在此次不回收的内存区就完了，代价是更多的浮动垃圾。但实际上还是做了重新标记，可能是JVM的开发团队评估后认为这样性能还是更好。<strong>（这一段包含自己的猜测，请审慎阅读）</strong></p>
<h2 id="JVM调试工具"><a href="#JVM调试工具" class="headerlink" title="JVM调试工具"></a>JVM调试工具</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="工具箱里有什么"><a href="#工具箱里有什么" class="headerlink" title="工具箱里有什么"></a>工具箱里有什么</h4><p>JVM调试工具做的事情，就是监控虚拟机的性能，并且发现发生在运行时的故障比如说死锁、内存溢出等。大部分JVM工具以命令行工具的方式提供，也有一些可视化工具，比如JConsole和VisualVM。</p>
<p>其中，命令行工具有：</p>
<ul>
<li><p>jps</p>
<p>查看主机运行的JVM的ID（和操作系统的PID相同）以及运行参数</p>
</li>
<li><p>jstat</p>
<p>查看虚拟机的各项统计数据。主要是一些内存占用状况，GC的情况。</p>
</li>
<li><p>jinfo</p>
<p>查看虚拟机的各项配置信息，以及环境变量。</p>
</li>
<li><p>jmap</p>
<p>Java内存映像工具，即将JVM的一块内存以二进制的形式dump成为文件，方便用其他内存分析工具进行分析。还有个骚操作，直接将目前JVM的状态完整保存成一个可运行的jar，可以直接从当前状态运行。</p>
</li>
<li><p>jhat</p>
<p>用来读取jmap dump出来的内存文件，或者设置了<code>-XX:+HeapDumpOnOutOfMemoryError</code>的虚拟机在内存溢出时自动dump出来的内存文件。他会启动一个web server，用户可以用浏览器查看分析结果。</p>
</li>
<li><p>jstack</p>
<p>java堆栈跟踪工具。能够将JVM线程栈的运行情况打印出来，包括线程基本信息如tid等，还包括其所处的状态比如Waiting、Runable等，以及其持有的锁信息等。在追踪线上服务某些线程长时间卡顿时非常好用。</p>
</li>
<li><p>jcmd</p>
<p>一个多功能的工具，其功能覆盖了上面介绍的好几个工具，比如它也能导出堆、查看Java进程、导出线程信息、执行GC、还可以进行采样分析。自JDK1.7引入。</p>
</li>
</ul>
<p>可视化工具包括：</p>
<ul>
<li><p>Jconsole</p>
<p>在命令行运行会启动一个GUI界面，显示一些统计数据。</p>
</li>
<li><p>VisualVM</p>
<p>一个支持插件的可视化JVM性能检测工具，是随JDK发布的功能最强大的debug工具，并且官方称之为<code>All-In-One</code>，可见官方对其寄予厚望。</p>
</li>
</ul>
<h4 id="获得heap-Dump的几种方式"><a href="#获得heap-Dump的几种方式" class="headerlink" title="获得heap Dump的几种方式"></a>获得heap Dump的几种方式</h4><p>上面可以看到，很多调试工具都是围绕JVM内存管理展开的，也确实，OOM是我们经常遇到又让人非常恼火的错误。因此我们先介绍一下获得heap dump的几种方式。</p>
<ul>
<li><p>使用jmap</p>
<p><code>jmap -dump:live,format=b,file=d:\dump\heap.hprof &lt;pid&gt;</code></p>
</li>
<li><p>使用jcmd</p>
<p><code>jcmd &lt;pid&gt; GC.heap_dump d:\dump\heap.hprof</code></p>
</li>
<li><p>使用JVM参数获取dump文件</p>
<ul>
<li><p>-XX:+HeapDumpOnOutOfMemoryError</p>
<p>OOM时导出内存镜像。可能是比较常用的debug参数了，因为毕竟一般不OOM，我们也不太关注内存使用情况。</p>
</li>
<li><p>-XX:+HeapDumpBeforeFullGC</p>
<p>每次Full GC之前导出内存镜像。在性能调优的情况下可能用的比较多。</p>
</li>
<li><p>-XX:+HeapDumpAfterFullGC</p>
<p>当 JVM 执行 FullGC 后执行 dump。</p>
</li>
<li><p>-XX:+HeapDumpOnCtrlBreak</p>
<p>交互式的操作，当按下ctrl+break时产生镜像。可能在debug时经常会用到吧。</p>
</li>
<li><p>-XX:HeapDumpPath=d:\test.hprof</p>
<p>指定内存dump文件的保存位置。</p>
</li>
</ul>
</li>
</ul>
<h3 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h3><p>注：因为不同JDK版本的问题，以下命令的细节可能有些变化，每个命令都可以用–help参数查看帮助，具体的表现请以自己的版本为准。以下的输出基于<code>JDK 1.8_131</code>， <code>&gt; ~</code>表示命令行的输入。因为在macOS下，1.8更高版本的调试工具无法正常使用，会抛以下异常，查了一些资料好像是官方bug，暂时也没办法，降到131后正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 1014, please wait...</span><br><span class="line">Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can&apos;t attach symbolicator to the process</span><br><span class="line">sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can&apos;t attach symbolicator to the process</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$BsdDebuggerLocalWorkerThread.execute(BsdDebuggerLocal.java:169)</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.attach(BsdDebuggerLocal.java:287)</span><br><span class="line">	at sun.jvm.hotspot.HotSpotAgent.attachDebugger(HotSpotAgent.java:671)</span><br><span class="line">	at sun.jvm.hotspot.HotSpotAgent.setupDebuggerDarwin(HotSpotAgent.java:659)</span><br><span class="line">	at sun.jvm.hotspot.HotSpotAgent.setupDebugger(HotSpotAgent.java:341)</span><br><span class="line">	at sun.jvm.hotspot.HotSpotAgent.go(HotSpotAgent.java:304)</span><br><span class="line">	at sun.jvm.hotspot.HotSpotAgent.attach(HotSpotAgent.java:140)</span><br><span class="line">	at sun.jvm.hotspot.tools.Tool.start(Tool.java:185)</span><br><span class="line">	at sun.jvm.hotspot.tools.Tool.execute(Tool.java:118)</span><br><span class="line">	at sun.jvm.hotspot.tools.JInfo.main(JInfo.java:138)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at sun.tools.jinfo.JInfo.runTool(JInfo.java:108)</span><br><span class="line">	at sun.tools.jinfo.JInfo.main(JInfo.java:76)</span><br><span class="line">Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can&apos;t attach symbolicator to the process</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.attach0(Native Method)</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal.access$100(BsdDebuggerLocal.java:65)</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$1AttachTask.doit(BsdDebuggerLocal.java:278)</span><br><span class="line">	at sun.jvm.hotspot.debugger.bsd.BsdDebuggerLocal$BsdDebuggerLocalWorkerThread.run(BsdDebuggerLocal.java:144)</span><br></pre></td></tr></table></figure>
<h4 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jps --help</span><br><span class="line">usage: jps [--help]</span><br><span class="line">       jps [-q] [-mlvV] [&lt;hostid&gt;]</span><br></pre></td></tr></table></figure>
<p>具体效果请自测。-l参数输出主类的全限定名；-m输出main method的参数；-v输出jvm参数；输出通过flag文件传递到JVM中的参数(.hotspotrc文件或-XX:Flags=所指定的文件；</p>
<h4 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h4><p><a href="https://www.jianshu.com/p/c321d0808a1b" target="_blank" rel="noopener">简书：jinfo命令详解</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jinfo --help</span><br><span class="line">Usage:</span><br><span class="line">    jinfo [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jinfo [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jinfo [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    -flag &lt;name&gt;         to print the value of the named VM flag</span><br><span class="line">    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag</span><br><span class="line">    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value</span><br><span class="line">    -flags               to print VM flags</span><br><span class="line">    -sysprops            to print Java system properties</span><br><span class="line">    &lt;no option&gt;          to print both of the above</span><br><span class="line">    -h | -help           to print this help message</span><br></pre></td></tr></table></figure>
<p>这个命令可以查看和修改JVM的一些参数。具体效果自己测试吧，会打印出来一大堆。</p>
<h4 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h4><p>这个主要是输出一些内存相关的统计数据。有很多子参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat --help</span><br><span class="line">Usage: jstat --help|-options</span><br><span class="line">       jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</span><br><span class="line"></span><br><span class="line">Definitions:</span><br><span class="line">  &lt;option&gt;      An option reported by the -options option</span><br><span class="line">  &lt;vmid&gt;        Virtual Machine Identifier. A vmid takes the following form:</span><br><span class="line">                     &lt;lvmid&gt;[@&lt;hostname&gt;[:&lt;port&gt;]]</span><br><span class="line">                Where &lt;lvmid&gt; is the local vm identifier for the target</span><br><span class="line">                Java virtual machine, typically a process id; &lt;hostname&gt; is</span><br><span class="line">                the name of the host running the target Java virtual machine;</span><br><span class="line">                and &lt;port&gt; is the port number for the rmiregistry on the</span><br><span class="line">                target host. See the jvmstat documentation for a more complete</span><br><span class="line">                description of the Virtual Machine Identifier.</span><br><span class="line">  &lt;lines&gt;       Number of samples between header lines.</span><br><span class="line">  &lt;interval&gt;    Sampling interval. The following forms are allowed:</span><br><span class="line">                    &lt;n&gt;[&quot;ms&quot;|&quot;s&quot;]</span><br><span class="line">                Where &lt;n&gt; is an integer and the suffix specifies the units as</span><br><span class="line">                milliseconds(&quot;ms&quot;) or seconds(&quot;s&quot;). The default units are &quot;ms&quot;.</span><br><span class="line">  &lt;count&gt;       Number of samples to take before terminating.</span><br><span class="line">  -J&lt;flag&gt;      Pass &lt;flag&gt; directly to the runtime system.</span><br><span class="line">  -? -h --help  Prints this help message.</span><br><span class="line">  -help         Prints this help message.</span><br></pre></td></tr></table></figure>
<h5 id="class"><a href="#class" class="headerlink" title="-class"></a>-class</h5><p>显示加载class的数量，及所占空间等信息，效果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -class 1758</span><br><span class="line">Loaded       Bytes    Unloaded     Bytes      Time</span><br><span class="line"> 15704     28719.1           1       0.9     10.09</span><br></pre></td></tr></table></figure>
<h5 id="compiler"><a href="#compiler" class="headerlink" title="-compiler"></a>-compiler</h5><p>显示VM实时编译的数量等信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -compiler 1758</span><br><span class="line">Compiled Failed Invalid    Time   FailedType   FailedMethod</span><br><span class="line">    7957      0       0    29.31           0</span><br></pre></td></tr></table></figure>
<h5 id="gc"><a href="#gc" class="headerlink" title="-gc"></a>-gc</h5><p>显示gc的消息，包括gc的次数、时间等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gc 1758</span><br><span class="line">S0C       S1C    S0U      S1U       EC       EU       OC         OU       MC         MU       CCSC       CCSU    YGC     YGCT    FGC    FGCT    CGC       CGCT      GCT</span><br><span class="line">0.0   14336.0    0.0   14336.0 139264.0 129024.0  89088.0    21987.5   80000.0   78249.0   10880.0    10193.5     14    0.170      0   0.000      8      0.030    0.199</span><br></pre></td></tr></table></figure>
<ul>
<li>S0C:  survivor0 capacity（单位kb）</li>
<li>S0U: survivor0 used</li>
<li>S1C:  survivor1 capacity</li>
<li>S1U: survivor1 used</li>
<li>EC:  Eden capacity</li>
<li>EU: Eden used</li>
<li>OC: old capacity</li>
<li>OU: old used</li>
<li>MC: method capacity</li>
<li>MU: method used</li>
<li>CCSC: 压缩类空间大小</li>
<li>CCSU: 压缩类空间使用大小</li>
<li>YGC: 年轻带垃圾回收次数</li>
<li>YGCT: 年轻代垃圾回收耗时</li>
<li>FGC: Full GC 次数</li>
<li>FGCT: Full GC耗时</li>
<li>CGC: Concurrent GC次数</li>
<li>CGCT: Concurrent GC耗时</li>
<li>GCT: GC总耗时</li>
</ul>
<h5 id="gccapacity"><a href="#gccapacity" class="headerlink" title="-gccapacity"></a>-gccapacity</h5><p>堆内存统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gccapacity 57889</span><br><span class="line">NGCMN       NGCMX       NGC     S0C      S1C         EC   OGCMN       OGCMX        OGC         OC       MCMN        MCMX       MC     CCSMN      CCSMX      CCSC     YGC    FGC   CGC</span><br><span class="line">  0.0   2097152.0   149504.0    0.0   12288.0  137216.0     0.0    2097152.0    88064.0    88064.0       0.0   1118208.0   80000.0      0.0   1048576.0  10880.0     15      0     8</span><br></pre></td></tr></table></figure>
<p>部分和-gc重复的输出就不解释了，看一下不同的输出：</p>
<ul>
<li>NGCMN        新生代最小容量（单位kb）</li>
<li>NGCMX         新生代最大容量</li>
<li>NGC              当前新生代容量</li>
<li>OGCMN        老年代最小容量</li>
<li>OGCMX         老年代最大容量</li>
<li>MCMN           方法区最小容量</li>
<li>MCMX            方法区最大容量</li>
<li>CCSMN          压缩区最小容量</li>
<li>CCSMX           压缩去最大容量</li>
</ul>
<h5 id="gccause"><a href="#gccause" class="headerlink" title="-gccause"></a>-gccause</h5><p>最近一次GC统计和原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gccause 57889</span><br><span class="line">  S0       S1        E       O      M       CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT      LGCC               GCC</span><br><span class="line">0.00   100.00    52.99   27.49   97.66    93.52     15    0.167     0    0.000     8    0.022    0.189 G1 Evacuation Pause  No GC</span><br></pre></td></tr></table></figure>
<p>其中的S0什么的，都是指使用了多少。</p>
<h5 id="gcmetacapacity"><a href="#gcmetacapacity" class="headerlink" title="-gcmetacapacity"></a>-gcmetacapacity</h5><p>metaSpace中对象的信息和占用量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcmetacapacity 57889</span><br><span class="line">MCMN       MCMX        MC       CCSMN      CCSMX       CCSC     YGC   FGC    FGCT    CGC    CGCT     GCT</span><br><span class="line">  0.0  1118208.0    80000.0        0.0  1048576.0    10880.0    15     0    0.000     8    0.022    0.189</span><br></pre></td></tr></table></figure>
<h5 id="gcnew"><a href="#gcnew" class="headerlink" title="-gcnew"></a>-gcnew</h5><p>年轻代对象的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcnew 57889</span><br><span class="line">S0C    S1C    S0U     S1U    TT  MTT     DSS        EC       EU    YGC   YGCT</span><br><span class="line">0.0 12288.0   0.0  12288.0    5   15   8704.0  137216.0  72704.0    15  0.167</span><br></pre></td></tr></table></figure>
<ul>
<li>TT       对象在新生代存活的次数（年龄）</li>
<li><p>MTT    对象在新生代存活的最大次数</p>
</li>
<li><p>DSS     幸存者区所需空间大小</p>
</li>
</ul>
<h5 id="gcnewcapacity"><a href="#gcnewcapacity" class="headerlink" title="-gcnewcapacity"></a>-gcnewcapacity</h5><p>年轻代容量信息，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcnewcapacity 57889</span><br><span class="line">NGCMN      NGCMX       NGC      S0CMX     S0C     S1CMX     S1C       ECMX        EC      YGC   FGC   CGC</span><br><span class="line">  0.0  2097152.0   149504.0      0.0      0.0 2097152.0  12288.0  2097152.0   137216.0    15     0     8</span><br></pre></td></tr></table></figure>
<h5 id="gcold"><a href="#gcold" class="headerlink" title="-gcold"></a>-gcold</h5><p>老年代对象信息，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcold 57889</span><br><span class="line">     MC       MU      CCSC     CCSU       OC          OU        YGC    FGC    FGCT    CGC    CGCT     GCT</span><br><span class="line">80000.0  78128.8    10880.0  10174.9     88064.0     24207.3     15     0    0.000     8    0.022    0.189</span><br></pre></td></tr></table></figure>
<h5 id="gcoldcapacity"><a href="#gcoldcapacity" class="headerlink" title="-gcoldcapacity"></a>-gcoldcapacity</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcoldcapacity 57889</span><br><span class="line">OGCMN       OGCMX        OGC         OC       YGC   FGC    FGCT    CGC    CGCT     GCT</span><br><span class="line">  0.0   2097152.0     88064.0     88064.0    15     0     0.000     8    0.022    0.189</span><br></pre></td></tr></table></figure>
<h5 id="gcutil"><a href="#gcutil" class="headerlink" title="-gcutil"></a>-gcutil</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstat -gcutil 57889</span><br><span class="line">  S0       S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT</span><br><span class="line">0.00   100.00  55.97  27.49  97.66  93.52     15    0.167     0    0.000     8    0.022    0.189</span><br></pre></td></tr></table></figure>
<p>输出了数据后怎么分析，还是看自己需求。比如说我看了我们一个线上JVM的服务，YGC总共一百多次，FGC竟然运行了一千多次，显然是哪里出了问题，内存分配策略有问题。</p>
<h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>这个命令用于打印指定java进程或者核心文件中所有java线程当前时刻正在执行的方法堆栈追踪情况，也就是线程的snapshot，生成线程的快照主要用于定位线程长时间出现停顿的原因，如死锁、等待外部资源等。jstack在分析死锁，阻塞等性能问题上非常有用，根据打印的堆栈信息可以定位到出问题的代码段。定位问题的思路根据要解决的问题而发生不同，比如可以首先找到java进程中最耗cpu的线程，再根据线程id在jstack的输出中定位，或者使用指定的线程名称定位。</p>
<p>输出特别有意思，比如说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstack -l 57889</span><br><span class="line">2019-08-08 17:20:10</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (11.0.4+10-LTS mixed mode):</span><br><span class="line"></span><br><span class="line">Threads class SMR info:</span><br><span class="line">_java_thread_list=0x00007fc141522820, length=31, elements=&#123;</span><br><span class="line">0x00007fc14288d800, 0x00007fc14202c000, 0x00007fc142028800, 0x00007fc142894000,</span><br><span class="line">0x00007fc142897000, 0x00007fc143020800, 0x00007fc141821000, 0x00007fc142903000,</span><br><span class="line">0x00007fc1462d9000, 0x00007fc1463a5800, 0x00007fc144071000, 0x00007fc1450e7800,</span><br><span class="line">0x00007fc144ef4800, 0x00007fc141d54800, 0x00007fc14379a800, 0x00007fc143551800,</span><br><span class="line">0x00007fc145134800, 0x00007fc141fd4000, 0x00007fc141deb000, 0x00007fc144270000,</span><br><span class="line">0x00007fc144164800, 0x00007fc141bde000, 0x00007fc144156000, 0x00007fc141c6f800,</span><br><span class="line">0x00007fc146422800, 0x00007fc14657d800, 0x00007fc1440ca000, 0x00007fc14453e000,</span><br><span class="line">0x00007fc1450e6800, 0x00007fc145f02000, 0x00007fc14552d800</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=31 cpu=6.75ms elapsed=6997.49s tid=0x00007fc14288d800 nid=0x3303 waiting on condition  [0x000070000dfc6000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">	at java.lang.ref.Reference.waitForReferencePendingList(java.base@11.0.4/Native Method)</span><br><span class="line">	at java.lang.ref.Reference.processPendingReferences(java.base@11.0.4/Reference.java:241)</span><br><span class="line">	at java.lang.ref.Reference$ReferenceHandler.run(java.base@11.0.4/Reference.java:213)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line">	</span><br><span class="line">... // 以下省略</span><br></pre></td></tr></table></figure>
<p>之后的输出就类似于上面最后一段的输出，解读如下：</p>
<ul>
<li><p>“Reference Handler” :     线程名称</p>
</li>
<li><p>daemon:                           守护线程 </p>
</li>
<li><p>prio:                                   线程优先级</p>
</li>
<li><p>os_prio:                            系统的线程优先级</p>
</li>
<li>cpu:                                   占用的CPU时间</li>
<li>elapsed:                           启动多久了</li>
<li>tid:                                    jvm中的线程标识符</li>
<li>nid:                                   系统中的本地线程标识符</li>
<li>waiting on condition:     等待条件满足</li>
<li>[0x000070000dfc6000]  线程的起始地址</li>
</ul>
<p>下面显示的是函数调用栈和持有锁的情况。</p>
<p>比如说下面这段代码，就一定会造成线程Waiting卡死，注：<strong>这是错误的写法，代码里不要用。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != <span class="number">5</span>; ++i) &#123;</span><br><span class="line">        executorService.execute(() -&gt; </span><br><span class="line">            System.out.println(<span class="string">"hello, I'm "</span> + Thread.currentThread().getName()));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//没有这一行的话下面的awaitTermination会等超时，详情见awaitTermination的注释</span></span><br><span class="line">  	<span class="comment">// executorService.shutdown();   </span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executorService.awaitTermination(<span class="number">10</span>, TimeUnit.DAYS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后进程就hang住了。jstack查看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstack 9527</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.191-b12 mixed mode):</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; #17 daemon prio=9 os_prio=31 tid=0x00007fe5e8a0b000 nid=0x2907 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;pool-1-thread-5&quot; #16 prio=5 os_prio=31 tid=0x00007fe5e92ff800 nid=0x5703 waiting on condition [0x000070000887a000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to wait for  &lt;0x0000000795c2d4b0&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">	at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">	</span><br><span class="line">// 之后省略</span><br></pre></td></tr></table></figure>
<p>可以看到，线程池里面的线程处于等待之中，并且是在ThreadPoolExecutor中等待，等待的原因是从LinkedBlockingQueue中take时hang住了。首先我们从线程名中获得了等待线程的名字，知道他是线程池里面的线程，于是就缩小了出错的范围。然后又知道是线程池试图去取任务时发生了等待，那为什么线程池还要去取任务呢？因为我们没有shutdown()线程池。</p>
<p>再举个几乎必然会死锁的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    executorService.execute(<span class="keyword">new</span> DeadLock(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    executorService.execute(<span class="keyword">new</span> DeadLock(<span class="number">2</span>, <span class="number">1</span>));</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executorService.awaitTermination(<span class="number">10</span>, TimeUnit.DAYS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> a, b;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DeadLock</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != <span class="number">200</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (Integer.valueOf(a)) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (Integer.valueOf(b)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"我来了，又走了2"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为<code>Integer.valueof(a)</code>在a比较小时会使用缓存，因此实际上加锁的对象都是同一个对象。所以以上代码几乎必然发生死锁。jstack结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jstack 9527</span><br><span class="line">// 前半部分忽略。只看最后</span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;pool-1-thread-2&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007fb7173f0758 (object 0x00000007955c0430, a java.lang.Integer),</span><br><span class="line">  which is held by &quot;pool-1-thread-1&quot;</span><br><span class="line">&quot;pool-1-thread-1&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007fb7173f0808 (object 0x00000007955c0440, a java.lang.Integer),</span><br><span class="line">  which is held by &quot;pool-1-thread-2&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line">&quot;pool-1-thread-2&quot;:</span><br><span class="line">	at com.richinfoai.umbrella.pipeline.publicFacility.utlis.Pair.lambda$main$1(Pair.java:43)</span><br><span class="line">	- waiting to lock &lt;0x00000007955c0430&gt; (a java.lang.Integer)</span><br><span class="line">	- locked &lt;0x00000007955c0440&gt; (a java.lang.Integer)</span><br><span class="line">	at com.richinfoai.umbrella.pipeline.publicFacility.utlis.Pair$$Lambda$2/2110121908.run(Unknown Source)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">&quot;pool-1-thread-1&quot;:</span><br><span class="line">	at com.richinfoai.umbrella.pipeline.publicFacility.utlis.Pair.lambda$main$0(Pair.java:27)</span><br><span class="line">	- waiting to lock &lt;0x00000007955c0440&gt; (a java.lang.Integer)</span><br><span class="line">	- locked &lt;0x00000007955c0430&gt; (a java.lang.Integer)</span><br><span class="line">	at com.richinfoai.umbrella.pipeline.publicFacility.utlis.Pair$$Lambda$1/204349222.run(Unknown Source)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line">Found 1 deadlock.</span><br></pre></td></tr></table></figure>
<p>下面再举个例子，线程执行时间很长的情况。（linux下模拟的，因为macOS下我竟然找了一下午都没有找到一个能显示线程ID和线程使用CPU状况的命令，linux下的<code>top -H 、ps -eLf</code>macOS下通通不支持。）测试机器状态如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ cat /proc/version</span><br><span class="line">Linux version <span class="number">3.10</span><span class="number">.0</span>-<span class="number">957</span>.el7.x86_64 (mockbuild<span class="meta">@kbuilder</span>.bsys.centos.org) </span><br><span class="line">  (gcc version 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) ) #1 </span><br><span class="line">    SMP Thu Nov <span class="number">8</span> <span class="number">23</span>:<span class="number">39</span>:<span class="number">32</span> UTC <span class="number">2018</span></span><br></pre></td></tr></table></figure>
<p>我们在java中开个线程，运行一个无限循环。</p>
<p>代码很简单:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InfinityLoop</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                    System.out.println(i++);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们搞到测试机上跑起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ java -cp . InfinityLoop &gt; output.txt &amp;</span><br><span class="line">&gt; ~ jps</span><br><span class="line">14889 InfinityLoop</span><br><span class="line">&gt; ~ jstack 14889</span><br><span class="line">// 前后省略没用的输出</span><br><span class="line">&quot;main&quot; #1 prio=5 os_prio=0 tid=0x00007fe510009000 nid=0x3a2a runnable [0x00007fe519804000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">	at java.io.FileOutputStream.writeBytes(Native Method)</span><br><span class="line">	at java.io.FileOutputStream.write(FileOutputStream.java:326)</span><br><span class="line">	at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">	at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)</span><br><span class="line">	- locked &lt;0x0000000080214020&gt; (a java.io.BufferedOutputStream)</span><br><span class="line">	at java.io.PrintStream.write(PrintStream.java:482)</span><br><span class="line">	- locked &lt;0x0000000080214000&gt; (a java.io.PrintStream)</span><br><span class="line">	at sun.nio.cs.StreamEncoder.writeBytes(StreamEncoder.java:221)</span><br><span class="line">	at sun.nio.cs.StreamEncoder.implFlushBuffer(StreamEncoder.java:291)</span><br><span class="line">	at sun.nio.cs.StreamEncoder.flushBuffer(StreamEncoder.java:104)</span><br><span class="line">	- locked &lt;0x0000000080214140&gt; (a java.io.OutputStreamWriter)</span><br><span class="line">	at java.io.OutputStreamWriter.flushBuffer(OutputStreamWriter.java:185)</span><br><span class="line">	at java.io.PrintStream.write(PrintStream.java:527)</span><br><span class="line">	- locked &lt;0x0000000080214000&gt; (a java.io.PrintStream)</span><br><span class="line">	at java.io.PrintStream.print(PrintStream.java:597)</span><br><span class="line">	at java.io.PrintStream.println(PrintStream.java:736)</span><br><span class="line">	- locked &lt;0x0000000080214000&gt; (a java.io.PrintStream)</span><br><span class="line">	at InfinityLoop.main(InfinityLoop.java:7)</span><br></pre></td></tr></table></figure>
<p>其nid即linux本地线程id为<code>0x3a2a</code>，转化为十进制为<code>14890</code>，我们继续排查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ ps -mp 14889 -o THREAD,tid,time</span><br><span class="line">USER     %CPU PRI SCNT WCHAN  USER SYSTEM   TID     TIME</span><br><span class="line">root     99.8   -    - -         -      -     - 00:02:27</span><br><span class="line">root      0.0  19    - futex_    -      - 14889 00:00:00</span><br><span class="line">root     99.3  19    - -         -      - 14890 00:02:27</span><br><span class="line">root      0.0  19    - futex_    -      - 14891 00:00:00</span><br><span class="line">root      0.0  19    - futex_    -      - 14892 00:00:00</span><br><span class="line">root      0.0  19    - futex_    -      - 14893 00:00:00</span><br><span class="line">// 省略其他输出</span><br></pre></td></tr></table></figure>
<p>可见这个线程疯狂占内存了。当然，这也是我们期待的结果咯。一般排查的话应该是反过来，先ps看哪个线程耗资源比较大，然后去jstack查看具体的java线程，看其线程栈到底在做什么。</p>
<p>最后放一个Spring web请求的stack，实际任务只有一个，就是调用Spring Repository JPA保存一个entity，其线程栈如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">&quot;http-nio-8080-exec-1&quot; #30 daemon prio=5 os_prio=31 tid=0x00007fb2a94c3000 nid=0x5c03 runnable [0x0000700009cae000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">    at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</span><br><span class="line">    at java.net.SocketInputStream.read(SocketInputStream.java:171)</span><br><span class="line">    at java.net.SocketInputStream.read(SocketInputStream.java:141)</span><br><span class="line">    at com.mysql.cj.protocol.ReadAheadInputStream.fill(ReadAheadInputStream.java:107)</span><br><span class="line">    at com.mysql.cj.protocol.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:150)</span><br><span class="line">    at com.mysql.cj.protocol.ReadAheadInputStream.read(ReadAheadInputStream.java:180)</span><br><span class="line">    - locked &lt;0x0000000740afa5e0&gt; (a com.mysql.cj.protocol.ReadAheadInputStream)</span><br><span class="line">    at java.io.FilterInputStream.read(FilterInputStream.java:133)</span><br><span class="line">    at com.mysql.cj.protocol.FullReadInputStream.readFully(FullReadInputStream.java:64)</span><br><span class="line">    at com.mysql.cj.protocol.a.SimplePacketReader.readHeader(SimplePacketReader.java:63)</span><br><span class="line">    at com.mysql.cj.protocol.a.SimplePacketReader.readHeader(SimplePacketReader.java:45)</span><br><span class="line">    at com.mysql.cj.protocol.a.TimeTrackingPacketReader.readHeader(TimeTrackingPacketReader.java:52)</span><br><span class="line">    at com.mysql.cj.protocol.a.TimeTrackingPacketReader.readHeader(TimeTrackingPacketReader.java:41)</span><br><span class="line">    at com.mysql.cj.protocol.a.MultiPacketReader.readHeader(MultiPacketReader.java:54)</span><br><span class="line">    at com.mysql.cj.protocol.a.MultiPacketReader.readHeader(MultiPacketReader.java:44)</span><br><span class="line">    at com.mysql.cj.protocol.a.NativeProtocol.readMessage(NativeProtocol.java:549)</span><br><span class="line">    at com.mysql.cj.protocol.a.NativeProtocol.checkErrorMessage(NativeProtocol.java:725)</span><br><span class="line">    at com.mysql.cj.protocol.a.NativeProtocol.sendCommand(NativeProtocol.java:664)</span><br><span class="line">    at com.mysql.cj.protocol.a.NativeProtocol.sendQueryPacket(NativeProtocol.java:979)</span><br><span class="line">    at com.mysql.cj.protocol.a.NativeProtocol.sendQueryString(NativeProtocol.java:914)</span><br><span class="line">    at com.mysql.cj.NativeSession.execSQL(NativeSession.java:1150)</span><br><span class="line">    at com.mysql.cj.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:2064)</span><br><span class="line">    - locked &lt;0x0000000740a6e9e8&gt; (a com.mysql.cj.jdbc.ConnectionImpl)</span><br><span class="line">    at com.zaxxer.hikari.pool.ProxyConnection.setAutoCommit(ProxyConnection.java:388)</span><br><span class="line">    at com.zaxxer.hikari.pool.HikariProxyConnection.setAutoCommit(HikariProxyConnection.java)</span><br><span class="line">    at org.hibernate.resource.jdbc.internal.AbstractLogicalConnectionImplementor.begin(AbstractLogicalConnectionImplementor.java:67)</span><br><span class="line">    at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.begin(LogicalConnectionManagedImpl.java:263)</span><br><span class="line">    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl$TransactionDriverControlImpl.begin(JdbcResourceLocalTransactionCoordinatorImpl.java:236)</span><br><span class="line">    at org.hibernate.engine.transaction.internal.TransactionImpl.begin(TransactionImpl.java:80)</span><br><span class="line">    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.beginTransaction(HibernateJpaDialect.java:183)</span><br><span class="line">    at org.springframework.orm.jpa.JpaTransactionManager.doBegin(JpaTransactionManager.java:401)</span><br><span class="line">    at org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(AbstractPlatformTransactionManager.java:378)</span><br><span class="line">    at org.springframework.transaction.interceptor.TransactionAspectSupport.createTransactionIfNecessary(TransactionAspectSupport.java:474)</span><br><span class="line">    at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:289)</span><br><span class="line">    at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:98)</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">    at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:139)</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">    at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:135)</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">    at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:93)</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">    at org.springframework.data.repository.core.support.SurroundingTransactionDetectorMethodInterceptor.invoke(SurroundingTransactionDetectorMethodInterceptor.java:61)</span><br><span class="line">    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212)</span><br><span class="line">    at com.sun.proxy.$Proxy79.save(Unknown Source)</span><br><span class="line">    at com.lifeStory.study.test.TestThreadLongTimeRun.longTimeRun(TestThreadLongTimeRun.java:20)</span><br><span class="line">    at com.lifeStory.study.controller.TestController.testThreadRunTooLong(TestController.java:26)</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">    at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">    at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:189)</span><br><span class="line">    at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:138)</span><br><span class="line">    at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:102)</span><br><span class="line">    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:895)</span><br><span class="line">    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:800)</span><br><span class="line">    at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)</span><br><span class="line">    at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1038)</span><br><span class="line">    at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:942)</span><br><span class="line">    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1005)</span><br><span class="line">    at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:897)</span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:634)</span><br><span class="line">    at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:882)</span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:741)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)</span><br><span class="line">    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:92)</span><br><span class="line">    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:93)</span><br><span class="line">    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:200)</span><br><span class="line">    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)</span><br><span class="line">    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><br><span class="line">    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:490)</span><br><span class="line">    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:139)</span><br><span class="line">    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)</span><br><span class="line">    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)</span><br><span class="line">    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)</span><br><span class="line">    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:408)</span><br><span class="line">    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:834)</span><br><span class="line">    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1417)</span><br><span class="line">    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">    - locked &lt;0x00000007a2ba9450&gt; (a org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>
<p>在没有异常的情况下看看线程栈，也是个很爽的事情不是。</p>
<h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jmap -h</span><br><span class="line">Usage:</span><br><span class="line">    jmap [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jmap [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               to print same info as Solaris pmap</span><br><span class="line">    -heap                to print java heap summary</span><br><span class="line">    -histo[:live]        to print histogram of java object heap; if the &quot;live&quot;</span><br><span class="line">                         suboption is specified, only count live objects</span><br><span class="line">    -clstats             to print class loader statistics</span><br><span class="line">    -finalizerinfo       to print information on objects awaiting finalization</span><br><span class="line">    -dump:&lt;dump-options&gt; to dump java heap in hprof binary format</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         dump only live objects; if not specified,</span><br><span class="line">                                        all objects in the heap are dumped.</span><br><span class="line">                           format=b     binary format</span><br><span class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt;</span><br><span class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</span><br><span class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</span><br><span class="line">                         respond. The &quot;live&quot; suboption is not supported</span><br><span class="line">                         in this mode.</span><br><span class="line">    -h | -help           to print this help message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br></pre></td></tr></table></figure>
<p>前面讲的几个dump内存的方法，其中一个就是jmap导出。那么具体怎么操作呢？</p>
<p>我们启动一个Spring Boot服务，试用一下jmap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jmap -heap 9527</span><br><span class="line">Attaching to process ID 9527, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.	// 使用了Thread Local Allocation Buffer</span><br><span class="line">Parallel GC with 4 thread(s)	</span><br><span class="line">// JDK1.8 默认-XX:+UseParallelGC，即Parallel Scavenge + Parallel Old</span><br><span class="line">// 可以用jinfo pid或者java -XX:+PrintCommandLineFlags -version查看</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 2147483648 (2048.0MB)</span><br><span class="line">   NewSize                  = 44564480 (42.5MB)</span><br><span class="line">   MaxNewSize               = 715653120 (682.5MB)</span><br><span class="line">   OldSize                  = 89653248 (85.5MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)	// 启动了G1垃圾收集器后会大有不同</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 187695104 (179.0MB)</span><br><span class="line">   used     = 43869272 (41.836997985839844MB)</span><br><span class="line">   free     = 143825832 (137.16300201416016MB)</span><br><span class="line">   23.372624573094885% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 14680064 (14.0MB)</span><br><span class="line">   used     = 14670504 (13.990882873535156MB)</span><br><span class="line">   free     = 9560 (0.00911712646484375MB)</span><br><span class="line">   99.93487766810826% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 18350080 (17.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 18350080 (17.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 90701824 (86.5MB)</span><br><span class="line">   used     = 24615232 (23.47491455078125MB)</span><br><span class="line">   free     = 66086592 (63.02508544921875MB)</span><br><span class="line">   27.138629538475435% used</span><br><span class="line"></span><br><span class="line">22509 interned Strings occupying 2756384 bytes.	// 字符串常量池占比</span><br></pre></td></tr></table></figure>
<p>在启用了G1的JVM上这个输出结果有一定变化，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jmap -heap 91204</span><br><span class="line">Attaching to process ID 91204, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Garbage-First (G1) GC with 4 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 40</span><br><span class="line">   MaxHeapFreeRatio         = 70</span><br><span class="line">   MaxHeapSize              = 2147483648 (2048.0MB)</span><br><span class="line">   NewSize                  = 1363144 (1.2999954223632812MB)</span><br><span class="line">   MaxNewSize               = 1287651328 (1228.0MB)</span><br><span class="line">   OldSize                  = 5452592 (5.1999969482421875MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 1048576 (1.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">G1 Heap:</span><br><span class="line">   regions  = 2048</span><br><span class="line">   capacity = 2147483648 (2048.0MB)</span><br><span class="line">   used     = 40702448 (38.81687927246094MB)</span><br><span class="line">   free     = 2106781200 (2009.183120727539MB)</span><br><span class="line">   1.8953554332256317% used</span><br><span class="line">G1 Young Generation:</span><br><span class="line">Eden Space:</span><br><span class="line">   regions  = 5		// 也可以看出Eden区是按需将region标记为eden的</span><br><span class="line">   capacity = 73400320 (70.0MB)</span><br><span class="line">   used     = 5242880 (5.0MB)</span><br><span class="line">   free     = 68157440 (65.0MB)</span><br><span class="line">   7.142857142857143% used</span><br><span class="line">Survivor Space:</span><br><span class="line">   regions  = 10	// 所以eden的region竟然比</span><br><span class="line">   capacity = 10485760 (10.0MB)</span><br><span class="line">   used     = 10485760 (10.0MB)</span><br><span class="line">   free     = 0 (0.0MB)</span><br><span class="line">   100.0% used</span><br><span class="line">G1 Old Generation:</span><br><span class="line">   regions  = 24</span><br><span class="line">   capacity = 50331648 (48.0MB)</span><br><span class="line">   used     = 24973808 (23.816879272460938MB)</span><br><span class="line">   free     = 25357840 (24.183120727539062MB)</span><br><span class="line">   49.61849848429362% used</span><br><span class="line"></span><br><span class="line">22611 interned Strings occupying 2766112 bytes.</span><br></pre></td></tr></table></figure>
<p>具体含义就不解释了。</p>
<p>第二个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jmap -histo:live 91204 | less</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:         59859        8873752  [C</span><br><span class="line">   2:         18168        1598784  java.lang.reflect.Method</span><br><span class="line">   3:         58970        1415280  java.lang.String</span><br><span class="line">   4:         11160        1235200  java.lang.Class</span><br><span class="line">   5:         26752         856064  java.util.concurrent.ConcurrentHashMap$Node</span><br><span class="line">   6:          2739         628944  [B</span><br><span class="line">   7:         10297         586104  [Ljava.lang.Object;</span><br><span class="line">   8:         15701         502432  java.util.HashMap$Node</span><br><span class="line">   9:          5064         436984  [Ljava.util.HashMap$Node;</span><br><span class="line">  10:         19116         424272  [Ljava.lang.Class;</span><br></pre></td></tr></table></figure>
<p>感觉很爽是不是，哈哈。不加live会把已死亡对象也输出出来，格式是一样的。就不赘述了。</p>
<p>然后来试一下保存内存镜像的命令。我们来写个非常简单的任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SlowInfinityLoop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;ABC&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> ABC());</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABC</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = UUID.randomUUID().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行时加参数<code>-Xms20m -Xmx20m</code>，起来后这么操作一番：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jps</span><br><span class="line">24402</span><br><span class="line">24778 Launcher</span><br><span class="line">24780 Jps</span><br><span class="line"></span><br><span class="line">&gt; ~ jmap -heap 24794</span><br><span class="line">Attaching to process ID 24794, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 8 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 20971520 (20.0MB)</span><br><span class="line">   NewSize                  = 6815744 (6.5MB)</span><br><span class="line">   MaxNewSize               = 6815744 (6.5MB)</span><br><span class="line">   OldSize                  = 14155776 (13.5MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 5767168 (5.5MB)</span><br><span class="line">   used     = 2119584 (2.021392822265625MB)</span><br><span class="line">   free     = 3647584 (3.478607177734375MB)</span><br><span class="line">   36.75259676846591% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 524288 (0.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 524288 (0.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 524288 (0.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 524288 (0.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 14155776 (13.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 14155776 (13.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line"></span><br><span class="line">2485 interned Strings occupying 181464 bytes.</span><br><span class="line"></span><br><span class="line">&gt; ~ jmap -dump:live,format=b,file=Desktop/heap.bin 24794	// 相对路径</span><br><span class="line">Dumping heap to ~/Desktop/heap.bin ...</span><br><span class="line">Heap dump file created</span><br><span class="line"></span><br><span class="line">&gt; ~ jhat ~/Desktop/heap.bin</span><br><span class="line">Reading from ~/Desktop/heap.bin...</span><br><span class="line">Dump file created Sat Aug 17 17:40:52 CST 2019</span><br><span class="line">Snapshot read, resolving...</span><br><span class="line">Resolving 15335 objects...</span><br><span class="line">Chasing references, expect 3 dots...</span><br><span class="line">Eliminating duplicate references...</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 7000</span><br><span class="line">Server is ready.</span><br></pre></td></tr></table></figure>
<h4 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h4><p>dump内存我们已经玩得可以了，接下来就是如何分析内存里有什么。jhat是个非常方便的工具，能够用来分析内存dump文件里的对象信息。我们就以上例中的<code>heap.bin</code>文件为例进行分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jhat -h</span><br><span class="line">Usage:  jhat [-stack &lt;bool&gt;] [-refs &lt;bool&gt;] [-port &lt;port&gt;] [-baseline &lt;file&gt;] [-debug &lt;int&gt;] [-version] [-h|-help] &lt;file&gt;</span><br><span class="line"></span><br><span class="line">	-J&lt;flag&gt;          Pass &lt;flag&gt; directly to the runtime system. For</span><br><span class="line">			  example, -J-mx512m to use a maximum heap size of 512MB</span><br><span class="line">	-stack false:     Turn off tracking object allocation call stack.</span><br><span class="line">	-refs false:      Turn off tracking of references to objects</span><br><span class="line">	-port &lt;port&gt;:     Set the port for the HTTP server.  Defaults to 7000</span><br><span class="line">	-exclude &lt;file&gt;:  Specify a file that lists data members that should</span><br><span class="line">			  be excluded from the reachableFrom query.</span><br><span class="line">	-baseline &lt;file&gt;: Specify a baseline object dump.  Objects in</span><br><span class="line">			  both heap dumps with the same ID and same class will</span><br><span class="line">			  be marked as not being &quot;new&quot;.</span><br><span class="line">	-debug &lt;int&gt;:     Set debug level.</span><br><span class="line">			    0:  No debug output</span><br><span class="line">			    1:  Debug hprof file parsing</span><br><span class="line">			    2:  Debug hprof file parsing, no server</span><br><span class="line">	-version          Report version number</span><br><span class="line">	-h|-help          Print this help and exit</span><br><span class="line">	&lt;file&gt;            The file to read</span><br><span class="line"></span><br><span class="line">For a dump file that contains multiple heap dumps,</span><br><span class="line">you may specify which dump in the file</span><br><span class="line">by appending &quot;#&lt;number&gt;&quot; to the file name, i.e. &quot;foo.hprof#3&quot;.</span><br><span class="line"></span><br><span class="line">All boolean options default to &quot;true&quot;</span><br></pre></td></tr></table></figure>
<p>设置项很多，感觉比较有用的是<code>-execlude</code>和<code>-bashline</code>，其他的暂时没看出有多少用。</p>
<p>随便跑一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jhat ~/Desktop/heap.bin</span><br><span class="line">Reading from /Users/mateng/Desktop/heap.bin...</span><br><span class="line">Dump file created Sat Aug 17 17:40:52 CST 2019</span><br><span class="line">Snapshot read, resolving...</span><br><span class="line">Resolving 15335 objects...</span><br><span class="line">Chasing references, expect 3 dots...</span><br><span class="line">Eliminating duplicate references...</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 7000</span><br><span class="line">Server is ready.</span><br></pre></td></tr></table></figure>
<p>登陆<code>localhost:7000</code>，如下：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-jhat-20190818.jpg" alt="JVM-jhat-20190818.jpg"></p>
<p>然后我们点击我们想观察的<code>ABC</code>这个类：</p>
<p>输出中大部分自己看一看含义就好，然后我们使劲往下翻。找到</p>
<blockquote>
<h2 id="Other-Queries"><a href="#Other-Queries" class="headerlink" title="Other Queries"></a>Other Queries</h2><p>Reference Chains from Rootset</p>
<ul>
<li><a href="http://localhost:7000/roots/0x7bec73328" target="_blank" rel="noopener">Exclude weak refs</a></li>
<li><a href="http://localhost:7000/allRoots/0x7bec73328" target="_blank" rel="noopener">Include weak refs</a></li>
</ul>
<p><a href="http://localhost:7000/reachableFrom/0x7bec73328" target="_blank" rel="noopener">Objects reachable from here</a></p>
</blockquote>
<p>点Exclude weak refs，然后再往下翻，找到下面这一块。</p>
<p>可以看到不同的线程对于这个类的实例的持有状况。</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-jhat-local-references-20190818.png" alt="JVM-jhat-local-references-20190818.png"></p>
<p>可以确认第一个线程是main线程（直接点线程的超链就能看到线程的详细信息，其中有name）。那我们现在就不管了，我们可以看清楚，就是一个ArrayList持有了ABC的实例。这个比较好的就是能查看引用链条，方便看是哪里发生了内存泄露。</p>
<p>然后我们再回到最开始的页面，点<code>Show instance counts for all classes (excluding platform)</code>这个链接，可以看到下面的显示。</p>
<blockquote>
<p>Instance Counts for All Classes (excluding platform)</p>
<p>752 <code>instances</code> of class <code>com.lifeStory.study.ABC</code><br>0 <code>instances</code> of class <code>com.lifeStory.study.SlowInfinityLoop</code></p>
</blockquote>
<p>这个在排查OOM时还比较有用，比如说我们一个线上项目OOM后dump出来的文件显示结果如下：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-jhat-OOM-20190818.png" alt="JVM-jhat-OOM-20190818.png"></p>
<p>其中实例最多的都是fuseki的库，实际上这些对象我们只用了一小会，之后都不用了，但没有释放，显然是代码中相关作用域出问题了。修改之就可以了。</p>
<p>另外提示一下，分析堆的dump文件很耗内存，而且很耗时。上面这个文件，16G的堆文件，jhat在一台服务器上执行，吃了顿饭回来还等了一小会才分析完毕。</p>
<h4 id="VisualVM"><a href="#VisualVM" class="headerlink" title="VisualVM"></a>VisualVM</h4><p>照例来一发help</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; ~ jvisualvm -h</span><br><span class="line">Usage: /Library/Java/JavaVirtualMachines/jdk1.8.0_131.jdk/Contents/Home/lib/visualvm/platform/lib/nbexec &#123;options&#125; arguments</span><br><span class="line"></span><br><span class="line">General options:</span><br><span class="line">  --help                show this help</span><br><span class="line">  --jdkhome &lt;path&gt;      path to Java(TM) 2 SDK, Standard Edition</span><br><span class="line">  -J&lt;jvm_option&gt;        pass &lt;jvm_option&gt; to JVM</span><br><span class="line"></span><br><span class="line">  --cp:p &lt;classpath&gt;    prepend &lt;classpath&gt; to classpath</span><br><span class="line">  --cp:a &lt;classpath&gt;    append &lt;classpath&gt; to classpath</span><br><span class="line">Module reload options:</span><br><span class="line">  --reload /path/to/module.jar  install or reinstall a module JAR file</span><br><span class="line"></span><br><span class="line">其他模块选项:</span><br><span class="line">  --modules</span><br><span class="line">  --refresh                 刷新所有目录</span><br><span class="line">  --list                    打印所有模块, 模块版本和启用状态的列表</span><br><span class="line">  --install &lt;arg1&gt;...&lt;argN&gt; 将提供的 JAR 文件作为模块安装</span><br><span class="line">  --disable &lt;arg1&gt;...&lt;argN&gt; 禁用指定代码库名称的模块</span><br><span class="line">  --enable &lt;arg1&gt;...&lt;argN&gt;  启用指定代码库名称的模块</span><br><span class="line">  --update &lt;arg1&gt;...&lt;argN&gt;  更新所有模块或指定的模块</span><br><span class="line">  --update-all              更新所有模块</span><br><span class="line">  --extra-uc &lt;arg&gt;          添加额外的更新中心 (URL)</span><br><span class="line">  --openfile &lt;arg&gt;          打开由 &lt;arg&gt; 指定的文件，该文件可能是应用程序快照、NetBeans Profiler 快照或 HPROF 堆 dump。</span><br><span class="line">  --openjmx &lt;arg&gt;           打开 JMX 连接 (主机:端口) 指定的应用程序</span><br><span class="line">  --openpid &lt;arg&gt;           打开进程 id 为 &lt;arg&gt; 的应用程序</span><br><span class="line">  --openid &lt;arg&gt;            打开 id 为 &lt;arg&gt; 的应用程序</span><br><span class="line"></span><br><span class="line">Core options:</span><br><span class="line">  --laf &lt;LaF classname&gt; use given LookAndFeel class instead of the default</span><br><span class="line">  --fontsize &lt;size&gt;     set the base font size of the user interface, in points</span><br><span class="line">  --locale &lt;language[:country[:variant]]&gt; use specified locale</span><br><span class="line">  --userdir &lt;path&gt;      use specified directory to store user settings</span><br><span class="line">  --cachedir &lt;path&gt;     use specified directory to store user cache, must be different from userdir</span><br><span class="line">  --nosplash            do not show the splash screen</span><br></pre></td></tr></table></figure>
<p>因为visualVM是插件化的，装一堆插件上去会有很多功能。但暂时没有时间研究，就用最基本的就好了，最基本的用法在这里，注意这个应该是基于JDK1.8以下的版本：</p>
<p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-visualvm/index.html" target="_blank" rel="noopener">使用 VisualVM 进行性能分析及调优</a>，看起来也不不难，基础知识上面已经有了。</p>
<h3 id="学会看GC日志"><a href="#学会看GC日志" class="headerlink" title="学会看GC日志"></a>学会看GC日志</h3><p>不同的垃圾收集器输出的日志不是完全一样的，但基本格式都差不太多，可以使用<code>-XX:+PrintGCDetails</code>参数来打开JVM的GC日志（堆内存上下限都设为20m），比如上面的<code>SlowInfinityLoop</code>，打开日志后输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 5632K-&gt;496K(6144K)] 5632K-&gt;956K(19968K), 0.0029640 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] </span><br><span class="line"><span class="meta">#</span><span class="bash"> 省略28行基本一致的输出，Full GC是第29行</span></span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 480K-&gt;0K(4608K)] [ParOldGen: 13214K-&gt;11473K(13824K)] 13694K-&gt;11473K(18432K), [Metaspace: 8059K-&gt;8038K(1056768K)], 0.0417188 secs] [Times: user=0.23 sys=0.00, real=0.04 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 3072K-&gt;384K(4608K)] 14545K-&gt;11857K(18432K), 0.0012428 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </span><br><span class="line"><span class="meta">#</span><span class="bash"> 6次类似的输出，下面的Full GC是第36行</span></span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 448K-&gt;0K(5632K)] [ParOldGen: 13297K-&gt;13533K(13824K)] 13745K-&gt;13533K(19456K), [Metaspace: 8038K-&gt;8038K(1056768K)], 0.0230733 secs] [Times: user=0.17 sys=0.00, real=0.02 secs] </span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后全部都是Full GC，总共到1864行，而且越到后来速度FullGC的间隔时间越短</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面这一次Full GC直接是eden区不够引起的，但是已经没可回收的内存了</span></span><br><span class="line">[Full GC (Allocation Failure) [PSYoungGen: 4096K-&gt;4096K(5632K)] [ParOldGen: 13823K-&gt;13823K(13824K)] 17919K-&gt;17919K(19456K), [Metaspace: 8038K-&gt;8038K(1056768K)], 0.0250757 secs] [Times: user=0.16 sys=0.00, real=0.02 secs] </span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时已经OOM了，跳出了循环，再进行了一次Full GC，可以看到堆内存基本被清空了。</span></span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 4096K-&gt;0K(5632K)] [ParOldGen: 13823K-&gt;1364K(13824K)] 17919K-&gt;1364K(19456K), [Metaspace: 8038K-&gt;8038K(1056768K)], 0.0087641 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] </span><br><span class="line"><span class="meta">#</span><span class="bash"> 打出了堆信息</span></span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 5632K, used 185K [0x00000007bf980000, 0x00000007c0000000, 0x00000007c0000000)</span><br><span class="line">  eden space 4096K, 4% used [0x00000007bf980000,0x00000007bf9ae638,0x00000007bfd80000)</span><br><span class="line">  from space 1536K, 0% used [0x00000007bfe80000,0x00000007bfe80000,0x00000007c0000000)</span><br><span class="line">  to   space 1024K, 0% used [0x00000007bfd80000,0x00000007bfd80000,0x00000007bfe80000)</span><br><span class="line"> ParOldGen       total 13824K, used 1364K [0x00000007bec00000, 0x00000007bf980000, 0x00000007bf980000)</span><br><span class="line">  object space 13824K, 9% used [0x00000007bec00000,0x00000007bed551d0,0x00000007bf980000)</span><br><span class="line"> Metaspace       used 8051K, capacity 8188K, committed 8448K, reserved 1056768K</span><br><span class="line">  class space    used 939K, capacity 984K, committed 1024K, reserved 1048576K</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打出了异常栈信息</span></span><br><span class="line">Exception in thread "main" java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">	at java.util.Arrays.copyOf(Arrays.java:3332)</span><br><span class="line">	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)</span><br><span class="line">	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:448)</span><br><span class="line">	at java.lang.StringBuilder.append(StringBuilder.java:136)</span><br><span class="line">	at java.util.UUID.toString(UUID.java:380)</span><br><span class="line">	at com.lifeStory.study.ABC.&lt;init&gt;(SlowInfinityLoop.java:21)</span><br><span class="line">	at com.lifeStory.study.SlowInfinityLoop.main(SlowInfinityLoop.java:13)</span><br></pre></td></tr></table></figure>
<p>以上面为例，GC的日志一般是这样的：</p>
<p>先输出这次是YGC还是FGC，之后输出GC发生的原因，之后输出此次GC所使用的垃圾收集器以及GC后内存的变化情况，之后输出这次GC消耗的时间。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 5632K-&gt;496K(6144K)] 5632K-&gt;956K(19968K), 0.0029640 secs] [Times: user=0.01 sys=0.01, real=0.00 secs]</span><br></pre></td></tr></table></figure>
<p>GC指这次发生了<code>Young GC</code>，<code>Allocation Failure</code>指的是Eden区内存不够分配对象了，<code>PSYoungGen</code>是指使用的是<code>Parallel Svavenge</code>垃圾收集器，</p>
<p><code>PSYoungGen: 5632K-&gt;496K(6144K)</code>是指这次被回收的区前后内存的变化，格式是：<code>回收前内存-&gt;回收后内存(该区域总内存)</code></p>
<p>方括号外面的<code>5632K-&gt;956K(19968K)</code>是指，回收前堆内存、回收后堆内存，堆总内存。</p>
<p>之后消耗的时间。</p>
<p>我们这个进程运行起来后，用visualVM观察堆使用状况，如下图：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-visualVM-heapusage-loop-20190818.png" alt="JVM-visualVM-heapusage-loop-20190818.png"></p>
<p>有意思的是，明明我们这个代码看起来没什么可回收的了，就是一直在add，从没释放过什么东西，为啥这个还回收了这么多东西呢？另外，最后曲线趋向于平缓，又是什么阶段？</p>
<p>首先我们来看一下内存的详细情况：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-visualVM-heapDetails-loop-20190818.png" alt="JVM-visualVM-heapDetails-loop-20190818.png"></p>
<p>如果从进程一开始就盯着的话，会发现这个char[]一直在变来变去，每次GC他都少一大截。如果仔细追踪代码，会发现是UUID包内部使用的一个玩意。</p>
<p>至于最后的平稳阶段，是因为内存真的退无可退了，一直在疯狂FGC。</p>
<h3 id="题外话：OOM可以被catch"><a href="#题外话：OOM可以被catch" class="headerlink" title="题外话：OOM可以被catch"></a>题外话：OOM可以被catch</h3><p>只是没什么好的理由的话，为什么要catch Error？</p>
<h2 id="JVM与Container"><a href="#JVM与Container" class="headerlink" title="JVM与Container"></a>JVM与Container</h2><h3 id="内存到底怎么回事"><a href="#内存到底怎么回事" class="headerlink" title="内存到底怎么回事"></a>内存到底怎么回事</h3><p>之前在分析我们的一些业务代码时发现了一个小问题，那就是运行在docker容器里的JVM似乎并不能感知到K8S对于硬件资源的限制，因此在未手动指定堆大小的时候，默认会使用物理机的1/4作为堆的最大内存，1/64作为堆的初始化内存，这显然不是我们要的效果。</p>
<p>那么这个问题怎么解决，参考以下这两篇文章：</p>
<p><a href="https://medium.com/adorsys/jvm-memory-settings-in-a-container-environment-64b0840e1d9e" target="_blank" rel="noopener">JVM Memory Settings in a Container Environment</a></p>
<p><a href="https://merikan.com/2019/04/jvm-in-a-container/" target="_blank" rel="noopener">JVM in a Container</a></p>
<p>大概的解释就是，在JDK1.8_131以后，JVM增加了一个实验特性，可以感知container的硬件限制了，一般来说，需要做以下设置：<code>-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2</code>，三个参数同时上。但这仍然存在很大的资源浪费，会浪费一半的container内存，内存越大浪费越严重。</p>
<p>在JDK1.8_131之前，或者在JDK1.8_131之后但不愿意浪费一半内存的，可以使用Docker的EntryPoint特性，构造一个这样的EntryPoint</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> -XX:MaxRAM to 70% of the cgroup <span class="built_in">limit</span></span></span><br><span class="line">docker run --rm -m 1g openjdk:8-jdk </span><br><span class="line">	sh -c 'exec java -XX:MaxRAM=$(( $(cat /sys/fs/cgroup/memory/memory.limit_in_bytes) * 100 / 70 )) -XX:+PrintFlagsFinal -version'</span><br></pre></td></tr></table></figure>
<p>实际是手动读取了容器对硬件资源的限制，之后自己做了一个设置。</p>
<p>而在更高级别的JDK（实测JDK1.8_191即可，更低版本未测试），则可以使用以下参数：</p>
<p><code>-XX:+UseContainerSupport -XX:MaxRAMPercentage=70.00</code>，就能设置JVM使用container70%的内存。</p>
<p>下面我们用docker测一下，首先为了控制版本，我们先吧openjdk的tag打出来，虽然docker本身没有提供搜索tag的功能，但是官方给出了一个小脚本，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i=0</span><br><span class="line"></span><br><span class="line">while [ $? == 0 ]</span><br><span class="line">do</span><br><span class="line">   i=$((i+1))</span><br><span class="line">   curl https://registry.hub.docker.com/v2/repositories/library/$1/tags/?page=$i 2&gt;/dev/null|jq '."results"[]["name"]'</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>运行一下，要等很久才能输出所有结果，总共有2482行，查看一下，然后运行其中一个选定的版本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试一下 131</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不加相关参数，可见堆内存并没有受到300M的限制，至于为啥是444.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是因为mac下的docker Desktop自己限制了自己用2G内存，而java默认用1/4</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~  docker run --rm -it -m 300M openjdk:8u131-alpine java -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 444.50M</span><br><span class="line">		// 之后还有部分输出省略，下同。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一种方式</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 300M openjdk:8u131-alpine java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2 -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 133.50M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 131不支持UseContainerSupport参数</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 300M openjdk:8u131-alpine java -XX:+UseContainerSupport -XX:MaxRAMPercentage=70.00 -XshowSettings:vm -version</span></span><br><span class="line">Unrecognized VM option 'UseContainerSupport'</span><br><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">Error: A fatal exception has occurred. Program will exit.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试一下181</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 什么都不加</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it openjdk:8u181-alpine java -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 444.50M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上内存限制，可见似乎181已经可以自己感知container内存大小了，但并不是1/4，看起来是有最小值</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 300M openjdk:8u181-alpine java -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 121.81M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上实验特性，还是会接受设置，确实用了1/2</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 300M openjdk:8u181-alpine java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2 -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 145.00M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 确实用了70%</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 300M openjdk:8u181-alpine java -XX:+UseContainerSupport -XX:MaxRAMPercentage=70.00 -XshowSettings:vm -version</span></span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size (Estimated): 203.00M</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 191效果与181完全相同</span></span><br></pre></td></tr></table></figure>
<h3 id="版本到底怎么回事"><a href="#版本到底怎么回事" class="headerlink" title="版本到底怎么回事"></a>版本到底怎么回事</h3><p>看docker openjdk的tag，茫茫多，总共2482个，而且很多tag看起来非常接近：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;8-alpine3.9&quot;</span><br><span class="line">&quot;8-alpine&quot;</span><br><span class="line">&quot;8-alpine3.8&quot;</span><br><span class="line">&quot;8u181-jre&quot;</span><br><span class="line">&quot;8u181&quot;</span><br><span class="line">&quot;8u181-jdk&quot;</span><br><span class="line">&quot;8u181-jdk-alpine&quot;</span><br><span class="line">&quot;8u181-jre-alpine&quot;</span><br><span class="line">&quot;8u181-jre-alpine3.8&quot;</span><br><span class="line">&quot;8u181-jdk-alpine3.8&quot;</span><br></pre></td></tr></table></figure>
<p>以上只展示了8的一小部分，看起来其命名基本上是<code>大版本号[小版本号]-[jdk|jre]-baseos[版本]</code></p>
<p>如果不指定小版本号，那么会使用最新的镜像，显然是会不断变化的，于是我们没法精确控制这个版本，虽然说相同的大版本应该向后兼容，但是保持开发环境和部署环境的一致还是非常重要的，因此最好明确指定版本号，比如<code>8u131</code>这样的。</p>
<p>而jdk和jre的区别，是jre只有java runtime环境，体积会比JDK小一点，但是jmap这样的调试工具就一概没有了。个人认为还是JDK+精确版本控制比较好。</p>
<p>至于baseOS，一般能用alpine就用他，因为非常精简，能控制镜像体积。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/05/07/JVM调试工具使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-从进程的角度再探Java内存" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/27/从进程的角度再探Java内存/">从进程的角度再探Java内存</a>
    </h1>
  

        
        <a href="/2020/04/27/从进程的角度再探Java内存/" class="archive-article-date">
  	<time datetime="2020-04-27T06:00:13.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-04-27</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="从进程的角度再探Java内存"><a href="#从进程的角度再探Java内存" class="headerlink" title="从进程的角度再探Java内存"></a>从进程的角度再探Java内存</h1><p><code>Java</code>的内存模型大家都很熟悉了，比如运行时内存分为：线程栈、本地方法栈、程序计数器、方法区、运行时常量池、堆、本地内存。堆又进一步分为新生代、老年代，新生代又进一步分为eden区和两个survivor区，方法区在JDK1.7之前的hotspot虚拟机的实现中用的是永生代这个概念，但在JDK1.8以后挪到了本地内存空间中去，其他的虚拟机实现比如JRocket一直没有永生代这个概念。</p>
<p>但同样广为人知的是，Java虚拟机不过是操作系统的一个进程而已。在操作系统看来，这个进程和其他进程并没有什么本质的区别。假设这个虚拟机当前运行在Linux系统中，那么经典的内存分页、交换空间、虚拟内存空间模型，是不是应该还是适用于这个虚拟机。</p>
<p>于是引发了很多思考：</p>
<ol>
<li><p>经典的Linux进程的内存模型，也有堆和栈的概念，这里的堆和栈，和Java运行时内存空间的堆和栈是什么关系？Java运行时内存中的<code>本地内存</code>，到底又和Linux经典内存模型中的哪一部分对应？</p>
</li>
<li><p>一个Java进程，能不能申请比物理内存更大的堆空间？如果能，他实际占用的物理内存是多大？</p>
</li>
<li><p>Java有OOM错误，操作系统也有OOM错误，这两者之间有什么关系？两者在导致进程死亡上到底有哪些不同？</p>
</li>
<li><p>如果再引入一个变量：docker，则问题就更有意思一点。docker daemon只是操作系统的一个进程这个毫无疑问，但是每一个启动起来的container，在操作系统看来又是以什么形态存在的呢？在docker中运行的JVM到底能使用多大的内存，能不能利用经典Linux内存模型中的换页机制？如果超出了docker的内存限制，这时候JVM进程到底是被谁杀死？是docker daemon、操作系统，还是JVM主动停止。</p>
<p>对这个问题我们可以设想一个场景，在一个物理内存为16G的机器上，启动了一个内存限制为2G的docker，JVM的堆大小能不能设置成3G？假如能，是不是真的能申请到3G内存？假如不能，这个docker里运行的JVM最大能使用多大的堆？超出了会触发谁的OOM机制？</p>
</li>
</ol>
<p>往往是复杂的问题让人兴奋，抽丝剥茧，看到纷繁表象下奔腾在电路板上的二进制洪流。那一刻的光芒，是蔷薇园里最好的一滴晨露，是草原上金线勾勒的鬓角，是中庭下樱花一点的绛唇，是一个程序员的高光时刻。</p>
<h2 id="经典的Linux内存模型简介"><a href="#经典的Linux内存模型简介" class="headerlink" title="经典的Linux内存模型简介"></a>经典的Linux内存模型简介</h2><h3 id="运行时内存的几个部分"><a href="#运行时内存的几个部分" class="headerlink" title="运行时内存的几个部分"></a>运行时内存的几个部分</h3><p>翻开《程序员的自我修养》这本书第三章：可执行文件的装载与进程。其中讲到：</p>
<p>进程的<strong>虚拟内存空间</strong>中有部分留作操作系统使用，在32位的linux系统上，一般是虚拟内存空间中最高的那1G空间，而用户只能使用3G空间。而这3G空间中，又主要分为这么几块空间：</p>
<ul>
<li>代码段。就是我们的代码编译成本机可执行文件后的那个东西，也就是我们平时编译后得到的那个文件，在运行时装载到代码段。</li>
<li>数据段。这就是我们代码里的一些常量数据。比如说在代码里写<code>std:string a = &quot;hello world!&quot;</code>，这个字符串就是个常量数据，不会保存到代码段，而是放到数据段。</li>
<li>堆空间。这个堆是Linux进程内存模型中的堆，要注意区分和<code>Java</code>运行时内存模型中的堆不是一个概念，虽然他们的功能是非常接近的，就是为进程在运行时动态分配的对象提供内存空间。</li>
<li><p>栈空间。这个栈也是Linux进程内存模型中的栈，要注意区分和<code>JVM</code>内存模型中的线程栈、本地线程栈也不是完全一样，虽然他们的功能也是非常接近的，就是为进程提供一个运行栈。</p>
</li>
<li><p>其实细究起来还有很多其他的段，但和我们的讨论相关性很低，就先不管了。</p>
</li>
</ul>
<h3 id="换页机制与swap空间"><a href="#换页机制与swap空间" class="headerlink" title="换页机制与swap空间"></a>换页机制与swap空间</h3><p>只讲结果不探讨原理和为什么。</p>
<p>现代计算机系统中，每个进程看到的内存都是从0开始的，完整、连续、平坦的一块空间。在32位的linux系统中，一般每个进程都会认为自己有4G内存可以使用。进程看到的内存称之为虚拟内存，而显然这样的虚拟内存和物理内存的地址不可能是一一对应的。所以，实际上无论是物理内存还是虚拟内存，都被分为一些固定大小的页面（一般4k一个页面），内核空间中保存一个虚拟内存页到物理内存页的映射关系。因此不同进程看到的同样地址的虚拟内存，可以被映射到不同地址的物理内存中去。</p>
<p>实际上，内存管理的方式更加聪明一些，比如说虽然进程能看到4G的空间，但是他并不一定真的会用那么多，实际上很多进程就使用一点点内存。于是当这些虚拟内存没用到的时候，操作系统连虚拟内存到物理内存的映射关系都不会建立，只有当实际用到时才建立。</p>
<p>那么假如真的有一些进程就是比较占用空间，一直在申请新的内存，确实用到了很大的内存空间，这样的两三个进程，实际用到的内存空间就会超过物理内存，这时候操作系统可以将一些暂时不用的物理内存页的内容写到文件系统里面去（windows下的虚拟内存，注意区分这个虚拟内存和我们刚才讨论的虚拟内存不是一个概念，linux下的交换空间），保证当前的进程仍然可以运行。这个<strong>暂时不用</strong>，我个人的理解是严格来讲只要当前CPU执行的指令用不到的内存地址，理论上都算是暂时不用，都可以交换到文件系统里面去。</p>
<p>这样做的好处是允许系统中运行的进程能够<strong>实际使用</strong>超过物理内存的内存。这里的<strong>实际使用</strong>是指，假如说从进程的角度观察，自己可用的内存空间一直是4G，那么N个进程看到的虚拟空间地址就是$$4*N$$，肯定远远超过物理内存大小了。但他看到的这些内存空间并不一定实际使用，只有它确实在堆空间中申请了一大堆数据，这样才叫<strong>实际使用</strong>，这样的话，一个进程可能使用100M，另一个使用10M，这样很多个进程，也<strong>未必能实际使用超过物理内存的内存</strong>，在这种情况下，操作系统<strong>就不必须</strong>把物理内存交换到文件系统里去了（实际上并不是只有物理内存耗尽才交换过去，在物理内存耗尽之前，就有可能交换一部分物理内存到交换空间，原因见：<a href="https://blog.51cto.com/wutengfei/2163283" target="_blank" rel="noopener">Linux交换空间</a>）。</p>
<p>因此，即使进程实际使用的内存超过物理内存，现代操作系统也能够使用交换空间来满足需求。唯一的问题是，在文件系统进行IO是很慢的操作，和在内存里做操作慢了好几个数量级，因此应当尽量避免发生这种事情。</p>
<p>操作系统设置的交换空间也不是无限的，虽然可以设置地大一点，但肯定不可能无限制地设置。而一旦交换空间  +  物理内存仍不足以满足多个进程的<strong>实际使用</strong>时，就会出现操作系统级别的OOM。</p>
<p>发生了这种OOM错误以后，操作系统就会开始对现有的进程进行扫描，计算出一个<code>badness</code>评分，然后将评分高的一个或几个进程直接杀掉。操作系统的这个机制称为<code>OOM Killer</code>。这个评分的计算大概参考了以下几个维度：</p>
<ul>
<li>子进程内存消耗，越多越容易被选中</li>
<li>CPU密集型以及老进程，比刚启动的进程更不容易被选中</li>
<li>root启动的进程更不容易被选中</li>
<li>用户可以通过控制<code>oom_adj</code>来控制进程选中优先级（范围是-17到15，值越高越容易被杀掉，值为-17时禁止该进程被杀掉）</li>
</ul>
<h2 id="Linux运行时内存和Java运行时内存的对应关系"><a href="#Linux运行时内存和Java运行时内存的对应关系" class="headerlink" title="Linux运行时内存和Java运行时内存的对应关系"></a>Linux运行时内存和Java运行时内存的对应关系</h2><h3 id="JVM进程的堆，与Java内存模型的堆"><a href="#JVM进程的堆，与Java内存模型的堆" class="headerlink" title="JVM进程的堆，与Java内存模型的堆"></a>JVM进程的堆，与Java内存模型的堆</h3><p>最常用的<code>JVM</code>之一：OpenJDK，本身是用<code>cpp</code>写的。当该虚拟机运行起来以后，就成为操作系统的一个进程，和其他的操作系统进程相比，这个进程并没有什么特别之处。因此，从整体上观察，一个<code>JVM</code>进程的内存模型就是下面这样子：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-and-Linux-memory-20190901-01.jpg" alt="JVM与内存模型"></p>
<p>其中代码区，放的是<code>jvm</code>虚拟机的代码，数据区，放的是<code>jvm</code>虚拟机的常量数据，堆区，用来放<code>jvm</code>虚拟机申请的实例，这个装载过程是由操作系统进行的，当<code>JVM</code>虚拟机运行起来以后，虚拟机才开始进行我们熟悉的<code>JVM</code>内存的初始化。所以，当考虑到<code>JVM</code>的运行时内存状况时，一个<code>JVM</code>进程的内存是这样的：</p>
<p><img src="https://www.history-of-my-life.com/imgs-for-md/JVM-and-Linux-memory-20190901-02.jpg" alt="JVM与内存模型"></p>
<p>这个图是网上找的图，出处见参考部分，只有<code>1.7</code>及以前版本的<code>Hotspot</code>才有永久代，其他的虚拟机实现，以及<code>1.8</code>及以后的<code>Hotspot</code>虚拟机实现，都不再有永久代这个概念。不过既然已经有了这张图，我们先以这个图为例来讨论<code>JVM</code>的内存模型。</p>
<p>首先，永久代装的是JVM的方法区和运行时常量区。看起来，方法区刚好对应了传统linux内存模型中的代码区，而运行时常量池则对应了数据区。</p>
<p>其次，新生代、老年代装的是JVM在运行时为用户代码新建的对象。那么新生代 + 老年代，就对应了linux内存模型中的堆区了。</p>
<p>然后，栈本来就是按需建立的，所以JVM中的栈和linux模型中的栈基本完全对应。</p>
<p>可见，我们所熟悉的JVM内存，除程序计数器和栈以外，都建立在<code>JVM</code>这个进程的<code>堆空间</code>，这是显而易见的事情，因为所有的这些东西，都是<code>JVM</code>这个进程在运行时新建出来的对象。而<code>Java</code>内存模型中的<code>堆</code>空间，则是<code>JVM</code>虚拟机所建立的一段逻辑空间。</p>
<p>就像操作系统为每个进程建立了一个逻辑堆空间一样，<code>JVM</code>虚拟机为运行在其上的<code>java</code>代码建立了一个逻辑堆空间，所谓的永久代、新生代、老年代，都是一些数据结构所对应的逻辑空间而已。</p>
<p>这个问题想明白了，简直是醍醐灌顶，豁然开朗。</p>
<p>以前的永久代，是<code>jvm</code>这个进程在它的堆空间上分配的一段内存，它维护了这段逻辑内存与自己的进程的虚拟内存对应的一个数据结构，（没看源码的我盲猜）这个数据结构可能包含了起始地址、结束地址、最大可用空间大小等等，在<code>JVM</code>装载<code>java</code>字节码时，会将<code>class</code>文件的内容、运行时常量池放在这个部分。以前的永久代最大空间在<code>JVM</code>运行时就确定了，默认是<code>64M</code>，可以通过<code>-XX:MaxPermSize</code>来指定，当其超过了大小时，就会发生永久代溢出错误，这也是（java）的OOM错误的一种，是<code>JVM</code>主动的行为。</p>
<p>那么用元空间替代了永久代，并不是说元空间不受<code>JVM</code>这个进程的管控了，只是说<code>JVM</code>对其管理的方式不再像以前的永久代、或者堆那样管理罢了。对堆的管理可能还维护了一个可用空间、起始虚拟内存地址、结束内存地址等，但对于元空间，这部分数据结构可以不用维护了，直接在<code>JVM</code>进程的堆里面申请就完了，要是申请大了，甚至超过了物理机的内存，也没关系啊，操作系统给换页，只要不超过<code>物理内存+swap</code>的总大小就完了，因为<code>swap</code>空间一般还挺大的，一般不至于发生（操作系统级别的）OOM，但一旦因为这个部分的使用发生OOM，那就是操作系统的OOM，会导致操作系统随机杀进程。</p>
<p>所以说，所谓的用元空间代替永久代，并不是说某一块内存发生了什么神奇的变化，只是在管理这一块内存的时候，采用了一些新的概念模型，如此而已。</p>
<h3 id="第一个问题的答案"><a href="#第一个问题的答案" class="headerlink" title="第一个问题的答案"></a>第一个问题的答案</h3><p><strong>经典的Linux进程的内存模型，也有堆和栈的概念，这里的堆和栈，和Java运行时内存空间的堆和栈是什么关系？Java运行时内存中的<code>本地内存</code>，到底又和Linux经典内存模型中的哪一部分对应？</strong></p>
<p>Java内存模型中的本地内存、堆，其实都是分配在<code>Linux</code>经典内存模型中的<code>堆</code>中。</p>
<p>什么是<code>native memory</code>，翻译成本地内存、直接内存都可以。所谓的本地内存，就是<code>JVM</code>进程所使用的内存。其实我个人理解本地内存就是操作系统分配给<code>JVM</code>进程的内存，那自然从地址空间来讲，包含了java内存模型中的堆在内。只是我们在讨论时，为了理解的方便，经常将java内存模型中的堆从本地内存这个概念中独立出来。那么本地内存的作用就是：</p>
<ul>
<li><p>管理java heap的状态数据（用于GC）;</p>
</li>
<li><p>JNI调用，也就是Native Stack；</p>
</li>
<li><p>JIT（即使编译器）编译时使用Native Memory，并且JIT的输入（Java字节码）和输出（可执行代码）也都是保存在Native Memory；</p>
</li>
<li><p>NIO direct buffer；</p>
</li>
<li><p>Threads；</p>
</li>
<li><p>类加载器和类信息都是保存在Native Memory中的。</p>
</li>
</ul>
<h3 id="第二个问题的答案"><a href="#第二个问题的答案" class="headerlink" title="第二个问题的答案"></a>第二个问题的答案</h3><p><strong>一个Java进程，能不能申请比物理内存更大的堆空间？如果能，他实际占用的物理内存是多大？</strong></p>
<p>那是自然可以的咯，申请大了没关系，大不了内存换页啊。到底占据多大的物理内存空间，这得看<code>JVM</code>到底是怎么初始化堆的，实际上还真有不同的初始化方式：</p>
<ul>
<li><p>在默认情况下，<code>JVM</code>也只是建立了一个有关于java堆的数据结构，java堆的那一块内存并不会去初始化。意思是，对于操作系统来说，<code>JVM</code>这个进程并没有<strong>实际使用</strong>那些内存，因此操作系统也不会给这部分内存真的分配物理地址。于是，实际上这个<code>JVM</code>耗费的物理内存只有一点点，就是<code>JVM</code>本身用到的一些内存，以及java代码使用的那些内存，这两个部分。</p>
<p>这种方式在大部分情况下是很好的，因为毕竟不是所有人都会主动去设置java堆的大小，而是依赖于java的默认设置（堆最小是1/64物理内存，最大1/4物理内存），而且即使设置了java堆的大小，也未必真的会用那么多。如果每个JVM启动时都把java堆内存的部分初始化一下，占用物理内存，何止是没必要，简直就是浪费，甚至可能导致操作系统内存吃紧发生问题，此外，初始化那么大一块内存，也很费时间。</p>
<p>但也有一些不好，考虑一个用java实现的数据库或搜索类服务器，比如说ES，这样的一个服务肯定是你给我多少内存，我恨不得都吃掉，至少可以做缓存啊对不对，最好是启动时我就占很大一块，启动速度可以慢一点，启动后运行速度一定是越快越好。而这样的一些服务一般也是独立部署在服务器上，整台服务器资源基本上都是给他用的，也不太需要顾及其他进程的感受。那这时候，在启动时直接让<code>jvm</code>初始化java堆，这样就能避免在运行时触发缺页异常，保证启动后的速度。</p>
</li>
<li><p>于是，<code>JVM</code>实际上有个参数做这个事情，<code>-XX:+AlwaysPreTouch</code>，将会在java堆空间中写满0，这样就可以实现初始化的目的了。避免在实际使用到堆空间时再触发缺页异常，影响运行时的效率。</p>
</li>
</ul>
<p>能申请比物理内存更大的堆空间，不代表这么做是对的。一般的进程里，即使用到了比物理内存更大的内存，但其热点内存区域仍然只有一小部分，也就是说，至少频繁用到的内存页仍然可以只有一小部分，因此可以长期装载在物理内存中，不会频繁引起缺页异常导致数据在物理内存和swap之间换入换出，所以运行效率还尚可。但是<code>JVM</code>由于内存回收机制的存在，在<code>gc</code>过程中，需要扫描很大一块内存，假如堆内存大于物理内存，将会导致疯狂换页，这效率一般就低到尘埃里面去了，甚至会拖垮整个服务，所以，我们尽量不要设置大于物理内存的堆内存，而且还要考虑到内存中还有部分是给内核空间用的、给其他关键进程比如<code>sshd</code>用的，因此一般应该使用比物理空间小一些的堆内存空间。</p>
<h3 id="第三个问题的答案"><a href="#第三个问题的答案" class="headerlink" title="第三个问题的答案"></a>第三个问题的答案</h3><p><strong>Java有OOM错误，操作系统也有OOM错误，这两者之间有什么关系？两者在导致进程死亡上到底有哪些不同？</strong></p>
<p>Java的OOM错误，是因为java堆空间已经满了，而且经过了GC仍不足以分配内存空间，这时候<code>JVM</code>会抛出一个<code>OutOfMemoryError</code>，这个错误属于java异常体系的一部分，继承自<code>Throwable</code>，可以用如下方式被捕获：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oomMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// do some stupid thing to cause OOM</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e)&#123;</span><br><span class="line">      	<span class="comment">// do something to recover, but you really need a good reason to catch </span></span><br><span class="line">      	<span class="comment">// an OOM error.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring Boot在引入web依赖时，就会帮我们catch这个Error，从而我们的服务可以发生OOM，打出异常栈之后，该服务还能继续接受和处理其他请求。</p>
<p>但操作系统的OOM，是因为所有运行在该操作系统下的进程所<strong>实际使用</strong>的内存，超出了物理内存和交换空间之和，此时操作系统会根据一些参数计算出一个score，然后把score最大的一个或几个进程直接杀掉，一般就是占用内存最大的那个，（也就是我们的主服务了），这个过程可以人为干预，但仍然有一定的随机性。</p>
<p>所以，java的OOM是自己检测到无法运行进程了需要退出，是个主动的行为，因此也可以catch后中止这个退出行为；而操作系统的OOM杀进程对于JVM来说，是一个被动的行为，一旦被操作系统选中，作为一个普通进程的jvm将没有任何办法，只能被干掉。</p>
<p>举一个现实中可能会遇到的情况，我们的线上服务在发生OOM时，有时候会在日志中打出一个OOM的异常栈，然后服务还是启动状态，仍然能接受下一次请求；而在有些情况下，k8s的container会直接重启，查看重启原因会发现是<code>OOM Killed</code>，这就是操作系统的<code>OOM</code>杀了，而因为我们的容器里实际上只运行了<code>JVM</code>，其他进程并不占内存，所以我们可以大胆猜测，是运行时的<code>JVM</code>申请了太多的本地内存，最终导致实际使用的内存超过了物理内存和交换空间之和导致OOM杀，那本地内存在<code>JVM</code>中到底怎么申请的呢？一般会大量使用本地内存、而且在运行前不好估计使用量的，就是NIO框架，以及Spring大量使用的反射机制，所以，调低堆大小，给本地内存留出更大的空间，理论上可以解决这个问题。</p>
<h2 id="终章：与Docker的战斗"><a href="#终章：与Docker的战斗" class="headerlink" title="终章：与Docker的战斗"></a>终章：与Docker的战斗</h2><h3 id="docker中的进程，也只是一个进程"><a href="#docker中的进程，也只是一个进程" class="headerlink" title="docker中的进程，也只是一个进程"></a>docker中的进程，也只是一个进程</h3><p>想直观地观察到上面的结论，没法用windows或者mac下的docker desktop来观察，因为docker只能运行在linux内核上，所以windows或者mac下docker desktop本质上是个虚拟机。实际上可以理解为，在windows和mac下运行了一个虚拟机，又在虚拟机中运行着docker，因为多了这层虚拟机，所以会干扰我们理解问题。于是我首先在mac上安装一个centOS 7.2的虚拟机，然后在虚拟机上安装docker，在虚拟机上观察。过程不赘。</p>
<p>我们在虚拟机中运行一个mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql:5.7</span></span><br><span class="line">4a679a362f02fe513bc66b10f1308e42ba99500f1a12ff18587c8eb1435baae0</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker ps</span></span><br><span class="line">CONTAINER ID    IMAGE        COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">4a679a362f02    mysql:5.7    "docker-entrypoint.s…"   5 seconds ago       Up 4 seconds        0.0.0.0:3306-&gt;3306/tcp, 33060/tcp   awesome_hugle</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker top 4a679a362f02</span></span><br><span class="line">UID       PID     PPID     C  STIME   TTY    TIME        CMD</span><br><span class="line">polkitd   12230   12213    0  11:55   ?      00:00:00    mysqld</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ ps aux | grep 12230		<span class="comment"># 第一行是我专门粘贴出来的</span></span></span><br><span class="line">USER     PID    %CPU %MEM    VSZ   RSS   TTY    STAT   START   TIME  COMMAND</span><br><span class="line">polkitd  12230  0.3 10.3 1136228 193620  ?      Ssl    11:55   0:00  mysqld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面是解释为什么USER是这么诡异的一个值</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参考https://blog.dbi-services.com/how-uid-mapping-works-in-docker-containers/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker <span class="built_in">exec</span> -it 4a679a362f02 id mysql</span></span><br><span class="line">uid=999(mysql) gid=999(mysql) groups=999(mysql)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ id 999</span></span><br><span class="line">uid=999(polkitd) gid=998(polkitd) 组=998(polkitd)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可见容器里uid为999的用户是mysql，对应着容器外的polkitd，哈哈，虽然知道</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个冷知识看起来没有多大用，但是有疑惑还是顺手查一查比较安心</span></span><br></pre></td></tr></table></figure>
<p>所以，我们可以看到，运行在容器中的mysql对于操作系统来说也是一个进程而已。（在mac下观察不到这个进程，是因为mac的docker还运行了一层虚拟机）</p>
<h3 id="真的没有特别之处吗？"><a href="#真的没有特别之处吗？" class="headerlink" title="真的没有特别之处吗？"></a>真的没有特别之处吗？</h3><p>从理论上讲是有一些。docker通过linux的nameSpace技术实现了容器之间的资源隔离，并且使用linux的Cgroup技术，限制了容器中的进程所能使用的硬件资源。所以对于每一个运行在容器中的进程来说，他只能看到容器允许他看到的文件系统、使用容器为他单独维护的网络环境，这是一个完整的、完全独立于宿主机和其他容器的文件系统、网络环境，并且，最多只能使用Cgroup限制的硬件资源，包括CPU资源和内存资源。</p>
<p>因为我们在这里讨论的是硬件资源的限制，所以我们主要来了解一下CGroups。这篇文章讲得非常透彻：<a href="https://www.infoq.cn/article/docker-kernel-knowledge-cgroups-resource-isolation" target="_blank" rel="noopener">Docker 背后的内核知识——cgroups 资源限制</a>，这篇文章我也没看完，但已经足够解答我们之前提到的问题了。在这里补充一点，查看当前容器的<code>Cgroup</code>限制，可以去以下目录看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 20m ubuntu ls /sys/fs/cgroup/memory/</span></span><br><span class="line">cgroup.clone_children		    memory.memsw.failcnt</span><br><span class="line">cgroup.event_control		    memory.memsw.limit_in_bytes</span><br><span class="line">cgroup.procs			    memory.memsw.max_usage_in_bytes</span><br><span class="line">memory.failcnt			    memory.memsw.usage_in_bytes</span><br><span class="line">memory.force_empty		    memory.move_charge_at_immigrate</span><br><span class="line">memory.kmem.failcnt		    memory.numa_stat</span><br><span class="line">memory.kmem.limit_in_bytes	    memory.oom_control</span><br><span class="line">memory.kmem.max_usage_in_bytes	    memory.pressure_level</span><br><span class="line">memory.kmem.slabinfo		    memory.soft_limit_in_bytes</span><br><span class="line">memory.kmem.tcp.failcnt		    memory.stat</span><br><span class="line">memory.kmem.tcp.limit_in_bytes	    memory.swappiness</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes  memory.usage_in_bytes</span><br><span class="line">memory.kmem.tcp.usage_in_bytes	    memory.use_hierarchy</span><br><span class="line">memory.kmem.usage_in_bytes	    notify_on_release</span><br><span class="line">memory.limit_in_bytes		    tasks</span><br><span class="line">memory.max_usage_in_bytes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里有好多熟悉的小伙伴啊</span></span><br></pre></td></tr></table></figure>
<h3 id="有关docker与JVM的几个问题"><a href="#有关docker与JVM的几个问题" class="headerlink" title="有关docker与JVM的几个问题"></a>有关docker与JVM的几个问题</h3><p><strong>每一个启动起来的container，在操作系统看来又是以什么形态存在的呢</strong></p>
<p>答案就是一个进程，但这个进程因为受到CGroup的限制，在申请硬件资源时会被操作系统内核直接限制。</p>
<p><strong>在docker中运行的JVM到底能使用多大的内存，能不能利用经典Linux内存模型中的换页机制</strong></p>
<p>能用多大的内存显然取决于CGroups的硬件资源限制。根据<a href="https://blog.csdn.net/candcplusplus/article/details/53728507" target="_blank" rel="noopener">Docker 运行时资源限制</a>中的介绍，限制容器所使用的硬件资源的参数分别如下：</p>
<ul>
<li><p>CPU</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --name "container1" -c 1024 image</span><br><span class="line">docker run --name "container2" -c 512 image</span><br></pre></td></tr></table></figure>
<p>参数值是一个整数类型，用于设置当前Docker容器使用cpu的权重值(默认为1024)。这是一个相对值，每个容器能够使用的cpu, 取决于它的cpu shares 占所有容器cpu share的比例: 例如:</p>
<p>CPU是个稍微特殊一点的资源，假如说CPU资源不紧张的情况下，那我们也没有理由限制容器使用的CPU的数量，所以上述限制只有在CPU紧张的情况下才会发挥作用，如果二者都需要内存，那么 container1 分配到两倍于 container2 的CPU资源。</p>
</li>
<li><p>内存</p>
<p>内存分为物理内存和swap空间，所以docker的限制也包含这两个方面，主要包含六个参数：</p>
<ul>
<li><p>第一个是<code>--memory</code>，可以简写为<code>-m</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 此时该容器可以使用的最大的内存值为20M, 默认的swap最大值是物理内存的两倍</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run -m 20M image</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 我们运行下面命令来验证这一点</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -m 20m ubuntu cat /sys/fs/cgroup/memory/memory.limit_in_bytes</span></span><br><span class="line">20971520</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -m 20m ubuntu cat /sys/fs/cgroup/memory/memory.memsw.limit_in_bytes</span></span><br><span class="line">41943040</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是有意思的是，容器中的进程并不一定能感知到容器对该进程的硬件资源限制，比如</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 20m ubuntu free</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        1877556      523812      414256        9128      939488     1186308</span><br><span class="line">Swap:       2064380       41728     2022652</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ~ docker run --rm -it -m 20m ubuntu top</span></span><br><span class="line">top - 07:01:57 up  2:51,  0 users,  load average: 0.02, 0.03, 0.05</span><br><span class="line">Tasks:   1 total,   1 running,   0 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span></span><br><span class="line">KiB Mem :  1877556 total,   416416 free,   521748 used,   939392 buff/cache</span><br><span class="line">KiB Swap:  2064380 total,  2022652 free,    41728 used.  1188244 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">    1 root      20   0   36616   1688   1272 R   0.0  0.1   0:00.04 top</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 无论是top还是free，都并不会去读取cgroup的限制。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其实JDK1.8_131之前也不会去读取CGroup的限制，导致其在计算默认堆大小时</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照物理机的内存上限去申请。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>--memory-swap=300M</code>，这是指物理内存和swap加起来，总共可以用300M，必须和<code>-m</code>搭配使用，不然没意义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 比如下面这个，实际就使用了200M的物理内存，和100M的swap空间</span><br><span class="line">docker run -m 200M --memory-swap=300M image</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>--memory-reservation=300M</code>，这是一个软性限制，所谓的软性限制，是指并不是强制容器在任何时候都不超过这个内存使用值，而是说允许容器短时间内使用的内存超过这个限制，但如果系统内存紧张，会收回分配给容器中进程的资源，强迫其回到软性限制的范围内。软性限制是对物理内存的限制，因此一般来说应该比<code>-m</code>指定的值要小，比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -m 500M --memory-reservation 200M image</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>--oom-kill-disable</code>，显然，因为docker的资源限制实际上还是使用操作系统内核的特性，所以OOM-killer也仍然由操作系统来进行，未设置这个参数时，当容器使用的内存达到了限制，操作系统内核就会杀掉这个进程，设置后，就不会杀掉这个进程。</p>
<p>那么假如现在容器中进程使用的资源已经达到了上限，又不允许操作系统杀掉这个进程，此时进程再申请内存怎么办？根据<a href="https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container/48618727" target="_blank" rel="noopener">What does –oom-kill-disable do for a Docker container?</a>的介绍，似乎内核会在该进程申请内存时阻塞，直到人为干预为止。</p>
<p>在未使用<code>-m</code>限制最大内存使用，又禁用了<code>oom-killer</code>的情况下，有可能该进程耗光操作系统内存，还杀不掉，导致内核随机杀掉其他进程，假如不小心杀掉了系统进程，系统就挂了。</p>
</li>
<li><p><code>--oom-score-adj</code>这也是操作系统的一个参数，我们在上面介绍过，是操作系统在检测到OOM时计算<code>badness</code>分数时用的一个参数，值越大越容易被杀死。</p>
</li>
<li><p><code>--memory-swappiness</code>这也是操作系统的一个参数。其实操作系统并不是只有当物理内存都耗尽的时候才启用swap空间，而是在物理内存使用到一定百分比时，就考虑启用swap空间了。将这个值设为0，意思是尽量使用物理内存，实在不行再用swap，设为100，意为积极使用swap，有机会就交换内存到swap中。</p>
</li>
<li><p><code>--kernel-memory</code>，核心内存，不能被交换到swap空间的内存，就是枪支占着物理内存。</p>
</li>
</ul>
<p>一般来说，常用的就是<code>-m</code>和<code>--memory-reservation</code>这两个参数了。那么回到问题本身：在docker中运行的JVM，最多能用到分配给改容器的物理内存和swap空间之和的内存，当然可以把内存交换出去，虽然这不是个好主意。</p>
</li>
</ul>
<p><strong>如果超出了docker的内存限制，JVM到底被谁杀死？</strong></p>
<p>操作系统啦，哈哈。到这里这个问题的答案简直就是呼之欲出。</p>
<p><strong>再来看最后那一段超长的问题假设：</strong></p>
<p>在一个物理内存为16G的机器上，启动了一个内存限制为2G的docker，JVM的堆大小能不能设置成3G？假如能，是不是真的能申请到3G内存？假如不能，这个docker里运行的JVM最大能使用多大的堆？超出了会导致触发谁的OOM机制？</p>
<p>这里就可以看出我们最初的假设还不够完善，我们再完善一下：</p>
<p>在一个物理内存为16G的机器上，启动了一个<strong>物理内存和虚拟内存加起来</strong>限制为2G的docker，JVM的堆大小能不能设置成3G？假如能，是不是真的能申请到3G内存？假如不能，这个docker里运行的JVM最大能使用多大的堆？超出了会导致触发谁的OOM机制？</p>
<p>答案是：JVM的堆大小何止能设置成3G，简直可以设置成1T，只要你不开<code>+AlwaysPreTouch</code>，这些堆又不会真的被使用，连申请都不会申请，只是一个数字，完全可以设置地非常非常大。但是并不能真的申请到超出2G的堆空间，别说2G，考虑到本地内存的占用，1.6G估计就很极限了，真申请到该JVM使用的内存（包括本地内存和Java运行时使用的内存）超过了2G，就会被操作系统OOM杀了。</p>
<h2 id="尾声：Docker中的JVM"><a href="#尾声：Docker中的JVM" class="headerlink" title="尾声：Docker中的JVM"></a>尾声：Docker中的JVM</h2><p>在<code>JDK1.8_131</code>之前，<code>JVM</code>并不会去读取容器对其使用资源的限制，而直接根据硬件资源来计算默认堆空间大小，综上所述，这样设置当然是可以启动起来的，但是在运行时随着申请的内存越来越多，超过了容器的资源限制，就会被操作系统OOM杀，也就是我们在K8S中看到的<code>OOM KILLED</code>，对于这个问题可以使用Docker的<code>EntryPoint</code>在启动时加上堆最大值和最小值。</p>
<p><code>JDK1.8_131</code>时，JVM增加了两个参数用来控制这个行为，在这里我懒得找了，因为不怎么好用，至少在<code>JDK1.8_181</code>及以后，JVM提高了对容器的支持，这样就更好用了，但那几个参数我仍然没记住。具体可参见这么两个参考文章：</p>
<ol>
<li><a href="https://medium.com/adorsys/jvm-memory-settings-in-a-container-environment-64b0840e1d9e" target="_blank" rel="noopener">JVM Memory Settings in a Container Environment</a></li>
<li><a href="https://merikan.com/2019/04/jvm-in-a-container/" target="_blank" rel="noopener">JVM in a Container</a></li>
</ol>
<p>另外，通过上面的分析，我们可以得知，JVM虚拟机虽然能够使用交换内存，但是使用后很可能造成性能急剧下降，强烈不推荐这种用法。最好是合理设置小于物理内存的堆内存大小，并且令<code>memory-swappiness=0</code>，从而尽量要求操作系统不把JVM的内存交换到缓存空间中去。而本地内存中使用NIO造成的垃圾，虽然JVM也不是完全不管不顾，但是只有<code>FULL GC</code>时才能回收，而且实际上是调用了<code>System.gc()</code>，如果在虚拟机中参数中禁用了显式的gc，那么该部分内存就无法被回收，最终会触发操作系统的<code>OOM killer</code>，导致<code>JVM</code>进程被杀。</p>
<h2 id="参考及待研究"><a href="#参考及待研究" class="headerlink" title="参考及待研究"></a>参考及待研究</h2><ul>
<li><p>Linux内存管理</p>
<p><a href="https://blog.51cto.com/wutengfei/2163283" target="_blank" rel="noopener">Linux交换空间(swap space)</a></p>
<p><a href="http://www.hulkdev.com/posts/oom_killer" target="_blank" rel="noopener">OOM_Killer</a></p>
</li>
<li><p>JVM内存管理</p>
<p><a href="https://zhuanlan.zhihu.com/p/64737522" target="_blank" rel="noopener">JVM 与 Linux 的内存关系详解</a></p>
<p><a href="https://www.jianshu.com/p/11ae309ab078" target="_blank" rel="noopener">JVM:能不能在16G机器上设置17G的堆？</a></p>
</li>
<li><p>Docker</p>
<p><a href="https://www.infoq.cn/article/docker-kernel-knowledge-cgroups-resource-isolation" target="_blank" rel="noopener">Docker 背后的内核知识——cgroups 资源限制</a></p>
<p><a href="https://blog.csdn.net/candcplusplus/article/details/53728507" target="_blank" rel="noopener">Docker 运行时资源限制</a></p>
<p><a href="https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container/48618727" target="_blank" rel="noopener">What does –oom-kill-disable do for a Docker container?</a></p>
<p><a href="https://medium.com/adorsys/jvm-memory-settings-in-a-container-environment-64b0840e1d9e" target="_blank" rel="noopener">JVM Memory Settings in a Container Environment</a></p>
<p><a href="https://merikan.com/2019/04/jvm-in-a-container/" target="_blank" rel="noopener">JVM in a Container</a></p>
</li>
<li><p>JNI部分</p>
<p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jnileak/index.html" target="_blank" rel="noopener">在 JNI 编程中避免内存泄漏</a></p>
<p><a href="https://blog.csdn.net/pzysoft/article/details/79923121" target="_blank" rel="noopener">JNI内存管理</a></p>
</li>
</ul>
<p><strong>声明：</strong></p>
<p>本文仅用于自学以及几位好友的内部交流，请勿转发给工作相关人员。</p>
<p>如果承蒙错爱想发博客，注明一下作者即可。</p>
<p>不保证文章中任何部分的正确性。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/04/27/从进程的角度再探Java内存/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Java基Java基础整理之线程池" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/17/Java基Java基础整理之线程池/">Java基础整理之线程池</a>
    </h1>
  

        
        <a href="/2020/04/17/Java基Java基础整理之线程池/" class="archive-article-date">
  	<time datetime="2020-04-17T05:57:58.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="听说你熟悉线程池？"><a href="#听说你熟悉线程池？" class="headerlink" title="听说你熟悉线程池？"></a>听说你熟悉线程池？</h2><p>在Java的世界里，我们一遇到阻塞的问题，就会想着去创建线程。之所以这么做能够在某些情况下加快程序的运行，是基于这么几个事实。</p>
<ul>
<li>线程是CPU可以调度的最小任务单元。如果一个进程是单线程的，那么当他因为某种原因陷入阻塞时就会失去CPU的使用权。假如我们这台服务器就是给某个server用的，那它失去了使用权显然不是我们期待的行为。所以即使在单CPU的情况下，使用多线程模型也可以保证在其中一个线程因阻塞失去CPU使用权的时候，我们进程中还有其他任务可以得到CPU的调度。</li>
<li>现代服务器基本都是多处理器，或者多核心的，从概念模型上，就是有多个CPU可以用。如果我们坚持使用单线程，因为一个线程只能被一个CPU执行，那么其他CPU就浪费了，这也显然不是我们期望的行为。</li>
</ul>
<p>所以，在大部分情况下，使用多线程都会带来性能上的提升。</p>
<p>但是问题来了，是不是使用多线程一定会带来性能上的提升？</p>
<ul>
<li><p>场景一</p>
<p>一个单线程在单CPU上执行CPU密集型的任务，根本没有IO什么乱七八糟的阻塞，他就是占据CPU，一直在运算，这时候多开一个线程，能不能提高运行效率？</p>
</li>
<li><p>场景二</p>
<p>在4个可用CPU的场景下，一口气提交了1000个任务，我是不是开1000个线程就能达到最佳性能？</p>
</li>
</ul>
<p>答案都是否定的，我们来分析在启用和不启用多线程的情况下，CPU在处理任务的时候，到底干了哪些活儿，我们模拟一个08年的梦幻PC机，拥有牛叉的双核处理器。</p>
<ul>
<li><p>不启用多线程。</p>
<ul>
<li>提交了任务一。交由主线程，<code>CPU-1</code>拿到任务，开始处理。</li>
<li>提交了任务二。交给主线程，<code>CPU-1</code>的任务还没有处理完，此时CPU-2可用，但是因为<strong>线程是CPU可调度的最小任务单元</strong>，<code>CPU-2</code>无法和<code>CPU-1</code>同时处理一个线程的工作，因此任务二排队，<code>CPU-2</code>闲置。</li>
<li><code>CPU-1</code>完成了任务一的处理，继续处理任务二。</li>
</ul>
</li>
<li><p>启用了多线程，线程按需创建。</p>
<ul>
<li>提交了任务一。交由线程1，<code>CPU-1</code>拿到任务，开始处理。</li>
<li>提交了任务二。此时没有多余的线程可以处理任务，CPU-2创建了一个线程，他是线程2，任务2现在交个线程2处理，<code>CPU-2</code>单独调度线程2，此时<code>CPU-1</code>干任务1，<code>CPU-2</code>干任务2，很好。</li>
<li><p>提交了任务三，此时没有多余的线程可以处理任务，<code>CPU-1</code>和<code>CPU-2</code>都在忙，但是现代CPU都是时分复用的，于是<code>CPU-1</code>这时候暂时放下线程1中的任务1，为任务3创建了一个线程3，接下来，<code>CPU-1</code>和<code>CPU-2</code>在3个线程之间来回切换。</p>
</li>
<li><p>more task the same</p>
</li>
</ul>
</li>
<li><p>启用了多线程，但只允许最多有两个线程。</p>
<ul>
<li>提交了任务一。交由线程1，<code>CPU-1</code>拿到任务，开始处理。</li>
<li>提交了任务二。此时没有多余的线程可以处理任务，CPU-2创建了一个线程，他是线程2，任务2现在交个线程2处理，<code>CPU-2</code>单独调度线程2，此时<code>CPU-1</code>干任务1，<code>CPU-2</code>干任务2，很好。</li>
<li>提交了任务三。这时候不允许创建新的线程了，于是任务3没办法，只能在等待某一个线程的任务完成以后，再把自己放到线程里面去，得到某个CPU的调度。此时<code>CPU-1</code>干任务1，<code>CPU-2</code>干任务2。</li>
</ul>
</li>
</ul>
<p>所以我们发现，多线程其实为整个CPU增加了一些额外的工作，这主要包括</p>
<ul>
<li>创建线程的开销。这个开销其实很大，是重量级的系统调用，还要为线程开辟栈空间、初始化一些数据，等等。</li>
<li>任务切换的开销。这个开销也不小，CPU需要把寄存器里面的东西都替换出来（也就是任务上下文的保存），然后把之前保存的另外一个任务的上下文装载到寄存器里面，现代CPU本来内部还很复杂，流水线什么的基本上全部都破坏掉了，也非常消耗资源。</li>
</ul>
<p>可见，整体效率最高的办法其实是：有几个CPU，我们就开几个线程，然后任务排队，这样CPU始终在跑一个任务，永远不切换，跑完一个换下一个。这样算下来，完成N个任务的总体时间是最短的。</p>
<p>但这并不是最友好的解决方案，现实世界总有那么多额外限制，让我们不得不做出权衡。假设我们现在有个服务器，有10个人先后请求了，那么是不是最后一个请求的人就倒霉到必须等到前面所有请求都干完了才轮到我呢？假如前面的人是下载一个视频，而我只是发个文本消息，我还得等到他们干完才轮到我，是不是很不爽？所以实际上，除了确实在干CPU密集型的任务而且容许排队，不然适当开多个线程，让CPU切换处理，是一种权衡之下的更优解。</p>
<p>好吧，上面是一些人尽皆知的基础知识……希望没有浪费各位看官的时间。</p>
<p>做个简单的总结，我个人认为，使用线程的两大主要目的，一个是提高CPU的使用效率，一个是保持合理的客户请求响应速度。显然，如果我们的程序就是要做大量运算的，不提供客户服务，显然线程数量和CPU数量保持一致最好；如果想保证合理的客户响应速度，需要多开一些线程，但线程新建的内存和CPU消耗，以及线程切换时的消耗随着线程数量的增加而增加，总会到某个节点，线程新建和切换的消耗完全抵消了多线程可能带来的性能提升，CPU的时间被大量浪费在新建和切换线程，所有的响应都慢的受不了。</p>
<p>所以，在我们业务要求我们必须保持合理的响应时间的时候，我们（被迫）必须考虑这样的两个核心问题：</p>
<ol>
<li>能不能减少线程新建的开销？</li>
<li>能不能减少线程切换的开销，但却又能保证足够高的CPU利用率。</li>
</ol>
<p>问题一的答案是使用线程池，而问题二的答案是设置合理的线程数量。</p>
<p>我们来看一段我们代码里使用线程池的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">stupidGuy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ExecutorService executors = Executors.newFixedThreadPool(threadCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">        executors.execute(<span class="keyword">new</span> someRunnable());</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 我们并不关心这些任务什么时候能结束，所以直接返回了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看这段代码干了什么：</p>
<ol>
<li>新建了一个线程池，这个线程池因为是使用<code>Executors.newFixedThreadPool(threadCount)</code>建立出来的，因此会有threadNum个核心线程，threadNum个最大线程，不会主动回收线程资源，并且初始化线程数量为0。</li>
<li>现在我们在for循环里面开始向线程池提交任务，那么他会一直创建新的线程来接受任务，即使有空闲线程可用，也会创建新的线程。直到线程数量达到threadNum。</li>
<li>然后因为我们不关心这些任务什么时候结束，所以直接返回了。</li>
</ol>
<p>直接说答案，这是完全错误的用法，因为造成了内存泄露。</p>
<p><code>Executors.newFixedThreadPool(threadCount)</code>在没有调用<code>shutDown()</code>的情况下，即使已经没有引用指向他了，他也永远不会释放自己维护的线程池里面的线程资源，所以一定会造成内存泄露。</p>
<p>于是我们稍微修改这代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">stupidGuy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ExecutorService executors = Executors.newFixedThreadPool(threadCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">        executors.execute(<span class="keyword">new</span> someRunnable());</span><br><span class="line">    &#125;</span><br><span class="line">  	executors.shutdown();</span><br><span class="line">  	<span class="comment">// 如果我们希望所有任务完成后再继续，那么可以加上下面这段代码，但加不加对我们这里</span></span><br><span class="line">  	<span class="comment">// 想要考察的问题是没有影响的。</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executors.awaitTermination(<span class="number">1</span>,TimeUnit.DAYS)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">// 并没有人来打断这个线程，所以donothing</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>同上；</li>
<li>同上；</li>
<li>shutdown()之后，且线程池里面的所有线程都运行完了，且线程池的引用也离开了作用域，这时候相关线程资源会被释放，于是Thread对象本身、其代表的线程所申请的栈空间等等，都会被回收释放。不会内存泄露啦，是不是有点开心。（<code>Executors#创建其他线程池的方法</code>创建出来的线程池，不需要像<code>Executors.newFixedThreadPool(threadCount)</code>创建出来的线程池一样显式调用<code>shutdown()</code>也可以内存回收）</li>
</ol>
<p>等等，我们最开始说什么来着？创建线程池是为了干嘛？为了<strong>减少线程新建的开销</strong>，可是我们在这里干什么呢？每次调用这个方法，我都新建了个线程池，在第二步还新建了线程。</p>
<p><strong>那你说我建个线程池图啥呢？</strong></p>
<p>所以说：线程池不是这么用滴，实际上，<strong>一个线程池，基本应该是全局的。或者至少是类的静态变量</strong>。在方法里建局部线程池是错误的用法，因为完全没有解决线程池这个概念旨在解决的问题，甚至新增了一些维护线程池的负担。</p>
<p>然后我们看第二个问题，到底多少线程是合理的。</p>
<p>这个其实需要评估。使用线程池是为了更大限度提高CPU的利用率，那么实际上比较理想的模型是：当一个线程因为IO而阻塞时，总是有刚刚好有需要使用CPU的线程可供CPU调度，这需要根据业务进行量化评估。</p>
<p>比如说：我们一个线程中的工作，20%是CPU需要运算的，而80%则用来等待IO。那么我们可以把线程池中维护的线程的数量提高到CPU核心数量的4倍。这样则所有等待IO的时间，CPU都有实际的工作线程可以调度。为了维护服务对多个请求都有合理的响应时间，那么线程数量实际上还可以再多几个（30%-50%）。更多的线程未必能带来更好的效果。如果要更精细地调优，我感觉还得评估CPU上下文切换的开销到底有多大。这个太难了，不玩。</p>
<h2 id="不是总结的总结"><a href="#不是总结的总结" class="headerlink" title="不是总结的总结"></a>不是总结的总结</h2><p>坑到处都有，很多正常不过的操作细想也不是那么回事……线程池最好是全局或者至少是类静态变量，不然就丧失了使用线程池的意义，而线程数量也不是越多越好，而要根据实际的业务需求进行评估，一般可能需要经过反复的测试、评估，才能找到最合适的线程数量。</p>
<h3 id="聊胜于无的版权声明"><a href="#聊胜于无的版权声明" class="headerlink" title="聊胜于无的版权声明"></a>聊胜于无的版权声明</h3><p>仅用于几位好友的内部技术交流，请勿邮件转发给工作相关人员。</p>
<p>如果承蒙错爱想发博客，注明一下作者即可。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/04/17/Java基Java基础整理之线程池/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
<!-- <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2022 Haoz
    	</div>
      	<div class="footer-right">
      		<!-- <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten -->
      	</div>
    </div>
  </div>
<!-- <span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span> -->
</footer>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">all </a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends"> theirs </a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme"> me</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">随笔</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Git</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hive</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Sqoop</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Spring</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Mac</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">kafka</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Tomcat</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">oracle</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">nifi</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">clickhouse</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">SecureCRT</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">博客</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://jm.taobao.org/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>阿里中间件</a>
            </li>
          
            <li class="search-li">
              <a href="https://tech.meituan.com/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>美团技术团队</a>
            </li>
          
            <li class="search-li">
              <a href="https://yq.aliyun.com/teams/183?spm=a2c4e.11153940.0.0.47fa3c549Ci6bP" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>阿里大数据在线存储</a>
            </li>
          
            <li class="search-li">
              <a href="https://opsx.alibaba.com/?lang=zh-CN" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>阿里云开源软件站</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">i&#39;ve tried so hard&lt;br&gt;&lt;br&gt;and got so far&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;but in the end&lt;br&gt;&lt;br&gt;it doesn&#39;t even matter</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>